<!doctype html>
<html lang="ja">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="description" content="開発・実行環境をDockerで整える">
    <meta name="author" content="ota42y">

    <link rel="stylesheet" type="text/css" href="/css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="/css/base.css">
    <link rel="stylesheet" type="text/css" href="/css/page.css">
    <link rel="stylesheet" type="text/css" href="/css/list.css">

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
    <script>
        hljs.configure({tabReplace: '    '}); 
        hljs.initHighlightingOnLoad();
    </script>

    
    <title>開発・実行環境をDockerで整える | おおたの物置</title>
    
</head>


<body>

<header>
    <div class="navbar navbar-default">
        <div class="container">
          <div class="navbar-header">
              <a href="/" class="navbar-brand">おおたの物置</a>
              <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#navbar-main">
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
              </button>
          </div>

            <div class="navbar-collapse collapse" id="navbar-main">
                <ul class="nav navbar-nav">
                    <li
                      
                      ><a href="/">Top</a></li>

                    <li
                      
                      
                      
                      class="active"
                      

                      

                      ><a href="/blog/">Blog</a></li>
                    <li
                      

                      
                      ><a href="/tags/">Tags</a></li>

                    <li
                      

                      
                      ><a href="/pages/">Pages</a></li>
                </ul>
                <p class="navbar-text navbar-right"><a class="navbar-link" href="">rss</a></p>

                
                <p class="navbar-text navbar-right"><a class="navbar-link" href="https://github.com/ota42y">github</a></p>
                

                
                <p class="navbar-text navbar-right"><a class="navbar-link" href="https://twitter.com/ota42y">twitter</a></p>
                
            </div>
        </div>
    </div>
</header>



<div class="container">
    <div class="row">
        <div class="col-lg-12">
            <div class="page-header">
              <h1 class="article_title"><a href="/blog/2016/02/25/docker_develop/">開発・実行環境をDockerで整える</a></h1>
              <p class="post_detail">
    
    <time datetime="2016-02-25" class="post_data">
    2016-02-25
    </time>
    

    
    <span class="separator">|</span>
    <span class="post_data">tags: [</span>

    
    <span class="post_data">
        <a href="/tags/tech">tech</a>
    </span>
    
    <span class="post_data">
        <a href="/tags/docker">Docker</a>
    </span>
    

    <span class="post_data">]</span>
    
</p>

            </div>

            
            <div id="toc">
                <div id="toc_body">
                    <div id="toc_index">目次</div>
                    <nav id="TableOfContents">
<ul>
<li><a href="#概要:b4435baf1accd1f59ab486a39b64af8d">概要</a></li>
<li><a href="#開発環境構築が辛い:b4435baf1accd1f59ab486a39b64af8d">開発環境構築が辛い</a>
<ul>
<li><a href="#設定自動化スクリプトでは足りない:b4435baf1accd1f59ab486a39b64af8d">設定自動化スクリプトでは足りない</a></li>
<li><a href="#開発環境にdockerを使う:b4435baf1accd1f59ab486a39b64af8d">開発環境にDockerを使う</a></li>
</ul></li>
<li><a href="#dockerで開発環境を整える:b4435baf1accd1f59ab486a39b64af8d">Dockerで開発環境を整える</a>
<ul>
<li><a href="#dockerコンテナの作成:b4435baf1accd1f59ab486a39b64af8d">Dockerコンテナの作成</a></li>
<li><a href="#データの永続化:b4435baf1accd1f59ab486a39b64af8d">データの永続化</a></li>
</ul></li>
<li><a href="#dockerを開発環境にする上での問題点:b4435baf1accd1f59ab486a39b64af8d">Dockerを開発環境にする上での問題点</a>
<ul>
<li><a href="#環境の使い分けの煩雑さ:b4435baf1accd1f59ab486a39b64af8d">環境の使い分けの煩雑さ</a></li>
<li><a href="#実行速度の問題:b4435baf1accd1f59ab486a39b64af8d">実行速度の問題</a></li>
</ul></li>
<li><a href="#まとめ:b4435baf1accd1f59ab486a39b64af8d">まとめ</a></li>
</ul>
</nav>
                </div>
            </div>
            

            <div class="article">
              

<h1 id="概要:b4435baf1accd1f59ab486a39b64af8d">概要</h1>

<p>開発環境構築はだいたい辛い作業ですが、Dockerを使うことで構築がとても楽になります。もちろん銀の弾丸ではないので別のつらさは存在します。
しかし一歩も進まずに時間だけが過ぎることはなくなるため精神衛生上良く、開発を始める段階においてはとても効果的です。</p>

<h1 id="開発環境構築が辛い:b4435baf1accd1f59ab486a39b64af8d">開発環境構築が辛い</h1>

<p>開発環境構築はプログラミングをする上で必須の作業ですが、依存関係など非常に多くの落とし穴があることが多いです。
また、環境構築そのものが目的ということは少なく、その先に別にやりたい事が控えていることが多いと思います。
そのため、とりあえずやってみようと思った際に、その試してみるべき部分にたどり着けずに時間を浪費していくのはかなり辛いです…</p>

<h2 id="設定自動化スクリプトでは足りない:b4435baf1accd1f59ab486a39b64af8d">設定自動化スクリプトでは足りない</h2>

<p>環境構築の手順が煩雑な問題に対しては、chefやAnsible等、自動で環境を構築する方法はいくつかあります。
これらは一度作れば同じ環境を何度でも作ることが出来ますが、2回目以降を楽にするものであるため初回はそれほど楽になりません。
また、すでに入っているものとの依存関係の問題などはこれらのツールでは解決しないため、
複雑な環境になればなるほど環境構築の難易度は上がります。</p>

<h2 id="開発環境にdockerを使う:b4435baf1accd1f59ab486a39b64af8d">開発環境にDockerを使う</h2>

<p>このような問題に対応するために、Dockerを開発環境として使うことを考えます。
Dockerでは毎回クリーンな環境から必要な分だけインストールするため、
依存関係地獄にはまりにくいです。
さらに、Dockerfileで構築手順を保存できるため、
複数のマシンで同じ環境を揃えるのが簡単で、かつ不要になったらコンテナを消すことで容量の削減にもなります。</p>

<p>また、Dockerfileを本番環境に持って行き、そのままデプロイすることも可能です。
そのため、本番でだけバグが起きる…といったことも回避出来ます。</p>

<h1 id="dockerで開発環境を整える:b4435baf1accd1f59ab486a39b64af8d">Dockerで開発環境を整える</h1>

<p>細かい部分はDocker入門を読むのが早いと思います。
そのため、割とさくっとしか説明しません。</p>

<h2 id="dockerコンテナの作成:b4435baf1accd1f59ab486a39b64af8d">Dockerコンテナの作成</h2>

<p>Dockerコンテナを構築するのに便利なDockerfileは、
ベースとなるコンテナをもとに、指定されたコマンドを実行してコンテナを作ってくれます。
例えば、以下のDockerfileはffmpegがインストール済みのコンテナに対して、
<a href="https://nico-opendata.jp/ja/index.html">ニコニコ静画を使ったChainer用の学習済みモデルファイル</a>を利用出来る環境を整えています。
ffmpeg自体はベースのコンテナに入っているため、その後にpythonの実行環境を入れ、様々なライブラリを入れているだけです。
コンテナの作成はこのDockerfileが置いてあるディレクトリまで移動し、
<code>docker build -t ffmpeg_test .</code>
で作れます。</p>

<pre><code>FROM cellofellow/ffmpeg:latest

RUN apt-get -y update &amp;&amp; apt-get -y upgrade
RUN apt-get install -y ccache curl g++ gfortran git libhdf5-dev
RUN apt-get install -y python-pip python-dev

RUN pip install numpy==1.10.2

# scipy
RUN apt-get install -y libblas-dev liblapack-dev libatlas-base-dev gfortran
RUN pip install scipy
RUN pip install Pillow
RUN pip install scikit-image
RUN pip install chainer==1.3

# niconico dataset
RUN pip install git+http://github.com/nico-opendata/niconico_chainer_models.git#egg=niconico_chainer_models

CMD [&quot;/bin/bash -c&quot;]
</code></pre>

<h2 id="データの永続化:b4435baf1accd1f59ab486a39b64af8d">データの永続化</h2>

<p>Dockerfileに変更を加えるとコンテナが新たに作成されるため、データを入れても気がつくと消えてしまいます。
もちろんそれでは使い物にならないので、永続化の手法はいくつか考えられているようです。
開発環境として使う分には、手元のマシンの特定フォルダをDockerマシン上にマウントできるData Volumeを利用するのが良いと思います。</p>

<p>以下のようにコンテナを実行することで、手元のマシンの~/docker_volume/ffmpeg/を、Dockerマシン上の/tmp/hostにマウントすることが出来ます。<br />
<code>docker run -v ~/docker_volume/ffmpeg/:/tmp/host --name ffmpeg -i -t ffmpeg_test /bin/bash</code></p>

<p>マウントしているだけなので変更もリアルタイムに反映されるため、作業用フォルダをマウントするとスムーズに開発出来ると思います。</p>

<h1 id="dockerを開発環境にする上での問題点:b4435baf1accd1f59ab486a39b64af8d">Dockerを開発環境にする上での問題点</h1>

<p>環境構築は物凄く楽になりましたが、すべてが良いわけではなく、
いくつか問題点があります。</p>

<h2 id="環境の使い分けの煩雑さ:b4435baf1accd1f59ab486a39b64af8d">環境の使い分けの煩雑さ</h2>

<p>Dockerは実行にだけ利用し、開発は手元のホストマシンで行う場合、
ホストとコンテナとの違いを意識しないといけないため、煩雑さがだいぶ上がります。
ファイルに保存する場合に保存場所を意識しないといけなかったり、gitにコミットしようとしたらコンテナ上だったりと、コンソール作業のたびに今いる環境を確認するのは結構面倒です。</p>

<p>もちろん、自動実行が整っててコンテナ側をいじる必要が無かったり、
開発もコンテナ内でやるような場合は当てはまりません</p>

<h2 id="実行速度の問題:b4435baf1accd1f59ab486a39b64af8d">実行速度の問題</h2>

<p>MacだとVirtualBoxのVM上でコンテナが動いているため、実質的に専用のVMを立ち上げているのと変わりません。
そのため、実行速度が遅くなるという問題があります。
実際、私のMacBook Pro上記の環境で画像分類を行うと、ホストのMacで実行すると1秒以内に終わる処理が、コンテナ上だと100秒ぐらいかかってしまいます。
おそらくWindowsも同じ仕組みのはずなので、同じような結果になりそうです。
画像処理など特に重い処理等の場合はとても時間がかかってしまうため、環境構築とは別方面のつらさが出てきます。</p>

<p>これにたいしては、とりあえず動かしたい初期段階ではDockerを使い、環境が固定化してきた段階で手元のマシンで開発するようにすると、
開発初期のとりあえず使ってみたい状態は楽に環境を整えられ、確定した段階でローカルでの開発に移行することで、速度的な部分も問題にならなくなります。</p>

<p>もしかしたら、サーバ上のコンテナにローカルのファイルをマウントするといったことが可能かもしれないので、
この辺はもう少し調査が必要です…</p>

<p>なお、何故遅いのかの原因まではつかめていません。
VMのオーバーヘッドなのかもしれませんし、<a href="http://qiita.com/masuidrive/items/d71ee1881fffb6ad098f">VirtualBoxボリュームによるせい</a>の可能性もあります。
ここをもう少し調べれば回避策はあるかもしれません。</p>

<h1 id="まとめ:b4435baf1accd1f59ab486a39b64af8d">まとめ</h1>

<ul>
<li>開発環境構築は毎回辛い

<ul>
<li>依存関係</li>
<li>複数台で開発すると何回もセットアップする羽目に</li>
</ul></li>
<li>環境構築自動化

<ul>
<li>構築用スクリプトでは解決しない

<ul>
<li>スタート地点がそれぞれ違う</li>
</ul></li>
</ul></li>
<li>Dockerで環境ごと作る

<ul>
<li>毎回クリーンな環境から構築

<ul>
<li>依存関係に悩まされにくい

<ul>
<li>一度成功すれば後は固定</li>
</ul></li>
</ul></li>
<li>別ベクトルで辛いところはある

<ul>
<li>作業してるところを意識しないといけない</li>
<li>環境によっては遅い</li>
</ul></li>
<li>一歩も進まずに四苦八苦するよりも精神衛生上良い

<ul>
<li>心が折れない</li>
<li>問題点がはっきりとして解決しやすい</li>
<li>開発初期はDocker、本格的に行けそうなら直接入れるように使い分け</li>
</ul></li>
</ul></li>
</ul>

            </div>
        </div>
    </div>

    

<div class="social_buttons">
    
    <span class="twitter">
        <a href="https://twitter.com/share" class="twitter-share-button" data-via="ota42y">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
    </span>
    

    
    <span class="hatena">
        <a href="http://ota42y.com/blog/2016/02/25/docker_develop/" class="hatena-bookmark-button"
           data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="ja"
           title="このエントリーをはてなブックマークに追加">
            <img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png"
                 alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" />
        </a>
        <script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js"
                charset="utf-8" async="async">
        </script>
    </span>
    
</div>

</div>

<footer class="small">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 text-center copyright">
                Copyright © 2015 - ota42y powerd by <a href="https://github.com/ota42y/honokichi">Honokichi</a>
            </div>
        </div>
    </div>
</footer>


<script src="./js/jquery.min.js"></script>
<script src="./js/bootstrap.min.js"></script>

</body>
</html>

