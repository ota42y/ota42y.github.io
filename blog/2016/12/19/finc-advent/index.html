<!doctype html>
<html lang="ja">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="description" content="committee &#43; prmds でJSON Schemaをいい感じに運用する">
    <meta name="author" content="ota42y">

    <link rel="stylesheet" type="text/css" href="/css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="/css/base.css">
    <link rel="stylesheet" type="text/css" href="/css/page.css">
    <link rel="stylesheet" type="text/css" href="/css/list.css">

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
    <script>
        hljs.configure({tabReplace: '    '}); 
        hljs.initHighlightingOnLoad();
    </script>

    
    <title>committee &#43; prmds でJSON Schemaをいい感じに運用する | おおたの物置</title>
    
</head>


<body>

<header>
    <div class="navbar navbar-default">
        <div class="container">
          <div class="navbar-header">
              <a href="/" class="navbar-brand">おおたの物置</a>
              <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#navbar-main">
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
              </button>
          </div>

            <div class="navbar-collapse collapse" id="navbar-main">
                <ul class="nav navbar-nav">
                    <li
                      
                      ><a href="/">Top</a></li>

                    <li
                      
                      
                      
                      class="active"
                      

                      

                      ><a href="/blog/">Blog</a></li>
                    <li
                      

                      
                      ><a href="/tags/">Tags</a></li>

                    <li
                      

                      
                      ><a href="/pages/">Pages</a></li>
                </ul>
                <p class="navbar-text navbar-right"><a class="navbar-link" href="">rss</a></p>

                
                <p class="navbar-text navbar-right"><a class="navbar-link" href="https://github.com/ota42y">github</a></p>
                

                
                <p class="navbar-text navbar-right"><a class="navbar-link" href="https://twitter.com/ota42y">twitter</a></p>
                
            </div>
        </div>
    </div>
</header>



<div class="container">
    <div class="row">
        <div class="col-lg-12">
            <div class="page-header">
              <h1 class="article_title"><a href="/blog/2016/12/19/finc-advent/">committee &#43; prmds でJSON Schemaをいい感じに運用する</a></h1>
              <p class="post_detail">
    
    <time datetime="2016-12-19" class="post_data">
    2016-12-19
    </time>
    

    
    <span class="separator">|</span>
    <span class="post_data">tags: [</span>

    
    <span class="post_data">
        <a href="/tags/ruby">ruby</a>
    </span>
    

    <span class="post_data">]</span>
    
</p>

            </div>

            
            <div id="toc">
                <div id="toc_body">
                    <div id="toc_index">目次</div>
                    <nav id="TableOfContents">
<ul>
<li><a href="#要約:9a41655829cae90fa2773a6244b1f941">要約</a></li>
<li><a href="#api作成時のリクエスト-レスポンス形式問題:9a41655829cae90fa2773a6244b1f941">API作成時のリクエスト・レスポンス形式問題</a></li>
<li><a href="#json-schemaで仕様を定義する:9a41655829cae90fa2773a6244b1f941">JSON Schemaで仕様を定義する</a></li>
<li><a href="#committee:9a41655829cae90fa2773a6244b1f941">committee</a></li>
<li><a href="#json-schema-committeeの利点と問題点:9a41655829cae90fa2773a6244b1f941">JSON Schema+committeeの利点と問題点</a></li>
<li><a href="#prmd:9a41655829cae90fa2773a6244b1f941">prmd</a></li>
<li><a href="#実際の開発手順:9a41655829cae90fa2773a6244b1f941">実際の開発手順</a></li>
<li><a href="#まとめ:9a41655829cae90fa2773a6244b1f941">まとめ</a>
<ul>
<li><a href="#解決すること:9a41655829cae90fa2773a6244b1f941">解決すること</a></li>
<li><a href="#解決しないこと:9a41655829cae90fa2773a6244b1f941">解決しないこと</a></li>
<li><a href="#未解決問題:9a41655829cae90fa2773a6244b1f941">未解決問題</a></li>
</ul></li>
<li><a href="#最後に:9a41655829cae90fa2773a6244b1f941">最後に</a></li>
</ul>
</nav>
                </div>
            </div>
            

            <div class="article">
              

<h1 id="要約:9a41655829cae90fa2773a6244b1f941">要約</h1>

<ul>
<li>リクエスト・レスポンス形式のドキュメントはメンテが大変</li>
<li>メンテされていなくても気がつかないため放置され気味</li>
<li><a href="https://github.com/interagent/committee">committee</a>でJSON Schemaに実装が沿っているかを確認可能</li>
<li><a href="https://github.com/interagent/prmd">prmd</a>でJSON Schemaを楽に書ける＋人が読めるドキュメントが生成できる</li>
<li>メンテされていない事が検出できるので続く（はず</li>
</ul>

<h1 id="api作成時のリクエスト-レスポンス形式問題:9a41655829cae90fa2773a6244b1f941">API作成時のリクエスト・レスポンス形式問題</h1>

<p>サーバとクライアントで並行開発しながらAPIを作成する場合、以下のようにリクエスト・レスポンス形式を整えにくいという問題があります。</p>

<ul>
<li>リクエストの形式が想定と違う

<ul>
<li>想定外のキーを送ってくる</li>
<li>構造が想定していない構造</li>
</ul></li>
<li>レスポンスに知らないキーが含まれている</li>
<li>同じデータなのにエンドポイントによって形式が違う

<ul>
<li>enumの数値だったり、対応する文字列だったり</li>
<li>カテゴリ名を返していたりカテゴリIDを返していたり</li>
</ul></li>
</ul>

<p>コミュニケーションや、APIに関するドキュメントをきちんとメンテしていれば回避可能な問題ですが、<br />
以下の2つを保証する必要があり、何のサポートなしに維持するのはとても大変です。</p>

<ul>
<li>形式が全てドキュメント化されている</li>
<li>ドキュメントと実装が揃っている事を保証する</li>
<li>同じデータは同じ形式になる事を保証する</li>
</ul>

<p>そこで、今回話題にするJSON Schema+committee+prmdを導入することで、この問題を大幅に解決できます。</p>

<h1 id="json-schemaで仕様を定義する:9a41655829cae90fa2773a6244b1f941">JSON Schemaで仕様を定義する</h1>

<p>JSON SchemaとはJSONを用いてデータを記述する際の形式の1つで、主にアノテーションやバリデーションを目的としているものらしいです。<br />
詳しくはこちら<br />
<a href="http://json-schema.org/">http://json-schema.org/</a></p>

<p>例えば以下のように定義すると、<code>GET /v1/friends</code>が、access_tokenをパラメータとして必ず取り、戻り値には必ずfriendsとreccommendsというキーが含まれているという事を定義できます。
また、friendsとreccomendsの具体的な内容については別に定義して読み込みますが、同じ景色であるということも表現しています。
（なお、実際はもっと情報が多く、この部分だけでは動きません）</p>

<pre><code>{
  &quot;title&quot;: &quot;show self friends with recommends&quot;,
  &quot;href&quot;: &quot;/v1/friends&quot;,
  &quot;method&quot;: &quot;GET&quot;,
  &quot;schema&quot;: {
    &quot;type&quot;: &quot;object&quot;,
    &quot;required&quot;: [
      &quot;access_token&quot;
    ],
    &quot;properties&quot;: {
      &quot;access_token&quot;: {
        &quot;type&quot;: &quot;string&quot;
      }
    }
  },
  &quot;targetSchema&quot;: {
    &quot;type&quot;: &quot;object&quot;,
    &quot;required&quot;: [
      &quot;friends&quot;,
      &quot;recommends&quot;
    ],
    &quot;properties&quot;: {
      &quot;friends&quot;: {
        &quot;$ref&quot;: &quot;#/definitions/user/definitions/friends&quot;
      },
      &quot;recommends&quot;: {
        &quot;$ref&quot;: &quot;#/definitions/user/definitions/friends&quot;
      }
    }          
  }
}
</code></pre>

<p>JSON Schemaにそって定義を書くことで、形式が統一されプログラムから処理しやすくなるのと、他の場所の定義を共有できるため、<br />
同じデータなのに人によって違う構造になるような問題をを解決しやすくなります。</p>

<h1 id="committee:9a41655829cae90fa2773a6244b1f941">committee</h1>

<p>JSON Schema自体はただの形式なのでそれ自体は特に何も無いですが、統一された形式になるため、容易にプログラムから処理を行う事ができます。</p>

<p>rubygemの<a href="https://github.com/interagent/committee">committee</a>はその発想に沿ったものです。<br />
このgemはRackのミドルウェアとして動作し、JSON Schemaを読み込ませることで、<br />
リクエストやレスポンスが定義にそっているかをチェック、そっていない場合にエラーにするなどの処理を行います。<br />
また、テストにおいても形式が正しいかをチェックできます。</p>

<p>このgemにより、必須パラメーターが足りない場合や、違うデータが入っている場合にエラーを起こすことができ、<br />
JSON Schemaの形式と実際の形式とがそろっていることを保証できます。</p>

<p>さらに、JSON Schemaには形情報も書けることを利用し、数値でくるべきところが文字列だった場合にエラーを返すことや、<br />
日付フォーマットの文字列をdatetimeに変換、GETリクエストの時に文字列を数値に変換してくれたりと色々な便利機能があります。</p>

<h1 id="json-schema-committeeの利点と問題点:9a41655829cae90fa2773a6244b1f941">JSON Schema+committeeの利点と問題点</h1>

<p>JSON Schemaとcommitteeを利用することで、以下が可能になります。</p>

<ul>
<li>レスポンス・リクエスト形式を構造化できる</li>
<li>実装がJSON Schemaに沿っているか自動チェック&amp;変換できる</li>
</ul>

<p>これで、当初の問題だったドキュメントが実装と乖離していく問題は大幅に解決が可能ですが、代わりに以下の問題が出てきます。</p>

<ul>
<li>JSON Schemaを人間が書くのが大変</li>
<li>JSON Schemaを人間が読むのもつらい</li>
</ul>

<p>JSONは人間が直接読み書きするドキュメントには（たぶん）適さないです。<br />
そのため、たとえ利点があったとしてもJSON Schemaを作成するのがとても大変になってしまいます。</p>

<p>それを解決するのが<a href="https://github.com/interagent/prmd">prmd</a>です。</p>

<h1 id="prmd:9a41655829cae90fa2773a6244b1f941">prmd</h1>

<p><a href="https://github.com/interagent/prmd">prmd</a>はJSON SchemaをYAMLで定義することや、複数のファイルに分割して定義、<br />
JSON Schemaを元に人間が読めるmarkdownドキュメントを生成できるgemです。</p>

<p>prmdでは以下のようにYAMLを書くことで、先ほどのようなJSON Schemaを出力できます。</p>

<pre><code>- title: show self friends with recommends
  href: /v1/friends
  method: GET
  rel: show
  schema:
    type: object
    required:
      - access_token
    properties:
      access_token:
        type: string
  targetSchema:
    type: object
    required:
      - friends
      - recommends
    properties:
      friends:
        $ref: #/definitions/user/definitions/friends
      recommends:
        $ref: #/definitions/user/definitions/friends
</code></pre>

<p>また、マークダウンのドキュメントも以下のように出してくれます。</p>

<p><a href="/image
s/blog/2016/2016-12-19-prmd_document.png"><img src="/images/blog/2016/2016-12-19-prmd_document.png"  width="50%" /></a></p>

<p>これにより、JSON Schemaを人間が読み書きできるようになります。</p>

<h1 id="実際の開発手順:9a41655829cae90fa2773a6244b1f941">実際の開発手順</h1>

<p>以下のように進めると、JSON Schemaの利点を最大限活用できると思います。</p>

<ol>
<li>実装前にYAMLでレスポンス・リクエスト形式を定義</li>
<li>prmdでJSON Schemaとmarkdownを出力</li>
<li>markdownはクライアント側に事前共有</li>
<li>JSON Schemaの通りに動いているかテストしつつ開発</li>
</ol>

<p>という流れで、リクエスト・レスポンス形式に関係する部分は、かなりしっかりと開発を進めることができ、<br />
平行して開発を行っても手戻りやコミュニケーションロスを大幅に減らせます。</p>

<p>全体としては以下の図のように動いています。</p>

<p><a href="/image
s/blog/2016/2016-12-19-committee_prmd.png"><img src="/images/blog/2016/2016-12-19-committee_prmd.png"  width="50%" /></a></p>

<h1 id="まとめ:9a41655829cae90fa2773a6244b1f941">まとめ</h1>

<h2 id="解決すること:9a41655829cae90fa2773a6244b1f941">解決すること</h2>

<p>正しく導入することで以下の問題を解決できます。</p>

<ul>
<li>実装とドキュメントが乖離しないこと</li>
<li>データ構造を揃えること</li>
</ul>

<h2 id="解決しないこと:9a41655829cae90fa2773a6244b1f941">解決しないこと</h2>

<p>今回のはあくまでリクエスト・レスポンス形式に絞られているため、
以下の問題は解決しません。</p>

<ul>
<li>レスポンスのデータの内容が意図通りであること

<ul>
<li>形式はあっているが振る舞いが想定しているものかはチェックしません</li>
</ul></li>
<li>エラー形式の保証

<ul>
<li>レスポンス形式は一種類のみで、異常系は対象外です…</li>
</ul></li>
<li>リクエスト・レスポンス以外のドキュメント

<ul>
<li>仕様やデータの意味等は対象外です</li>
</ul></li>
</ul>

<h2 id="未解決問題:9a41655829cae90fa2773a6244b1f941">未解決問題</h2>

<p>以下のような問題が出ており、解決方法を模索中です。</p>

<ul>
<li>ドキュメントの読みやすさ</li>
<li>クライアント側へ配布するアクセス用ライブラリの生成</li>
<li>バージョニング対応</li>
</ul>

<h1 id="最後に:9a41655829cae90fa2773a6244b1f941">最後に</h1>

<p>JSON Schema+committee+prmdは全てを解決するものではありませんが、クライアント・サーバ間の形式という、認識の齟齬が起こりやすい境界の部分にはとても効果がある組み合わせでした。</p>

            </div>
        </div>
    </div>

    

<div class="social_buttons">
    
    <span class="twitter">
        <a href="https://twitter.com/share" class="twitter-share-button" data-via="ota42y">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
    </span>
    

    
    <span class="hatena">
        <a href="http://ota42y.com/blog/2016/12/19/finc-advent/" class="hatena-bookmark-button"
           data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="ja"
           title="このエントリーをはてなブックマークに追加">
            <img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png"
                 alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" />
        </a>
        <script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js"
                charset="utf-8" async="async">
        </script>
    </span>
    
</div>

</div>

<footer class="small">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 text-center copyright">
                Copyright © 2015 - ota42y powerd by <a href="https://github.com/ota42y/honokichi">Honokichi</a>
            </div>
        </div>
    </div>
</footer>


<script src="./js/jquery.min.js"></script>
<script src="./js/bootstrap.min.js"></script>

</body>
</html>

