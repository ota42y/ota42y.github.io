<!doctype html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="description" content="mocha&#43;chai&#43;sinsonでテストを書く為に必要な最低限の知識">
    <meta name="author" content="ota42y">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    
    <title>mocha&#43;chai&#43;sinsonでテストを書く為に必要な最低限の知識 | おおたの物置</title>
    

    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/list.css">
    <link rel="stylesheet" href="/css/single.css">
    <link rel="stylesheet" href="/css/index.css">
</head>


<body>

<div class="body">

    <div class="header_wrapper">
        <div class="content">
            <div class="header">
                <div class="header_left">
                    <a class="banner" href="/">おおたの物置</a>
                </div>
                <div class="header_right">
                    
                    <a href="https://twitter.com/ota42y">twitter</a>
                    

                    
                    <a href="https://github.com/ota42y">github</a>
                    
                    <a href="">RSS</a>
                </div>
            </div>
        </div>
    </div>

    <div class="content">
        <div class="main">

            <div class="article">

                <div class="post_title">
                    <h1>mocha&#43;chai&#43;sinsonでテストを書く為に必要な最低限の知識</h1>
                    

<time datetime="2014-08-22" class="post_data">
2014-08-22
</time>





<div class="separator">|</div>
<div class="post_data">
    Category: <a href="/categories/tech">tech</a>
</div>




<div class="tags">
    <div class="separator">|</div>

    <div class="post_data">tags: [</div>

    
    <div class="post_data">
        <a href="/tags/node">node</a>
    </div>
    
    <div class="post_data">
        <a href="/tags/js">js</a>
    </div>
    
    <div class="post_data">]</div>
</div>


                    <div class="clear"></div>
                </div>

                <div class="article_body">

                    
                    <div id="toc">
                        <div id="toc_body">
                            <div id="toc_index">目次</div>
                            <nav id="TableOfContents">
<ul>
<li><a href="#まとめ:3bae98bb6aa9abe8f0b8472a1492cace">まとめ</a></li>
<li><a href="#mochaの使い方:3bae98bb6aa9abe8f0b8472a1492cace">Mochaの使い方</a>
<ul>
<li><a href="#テストの書き方:3bae98bb6aa9abe8f0b8472a1492cace">テストの書き方</a></li>
<li><a href="#beforeの使い方:3bae98bb6aa9abe8f0b8472a1492cace">beforeの使い方</a></li>
<li><a href="#pendingテストの作り方:3bae98bb6aa9abe8f0b8472a1492cace">pendingテストの作り方</a></li>
<li><a href="#外部ファイル読み込み:3bae98bb6aa9abe8f0b8472a1492cace">外部ファイル読み込み</a></li>
<li><a href="#assertを使う:3bae98bb6aa9abe8f0b8472a1492cace">assertを使う</a></li>
</ul></li>
<li><a href="#sinonの使い方:3bae98bb6aa9abe8f0b8472a1492cace">sinonの使い方</a>
<ul>
<li><a href="#mockやstubを使う:3bae98bb6aa9abe8f0b8472a1492cace">mockやstubを使う</a></li>
<li><a href="#時間変更の仕方:3bae98bb6aa9abe8f0b8472a1492cace">時間変更の仕方</a></li>
<li><a href="#sinonのその他の機能:3bae98bb6aa9abe8f0b8472a1492cace">sinonのその他の機能</a></li>
</ul></li>
</ul>
</nav>
                        </div>
                    </div>
                    

                    

<h1 id="まとめ:3bae98bb6aa9abe8f0b8472a1492cace">まとめ</h1>

<ul>
<li>Mochaではrspecっぽい感じにテストが書ける</li>
<li>ただし、done()を呼ぶ必要がある等、細かい部分に差異がある</li>
<li>sinonにはいろいろ便利機能がある</li>
</ul>

<h1 id="mochaの使い方:3bae98bb6aa9abe8f0b8472a1492cace">Mochaの使い方</h1>

<p>coffeescriptを前提にしています。</p>

<h2 id="テストの書き方:3bae98bb6aa9abe8f0b8472a1492cace">テストの書き方</h2>

<p>Mochaのテストは以下のように、itにテスト内容を書いた関数を渡し、<br />
そのitを呼び出す関数をdescribeに渡すしようです。</p>

<pre><code class="language-coffeescript">describe &quot;test root&quot;, -&gt;
      it &quot;name&quot;, (done) -&gt;
        assert.equal getUserName, &quot;user&quot;
        done()
</code></pre>

<p>ただし、it関数では必ずdone()を呼び出す必要があります。<br />
これを呼ばない場合は終了を待ち続け、<br />
一定時間後にタイムアウトしてテストが失敗した扱いになります。</p>

<h2 id="beforeの使い方:3bae98bb6aa9abe8f0b8472a1492cace">beforeの使い方</h2>

<p>rspecのbeforeにあたるものは、beforeEachになります。<br />
 なお、変数を他のブロックに渡したい場合、<br />
 以下のようにdescribeの中に変数名を書いておいて、<br />
 beforeEachのなかで設定する必要があるみたいです。<br />
<a href="http://stackoverflow.com/questions/20584233/mocha-pass-variable-to-the-next-test">参考</a></p>

<pre><code class="language-coffeescript">describe &quot;test&quot;, -&gt;
  room_name = undefined


  beforeEach (done) -&gt;
    room_name = &quot;test_room&quot;

    done()

  describe &quot;functions&quot;, -&gt;
      it &quot;executeNoteShow&quot;, (done) -&gt;
        assert.equal getRoomName(room_name), room_name
        done()
</code></pre>

<h2 id="pendingテストの作り方:3bae98bb6aa9abe8f0b8472a1492cace">pendingテストの作り方</h2>

<p>テストの用意はしたけど、とりあえずpendingにしておきたい場合は二通りの方法があります。</p>

<pre><code class="language-coffeescript">  describe &quot;functions&quot;, -&gt;
      it &quot;pending test&quot; // 関数を渡さない場合


      // it.skipの場合、引数を渡しても実行されずにスキップする
      it.skip &quot;pending test 2&quot;, -&gt;
          done()
</code></pre>

<h2 id="外部ファイル読み込み:3bae98bb6aa9abe8f0b8472a1492cace">外部ファイル読み込み</h2>

<p>test.coffeeで</p>

<pre><code class="language-coffeescript">class Test
  なんかいろいろ
module.exports.Test = Test

</code></pre>

<p>と、クラスを宣言し、module.exportsに代入します。
その後、使いたいファイル側で</p>

<pre><code class="language-coffeescript">Test = require('../src/test.coffee').Test
</code></pre>

<p>と書くと、以降Testでそのクラスが呼び出せます。</p>

<p>#chaiの使い方</p>

<h2 id="assertを使う:3bae98bb6aa9abe8f0b8472a1492cace">assertを使う</h2>

<p>前述のテストではassertを使っていますが、Mochaにはassertは入っていないため、<br />
別ライブラリのchaiを読み込む必要があります。</p>

<pre><code class="language-coffeescript">global.assert = require(&quot;chai&quot;).assert
</code></pre>

<p>これで、 assert.equalや assert.notEqualが使えます。</p>

<h1 id="sinonの使い方:3bae98bb6aa9abe8f0b8472a1492cace">sinonの使い方</h1>

<h2 id="mockやstubを使う:3bae98bb6aa9abe8f0b8472a1492cace">mockやstubを使う</h2>

<p>Mochaにはmockやstubの為の物は含まれていないので、<br />
今度はsinonを読み込む必要があります。</p>

<pre><code class="language-coffeescript">global.sinon = require('simon')
</code></pre>

<p>使い方は以下の通りです</p>

<pre><code class="language-coffeescript">    // robot.brainがstubになる
    robot = new Object()
    robot.brain = sinon.stub()


    // hubot_note.executeNoteShowを置き換え、
    // hubot_note.executeMessage実行時に、
    // &quot;test&quot;, null, nullの引数で一回だけ実行されたかをチェックする

    spy = sinon.spy(hubot_note, &quot;executeNoteShow&quot;)
    spy.withArgs(&quot;test&quot;, null, null)
    response = hubot_note.executeMessage(room_name, &quot;hubot note show&quot;)
    assert.ok spy.withArgs(&quot;test&quot;, null, null).calledOnce

</code></pre>

<h2 id="時間変更の仕方:3bae98bb6aa9abe8f0b8472a1492cace">時間変更の仕方</h2>

<p><code>new Date()</code>などによって日付がちゃんと設定されたかどうかを確認したい場合、<br />
グローバルなDate()部分を置き換える必要があります。</p>

<p>…というのはよくあることなので、sinon側で既に用意されています。</p>

<pre><code class="language-coffeescript">@clock = sinon.useFakeTimers(0,
  &quot;setTimeout&quot;, &quot;clearTimeout&quot;,
  &quot;setInterval&quot;, &quot;clearInterval&quot;, &quot;Date&quot;)`
</code></pre>

<p>これで、以降のDateコマンドは第一引数で指定した0(1970年1月1日0時0分0秒)を必ず返すようになるため、<br />
この時間かどうかをチェックすれば大丈夫です。<br />
また、以下のように戻り値のオブジェクトのtickメソッドにより、<br />
指定したミリ秒だけ時間を進めることもできます。<br />
<code>@clock.tick(3600000)</code></p>

<h2 id="sinonのその他の機能:3bae98bb6aa9abe8f0b8472a1492cace">sinonのその他の機能</h2>

<p>sinonに関しては他にもいろいろ有用なものがあります。<br />
ちょっと古いですが、以下のmixiさんのブログ記事は参考になると思います。</p>

<p><a href="http://alpha.mixi.co.jp/2011/10798/">http://alpha.mixi.co.jp/<sup>2011</sup>&frasl;<sub>10798</sub>/</a></p>

                </div>

            </div>

            

<div class="social_buttons">
    
    <span class="twitter">
        <a href="https://twitter.com/share" class="twitter-share-button" data-via="ota42y">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
    </span>
    

    
    <span class="hatena">
        <a href="http://localhost:1313/blog/2014/08/22/mocha-test/" class="hatena-bookmark-button"
           data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="ja"
           title="このエントリーをはてなブックマークに追加">
            <img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png"
                 alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" />
        </a>
        <script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js"
                charset="utf-8" async="async">
        </script>
    </span>
    
</div>

        </div>
    </div>
    <div class="footer_height"></div>


<div class="footer_margin"></div>
<div class="footer_wrapper footer_height">
    <div class="content">
        <div class="footer">
            Copyright © 2015 - ota42y
        </div>
    </div>
</div>
</div>
</body>
</html>

