<!doctype html>
<html lang="ja">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="description" content="hubot-ircではmsg.replyのリプライ先が変わるので注意">
    <meta name="author" content="ota42y">

    <link rel="stylesheet" type="text/css" href="/css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="/css/base.css">
    <link rel="stylesheet" type="text/css" href="/css/page.css">
    <link rel="stylesheet" type="text/css" href="/css/list.css">

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
    <script>
        hljs.configure({tabReplace: '    '}); 
        hljs.initHighlightingOnLoad();
    </script>

    
    <title>hubot-ircではmsg.replyのリプライ先が変わるので注意 | おおたの物置</title>
    
</head>


<body>

<header>
    <div class="navbar navbar-default">
        <div class="container">
          <div class="navbar-header">
              <a href="/" class="navbar-brand">おおたの物置</a>
              <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#navbar-main">
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
              </button>
          </div>

            <div class="navbar-collapse collapse" id="navbar-main">
                <ul class="nav navbar-nav">
                    <li
                      
                      ><a href="/">Top</a></li>

                    <li
                      
                      
                      
                      class="active"
                      

                      

                      ><a href="/blog/">Blog</a></li>
                    <li
                      

                      
                      ><a href="/tags/">Tags</a></li>

                    <li
                      

                      
                      ><a href="/pages/">Pages</a></li>
                </ul>
                <p class="navbar-text navbar-right"><a class="navbar-link" href="">rss</a></p>

                
                <p class="navbar-text navbar-right"><a class="navbar-link" href="https://github.com/ota42y">github</a></p>
                

                
                <p class="navbar-text navbar-right"><a class="navbar-link" href="https://twitter.com/ota42y">twitter</a></p>
                
            </div>
        </div>
    </div>
</header>



<div class="container">
    <div class="row">
        <div class="col-lg-12">
            <div class="page-header">
              <h1 class="article_title"><a href="/blog/2014/11/01/hubot-reply/">hubot-ircではmsg.replyのリプライ先が変わるので注意</a></h1>
              <p class="post_detail">
    
    <time datetime="2014-11-01" class="post_data">
    2014-11-01
    </time>
    

    
    <span class="separator">|</span>
    <span class="post_data">tags: [</span>

    
    <span class="post_data">
        <a href="/tags/hubot">hubot</a>
    </span>
    

    <span class="post_data">]</span>
    
</p>

            </div>

            
            <div id="toc">
                <div id="toc_body">
                    <div id="toc_index">目次</div>
                    <nav id="TableOfContents">
<ul>
<li><a href="#原因となるコードを捜す">原因となるコードを捜す</a>
<ul>
<li><a href="#hubot-irc-reply">hubot-irc.reply</a></li>
<li><a href="#hubot-irc-send">hubot-irc.send</a></li>
</ul></li>
<li><a href="#hubt-irc-gettargetfromenvelope">hubt-irc._getTargetFromEnvelope</a>
<ul>
<li><a href="#replyメソッドの呼ばれ方">replyメソッドの呼ばれ方</a></li>
<li><a href="#hubot-irc-createuser">hubot-irc.createUser</a></li>
<li><a href="#hubot-getuserfromid">hubot.getUserFromId</a></li>
</ul></li>
</ul>
</nav>
                </div>
            </div>
            

            <div class="article">
              

<p>hubot-ircを使い、こういうコードで一定時間後に後からユーザに通知しようとしてたところ、<br />
replyしてるのに発言元とは別のチャットに送信してしまうという問題が起きました。</p>

<pre><code class="language-coffeescript">robot.respond /進捗 start/i, (msg) -&gt;
  setTimeout(-&gt;
    msg.reply &quot;進捗どうですか？&quot;
    return
  , 30 * 60 * 1000)

  msg.send &quot;進捗 start&quot;
</code></pre>

<p>何度か意図的に起こしてみたところ、どうやらmsg.replyの送信先は、<br />
そのユーザがreplyする時に最後に発言したチャットに対して行われるらしく、<br />
メッセージが作られた後に別のチャットに発言した場合、そちらに送られてしまうようです。</p>

<p>そのため、以下のように送信先を待避することで回避できます。</p>

<pre><code class="language-coffeescript">robot.respond /進捗 start/i, (msg) -&gt;
  user = msg.message.user.name
  room = msg.message.user.room

  setTimeout(-&gt;
    robot.send {room: room}, &quot;#{user} 進捗どうですか？&quot;
    return
  , 30 * 60 * 1000)

  msg.send &quot;進捗 start&quot;
</code></pre>

<h1 id="原因となるコードを捜す">原因となるコードを捜す</h1>

<p>というのは振る舞いから推測したものなので、実際にコードを追ってみます。</p>

<h2 id="hubot-irc-reply">hubot-irc.reply</h2>

<p>まずはhubot-ircのmsg.replyの中を見ます。<br />
<a href="https://github.com/nandub/hubot-irc/blob/master/src/irc.coffee#L78">https://github.com/nandub/hubot-irc/blob/master/src/irc.coffee#L78</a></p>

<pre><code class="language-coffeescript">reply: (envelope, strings...) -&gt;
  for str in strings
    @send envelope.user, &quot;#{envelope.user.name}: #{str}&quot;
</code></pre>

<p>メッセージをユーザ宛に変換し、sendメソッドにenvelope.userと一緒に渡しています。</p>

<h2 id="hubot-irc-send">hubot-irc.send</h2>

<p>次にsendメソッドの中身を見ます。<br />
<a href="https://github.com/nandub/hubot-irc/blob/522c50166f15e57ada0c10f181d4de26b4349717/src/irc.coffee#L16">https://github.com/nandub/hubot-irc/blob/522c50166f15e57ada0c10f181d4de26b4349717/src/irc.coffee#L16</a></p>

<pre><code class="language-coffeescript">send: (envelope, strings...) -&gt;
  # Use @notice if SEND_NOTICE_MODE is set
  return @notice envelope, strings if process.env.HUBOT_IRC_SEND_NOTICE_MODE?

  target = @_getTargetFromEnvelope envelope

  unless target
    return logger.error &quot;ERROR: Not sure who to send to. envelope=&quot;, envelope

  for str in strings
    @bot.say target, str
</code></pre>

<p><code>envelope</code>（replyメソッドのenvelope.user）から<code>_getTargetFromEnvelope</code>でターゲットを取り出し、<br />
<code>@bot.say</code>で発言をしています。</p>

<p>このとき、@botはnodeのircパッケージのオブジェクトで、<br />
sayメソッドはtargetに対してメッセージを送るようになっています。<br />
そのため、このtargetに設定される返信先が変更される可能性が高そうです。</p>

<h1 id="hubt-irc-gettargetfromenvelope">hubt-irc._getTargetFromEnvelope</h1>

<p><a href="https://github.com/nandub/hubot-irc/blob/master/src/irc.coffee#L336">https://github.com/nandub/hubot-irc/blob/master/src/irc.coffee#L336</a></p>

<pre><code class="language-coffeescript">_getTargetFromEnvelope: (envelope) -&gt;
  user = null
  room = null
  target = null

  # as of hubot 2.4.2, the first param to send() is an object with 'user'
  # and 'room' data inside. detect the old style here.
  if envelope.reply_to
    user = envelope
  else
    # expand envelope
    user = envelope.user
    room = envelope.room

  if user
    # most common case - we're replying to a user in a room
    if user.room
      target = user.room
    # reply directly
    else if user.name
      target = user.name
    # replying to pm
    else if user.reply_to
      target = user.reply_to
    # allows user to be an id string
    else if user.search?(/@/) != -1
      target = user
  else if room
    # this will happen if someone uses robot.messageRoom(jid, ...)
    target = room

  target
</code></pre>

<p>ユーザの情報を使ってリプライ先を決定しているようです。<br />
この中で、envelope.roomが存在すれば、それをtargetとして設定するようになっています。<br />
なお、このメソッド内のenvelopeは、replyメソッドのenvelope.userを差しています。</p>

<p>そのため、次はreplyメソッドのenvelope.user.roomが書き換わるかどうかを調べていきます。</p>

<h2 id="replyメソッドの呼ばれ方">replyメソッドの呼ばれ方</h2>

<p>コールスタックをさかのぼっていくと、以下のメソッドが順に呼ばれていました。<br />
<a href="https://github.com/github/hubot/blob/39681ea35de6375154748418e11f533ef51c3340/src/listener.coffee#L22">https://github.com/github/hubot/blob/39681ea35de6375154748418e11f533ef51c3340/src/listener.coffee#L22</a><br />
<a href="https://github.com/github/hubot/blob/39681ea35de6375154748418e11f533ef51c3340/src/robot.coffee#L192">https://github.com/github/hubot/blob/39681ea35de6375154748418e11f533ef51c3340/src/robot.coffee#L192</a><br />
<a href="https://github.com/github/hubot/blob/39681ea35de6375154748418e11f533ef51c3340/src/adapter.coffee#L65">https://github.com/github/hubot/blob/39681ea35de6375154748418e11f533ef51c3340/src/adapter.coffee#L65</a><br />
<a href="https://github.com/nandub/hubot-irc/blob/522c50166f15e57ada0c10f181d4de26b4349717/src/irc.coffee#L237">https://github.com/nandub/hubot-irc/blob/522c50166f15e57ada0c10f181d4de26b4349717/src/irc.coffee#L237</a></p>

<p>この中で、最後のhubt-ircの以下の部分で、nodeのircがメッセージを受信した場合に、<br />
メッセージから特定されたuserオブジェクトが、replyメソッドのenvelope.userになっていました。</p>

<pre><code class="language-coffeescript">bot.addListener 'message', (from, to, message) -&gt;
  if options.nick.toLowerCase() == to.toLowerCase()
    # this is a private message, let the 'pm' listener handle it
    return

  if from in options.ignoreUsers
    logger.info('Ignoring user: %s', from)
    # we'll ignore this message if it's from someone we want to ignore
    return

  logger.debug &quot;From #{from} to #{to}: #{message}&quot;

  user = self.createUser to, from
  if user.room
    logger.info &quot;#{to} &lt;#{from}&gt; #{message}&quot;
  else
    unless message.indexOf(to) == 0
      message = &quot;#{to}: #{message}&quot;
    logger.debug &quot;msg &lt;#{from}&gt; #{message}&quot;

  self.receive new TextMessage(user, message)
</code></pre>

<p>userオブジェクトは、受け取ったメッセージからcreateUserを使って求めているようです</p>

<h2 id="hubot-irc-createuser">hubot-irc.createUser</h2>

<p><a href="https://github.com/nandub/hubot-irc/blob/522c50166f15e57ada0c10f181d4de26b4349717/src/irc.coffee#L111">https://github.com/nandub/hubot-irc/blob/522c50166f15e57ada0c10f181d4de26b4349717/src/irc.coffee#L111</a></p>

<pre><code class="language-coffeescript">  createUser: (channel, from) -&gt;
    user = @getUserFromId from
    user.name = from

    if channel.match(/^[&amp;#]/)
      user.room = channel
    else
      user.room = null
    user
</code></pre>

<p>ここで、user.roomに最新のメッセージが送られたchannelをセットしています。<br />
そのため、getUserFromIdが返すuserオブジェクトがメッセージごとに共通なら、<br />
replyメソッドに渡された後に別のメッセージによって書き換わる可能性があると言えます。</p>

<h2 id="hubot-getuserfromid">hubot.getUserFromId</h2>

<p>getUserFromIdはhubot.getUserFromIdを呼び出しているだけでした。<br />
（HubotのAPIが変わったため、一手間挟んでいる）</p>

<p><a href="https://github.com/github/hubot/blob/39681ea35de6375154748418e11f533ef51c3340/src/brain.coffee#L103">https://github.com/github/hubot/blob/39681ea35de6375154748418e11f533ef51c3340/src/brain.coffee#L103</a></p>

<pre><code class="language-coffeescript"> userForId: (id, options) -&gt;
    user = @data.users[id]
    unless user
      user = new User id, options
      @data.users[id] = user

    if options and options.room and (!user.room or user.room isnt options.room)
      user = new User id, options
      @data.users[id] = user

    user
</code></pre>

<p>@data内に保存されているユーザを帰しています。<br />
そのため、各メッセージ毎に共通のuserオブジェクトが返されます。</p>

<p>hubot-irc.createUser内でこのオブジェクトのroomを書き換えているため、<br />
ユーザが発言を行うと、robot.replyの時に使用するuserオブジェクトが変更され、<br />
慈顔をおいて発言しようとすると別のチャットに発言していたようです。</p>

            </div>
        </div>
    </div>

    

<div class="social_buttons">
    
    <span class="twitter">
        <a href="https://twitter.com/share" class="twitter-share-button" data-via="ota42y">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
    </span>
    

    
    <span class="hatena">
        <a href="/blog/2014/11/01/hubot-reply/" class="hatena-bookmark-button"
           data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="ja"
           title="このエントリーをはてなブックマークに追加">
            <img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png"
                 alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" />
        </a>
        <script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js"
                charset="utf-8" async="async">
        </script>
    </span>
    
</div>

</div>

<footer class="small">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 text-center copyright">
                Copyright © 2015 - ota42y powerd by <a href="https://github.com/ota42y/honokichi">Honokichi</a>
            </div>
        </div>
    </div>
</footer>


<script src="./js/jquery.min.js"></script>
<script src="./js/bootstrap.min.js"></script>

</body>
</html>

