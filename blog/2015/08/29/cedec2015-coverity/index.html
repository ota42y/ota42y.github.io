<!doctype html>
<html lang="ja">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="description" content="CEDEC2015のCoverityクイズをどう直すか">
    <meta name="author" content="ota42y">

    <link rel="stylesheet" type="text/css" href="/css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="/css/base.css">
    <link rel="stylesheet" type="text/css" href="/css/page.css">
    <link rel="stylesheet" type="text/css" href="/css/list.css">

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
    <script>
        hljs.configure({tabReplace: '    '}); 
        hljs.initHighlightingOnLoad();
    </script>

    
    <title>CEDEC2015のCoverityクイズをどう直すか | おおたの物置</title>
    
</head>


<body>

<header>
    <div class="navbar navbar-default">
        <div class="container">
          <div class="navbar-header">
              <a href="/" class="navbar-brand">おおたの物置</a>
              <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#navbar-main">
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
              </button>
          </div>

            <div class="navbar-collapse collapse" id="navbar-main">
                <ul class="nav navbar-nav">
                    <li
                      
                      ><a href="/">Top</a></li>

                    <li
                      
                      
                      
                      class="active"
                      

                      

                      ><a href="/blog/">Blog</a></li>
                    <li
                      

                      
                      ><a href="/tags/">Tags</a></li>

                    <li
                      

                      
                      ><a href="/pages/">Pages</a></li>
                </ul>
                <p class="navbar-text navbar-right"><a class="navbar-link" href="">rss</a></p>

                
                <p class="navbar-text navbar-right"><a class="navbar-link" href="https://github.com/ota42y">github</a></p>
                

                
                <p class="navbar-text navbar-right"><a class="navbar-link" href="https://twitter.com/ota42y">twitter</a></p>
                
            </div>
        </div>
    </div>
</header>



<div class="container">
    <div class="row">
        <div class="col-lg-12">
            <div class="page-header">
              <h1 class="article_title"><a href="/blog/2015/08/29/cedec2015-coverity/">CEDEC2015のCoverityクイズをどう直すか</a></h1>
              <p class="post_detail">
    
    <time datetime="2015-08-29" class="post_data">
    2015-08-29
    </time>
    

    
    <span class="separator">|</span>
    <span class="post_data">tags: [</span>

    
    <span class="post_data">
        <a href="/tags/cpp">cpp</a>
    </span>
    

    <span class="post_data">]</span>
    
</p>

            </div>

            
            <div id="toc">
                <div id="toc_body">
                    <div id="toc_index">目次</div>
                    <nav id="TableOfContents">
<ul>
<li><a href="#テンプレートでキャストを回避する">テンプレートでキャストを回避する</a></li>
<li><a href="#アドレス計算を先にする">アドレス計算を先にする</a></li>
<li><a href="#設計から変える">設計から変える</a></li>
</ul>
</nav>
                </div>
            </div>
            

            <div class="article">
              

<p>CEDEC2015では、<a href="http://www.coverity.com/html_ja/">Coverity社</a>のブースでバグのあるコードが掲示されていました。</p>

<p><blockquote class="twitter-tweet" lang="ja"><p lang="ja" dir="ltr">バグが入ったC++コードらしい。<a href="https://twitter.com/hashtag/CEDEC2015?src=hash">#CEDEC2015</a> <a href="http://t.co/ca9vb0emVT">pic.twitter.com/ca9vb0emVT</a></p>&mdash; alwei (@aizen76) <a href="https://twitter.com/aizen76/status/636434428563054593">2015, 8月 26</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></p>

<p>バグがあるかどうかはCoverityが検出してくれるとして、じゃあどう解決すれば良いのか？を考えました。</p>

<p>コードを見る限り、</p>

<ul>
<li>配列の添え字と同じ値を入れたい</li>
<li>処理は2つのクラスで共通化したい</li>
</ul>

<p>という要求があると考えます。<br />
(zに値を入れないが元コードもそうなのでよしとする)</p>

<p>また、簡単化のために与えられるデータは全て正しいと仮定します。<br />
(実際は適切な箇所でエラーチェックが必要)</p>

<h1 id="テンプレートでキャストを回避する">テンプレートでキャストを回避する</h1>

<p>今回のバグは暗黙的キャストが行われ、かつキャストした状態でアドレス計算をするのが問題のため、<br />
キャストされないように、テンプレートを使って両方のクラス用の関数を用意する事で回避する方法です。</p>

<pre><code class="language-cpp">#include &lt;stdio.h&gt;

class base_class {
public:
  base_class() { x = 0; y = 0; }

public:
  int x ;
  int y;
};

class derived_class : public base_class {
public:
  derived_class() { z = 0; }

public:
  int z;
};

template &lt;typename T&gt;
void calc_class_members(T b, int array_size)
{
  for(int i = 0; i &lt; array_size; i++)
  {
    b[i].x = i;
    b[i].y = i;
  }
}

int update_class_members(
  derived_class * class_array,
  int num_array )
{
  if( class_array == NULL)
    return -1;

  calc_class_members(class_array, num_array);

  return 0;
}
</code></pre>

<h1 id="アドレス計算を先にする">アドレス計算を先にする</h1>

<p>型が違う状態でアドレス計算しているのが問題なので、アドレス計算部分を外に出してしまう方法です。<br />
関数ではなくクラスにメソッドとして持たせるとより良さそうです。</p>

<p>ただしこの場合、他の誰かが元コードのような処理を書くことを防げません。</p>

<pre><code class="language-cpp">void calc_class_member(base_class *b, int i)
{
  b-&gt;x = i;
  b-&gt;y = i;
}

int update_class_members(
  derived_class *class_array,
  int num_array )
{
  if( class_array == NULL)
    return -1;

  for(int i = 0; i &lt; num_array; i++){
	calc_class_member(&amp;class_array[i], i);
  }

  return 0;
}
</code></pre>

<h1 id="設計から変える">設計から変える</h1>

<p>意図的にバグを入れているコードに対して、全体を書き換えるのはナンセンスな気がしますが、<br />
たぶんこういうことをする前提なら最も良い書き方はこうではないかと。</p>

<p>おおよそ上の通りですが、vectorの場合は中身の型が違うvectorにキャストされないため、<br />
型が違う状態でアドレス計算が行われることはありません。</p>

<pre><code class="language-cpp">#include &lt;vector&gt;
#include &lt;stdio.h&gt;

class base_class {
public:
  base_class() { x = 0; y = 0; }

  void calc_class_member(int i)
  {
    x = i;
    y = i;
  }

public:
  int x ;
  int y;
};

class derived_class : public base_class {
public:
  derived_class() { z = 0; }

public:
  int z;
};


void update_class_members(std::vector&lt;derived_class&gt; &amp;a)
{
  size_t size = a.size();
  for(size_t i = 0; i &lt; size; ++i)
  {
    a.at(i).calc_class_member(static_cast&lt;int&gt;(i));
  }
}
</code></pre>

            </div>
        </div>
    </div>

    

<div class="social_buttons">
    
    <span class="twitter">
        <a href="https://twitter.com/share" class="twitter-share-button" data-via="ota42y">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
    </span>
    

    
    <span class="hatena">
        <a href="http://ota42y.com/blog/2015/08/29/cedec2015-coverity/" class="hatena-bookmark-button"
           data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="ja"
           title="このエントリーをはてなブックマークに追加">
            <img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png"
                 alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" />
        </a>
        <script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js"
                charset="utf-8" async="async">
        </script>
    </span>
    
</div>

</div>

<footer class="small">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 text-center copyright">
                Copyright © 2015 - ota42y powerd by <a href="https://github.com/ota42y/honokichi">Honokichi</a>
            </div>
        </div>
    </div>
</footer>


<script src="./js/jquery.min.js"></script>
<script src="./js/bootstrap.min.js"></script>

</body>
</html>

