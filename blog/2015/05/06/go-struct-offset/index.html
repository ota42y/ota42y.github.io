<!doctype html>
<html lang="ja">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="description" content="Go言語でメモリ上の大きさや配置を調べる">
    <meta name="author" content="ota42y">

    <link rel="stylesheet" type="text/css" href="/css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="/css/base.css">
    <link rel="stylesheet" type="text/css" href="/css/page.css">
    <link rel="stylesheet" type="text/css" href="/css/list.css">

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
    <script>
        hljs.configure({tabReplace: '    '}); 
        hljs.initHighlightingOnLoad();
    </script>

    
    <title>Go言語でメモリ上の大きさや配置を調べる | おおたの物置</title>
    
</head>


<body>

<header>
    <div class="navbar navbar-default">
        <div class="container">
          <div class="navbar-header">
              <a href="/" class="navbar-brand">おおたの物置</a>
              <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#navbar-main">
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
              </button>
          </div>

            <div class="navbar-collapse collapse" id="navbar-main">
                <ul class="nav navbar-nav">
                    <li
                      
                      ><a href="/">Top</a></li>

                    <li
                      
                      
                      
                      class="active"
                      

                      

                      ><a href="/blog/">Blog</a></li>
                    <li
                      

                      
                      ><a href="/tags/">Tags</a></li>

                    <li
                      

                      
                      ><a href="/pages/">Pages</a></li>
                </ul>
                <p class="navbar-text navbar-right"><a class="navbar-link" href="">rss</a></p>

                
                <p class="navbar-text navbar-right"><a class="navbar-link" href="https://github.com/ota42y">github</a></p>
                

                
                <p class="navbar-text navbar-right"><a class="navbar-link" href="https://twitter.com/ota42y">twitter</a></p>
                
            </div>
        </div>
    </div>
</header>



<div class="container">
    <div class="row">
        <div class="col-md-8">
            <div class="page-header">
              <h1 class="article_title"><a href="/blog/2015/05/06/go-struct-offset/">Go言語でメモリ上の大きさや配置を調べる</a></h1>
              <p class="post_detail">
    
    <time datetime="2015-05-06" class="post_data">
    2015-05-06
    </time>
    

    
    <span class="separator">|</span>
    <span class="post_data">tags: [</span>

    
    <span class="post_data">
        <a href="/tags/golang">golang</a>
    </span>
    

    <span class="post_data">]</span>
    
</p>

            </div>

            <div class="article">
              

<p>golangで構造体を定義した場合、
メモリ上にどのように配置されるのでしょうか。</p>

<p>通常意識する必要はありませんが、32bitと64bitで挙動がおかしい場合など、<br />
ごく希に調べる必要に迫られる場合があります。<br />
そのような場合、各要素のサイズや、構造体先頭からのオフセットを調べることで、<br />
メモリ上に構造体がどう置かれるかを調べることができます。</p>

<p>C言語でのsizeofやoffsetofに対応する物が、golangのunsafeパッケージに用意されているため、<br />
これを利用することで構造体の様子を調べることができます。<br />
<a href="https://golang.org/pkg/unsafe/">https://golang.org/pkg/unsafe/</a></p>

<p>今回は以下のようなテスト構造体を使い、メモリ上にどのように置かれるかを調べました。<br />
テスト環境はwindows7(32bit)とmac(64bit)になります。</p>

<pre><code class="language-go">type A struct {
  flag bool
  num int64
  ptr *int64
  mini int32
  str string
  nums []int64
  nums5 [5]int64
  strs []string
}
</code></pre>

<h1 id="要素のサイズ">要素のサイズ</h1>

<p>unsafe.Sizeof関数は、引数の要素のサイズを調べ、バイト数をint型で返してくれます。</p>

<pre><code class="language-go">a := A{}
log.Println(unsafe.Sizeof(a)) // 92 (136) 括弧外は32bit環境、括弧内は64bit
log.Println(unsafe.Sizeof(a.flag)) // 1
log.Println(unsafe.Sizeof(a.num)) // 8
log.Println(unsafe.Sizeof(a.ptr)) // 4 (8)
log.Println(unsafe.Sizeof(a.mini)) // 4
log.Println(unsafe.Sizeof(a.str)) // 8 (16)
log.Println(unsafe.Sizeof(a.nums)) // 12 (24)
log.Println(unsafe.Sizeof(a.nums5)) // 40
log.Println(unsafe.Sizeof(a.strs)) // 12 (24)

a.nums = append(a.nums, 42)
a.strs = append(a.strs, &quot;デーデッデー&quot;)
log.Println(unsafe.Sizeof(a.nums)) // 12 (24)
log.Println(unsafe.Sizeof(a.strs)) // 12 (24)

log.Println(unsafe.Sizeof(&amp;a)) // 4 (8)
</code></pre>

<p>この関数は指定した要素のサイズを返します。
そのため、32bit環境ではint64のポインタであるa.ptrは、<br />
ポインタのサイズである4byte(=32bit)を返します。</p>

<p>また、配列の場合は配列全体のサイズ(a.nums5 = 64 * 5)を返しますが、<br />
スライスの場合はスライス自身の値(12 or 24byte)を返し、スライス全体の値は返しません。<br />
そのため、要素を追加してもスライス自身の大きさは変化しません。</p>

<h1 id="先頭からのオフセット">先頭からのオフセット</h1>

<p>上記の例でbool値のa.flagが1byteかつ、ほかの要素がすべて偶数なのにもかかわらず、<br />
構造体全体の大きさが92byteの偶数になっています。<br />
このことから、golangの構造体はパディングされる場合があることがわかります。<br />
そのため、要素のサイズを足していったところが、実際にメモリ上に置かれる場所とは限りません。</p>

<p>構造体先頭からのオフセットが何byteかをint型で返す、unsafe.Offsetofを使うことで、<br />
実際にどの位置に配置されているかを確認できます。</p>

<pre><code class="language-go">log.Println(unsafe.Offsetof(a.flag)) // 0
log.Println(unsafe.Offsetof(a.num)) // 4 (8)
log.Println(unsafe.Offsetof(a.ptr)) // 12 (16)
log.Println(unsafe.Offsetof(a.mini)) // 16 (24)
log.Println(unsafe.Offsetof(a.str)) // 20 (32)
log.Println(unsafe.Offsetof(a.nums)) // 28 (48)
log.Println(unsafe.Offsetof(a.nums5)) // 40 (72)
log.Println(unsafe.Offsetof(a.strs)) // 80 (112)
</code></pre>

<p>32bit環境ではa.flagの1byteの後に3byteパディングがされ、<br />
a.numが先頭から4byte(=32bit)の位置から始まっています。</p>

<p>64bit環境ではa.flagの後ろに7byteパディングされ、<br />
a.numが先頭から8byte(=64bit)の位置から始まっています。<br />
また、int32のa.miniも4byteパディングされ、a.strが32byte目から始まるようになっています。</p>

<p>このように、32bit環境では32bitに、64bit環境では64bitの倍数から始まるように、<br />
コンパイラが構造体にパディングをするようです。</p>

<h1 id="構造体内の構造体の場合">構造体内の構造体の場合</h1>

<p>以下のように構造体に実態を持つ場合、宣言したとおりに配置されます。<br />
そのためAの実態であるaの前後で、構造体のサイズ分だけオフセットが移動しています。</p>

<pre><code class="language-go">type B struct {
  bflag bool
  intnum int64
  a A
  bflag2 bool
  a2 *A
  bflag3 bool
  A
  blfag4 bool
}
</code></pre>

<pre><code class="language-go">b := B{
  a2: &amp;A{},
}
log.Println(unsafe.Offsetof(b.bflag)) // 0
log.Println(unsafe.Offsetof(b.intnum)) // 4
log.Println(&quot;b.a&quot;)
log.Println(unsafe.Offsetof(b.a.flag)) // 0
log.Println(unsafe.Offsetof(b.a.strs)) // 80
log.Println(&quot;b.flag2&quot;)
log.Println(unsafe.Offsetof(b.bflag2)) // 104 (4 + 8 + 92)
log.Println(&quot;b.a2&quot;) // a2 is pointer
log.Println(unsafe.Offsetof(b.a2.flag)) // 0
log.Println(unsafe.Offsetof(b.a2.strs)) // 80 (112)
log.Println(&quot;b.bflag3&quot;)
log.Println(unsafe.Offsetof(b.bflag3)) // 112 (104 + 8)
log.Println(&quot;b.flag&quot;)
log.Println(unsafe.Offsetof(b.flag)) // 116
log.Println(unsafe.Offsetof(b.num)) // 120
log.Println(unsafe.Offsetof(b.ptr)) // 128
log.Println(unsafe.Offsetof(b.mini)) // 132
log.Println(unsafe.Offsetof(b.strs)) // 196
log.Println(&quot;b.bflag4&quot;)
log.Println(unsafe.Offsetof(b.blfag4)) // 208 (112 + 92)
</code></pre>

<p>unsafe.Offsetofは対象の要素を持つ構造体の先頭からのオフセットを指すため、<br />
構造体Bの中にあるAでも、Bからのオフセットではなく、Aの先頭からのオフセットを出力しています。</p>

<p>また、ポインタとして持つ場合、実態は別のところにあるため、a2のサイズはポインタ分のみになります。</p>

<p>構造体を埋め込んだ場合、それらの値がそのままそこに置かれたかのように置かれます。<br />
また、埋め込んだ構造体の値として扱われるらしく、<br />
実態として持っているときと違い、構造体Aの要素でもBの先頭からのオフセットを出力しています。</p>

<h1 id="ソースコード">ソースコード</h1>

<pre><code class="language-go">package main

import (
  &quot;log&quot;
  &quot;unsafe&quot;
)

type A struct {
  flag bool
  num int64
  ptr *int64
  mini int32
  str string
  nums []int64
  nums5 [5]int64
  strs []string
}

type B struct {
  bflag bool
  intnum int64
  a A
  bflag2 bool
  a2 *A
  bflag3 bool
  A
  blfag4 bool
}

func main() {
  log.Println(&quot;sizeof&quot;)
  a := A{}
  log.Println(unsafe.Sizeof(a)) // 92 (136) 括弧内は64bit
  log.Println(unsafe.Sizeof(a.flag)) // 1
  log.Println(unsafe.Sizeof(a.num)) // 8
  log.Println(unsafe.Sizeof(a.ptr)) // 4 (8)
  log.Println(unsafe.Sizeof(a.mini)) // 4
  log.Println(unsafe.Sizeof(a.str)) // 8 (16)
  log.Println(unsafe.Sizeof(a.nums)) // 12 (24)
  log.Println(unsafe.Sizeof(a.nums5)) // 40
  log.Println(unsafe.Sizeof(a.strs)) // 12 (24)

  a.nums = append(a.nums, 42)
  a.strs = append(a.strs, &quot;デーデッデー&quot;)
  log.Println(unsafe.Sizeof(a.nums)) // 12 (24)
  log.Println(unsafe.Sizeof(a.strs)) // 12 (24)

  log.Println(unsafe.Sizeof(&amp;a)) // 4 (8)

  log.Println(&quot;offest&quot;)
  log.Println(unsafe.Offsetof(a.flag)) // 0
  log.Println(unsafe.Offsetof(a.num)) // 4 (8)
  log.Println(unsafe.Offsetof(a.ptr)) // 12 (16)
  log.Println(unsafe.Offsetof(a.mini)) // 16 (24)
  log.Println(unsafe.Offsetof(a.str)) // 20 (32)
  log.Println(unsafe.Offsetof(a.nums)) // 28 (48)
  log.Println(unsafe.Offsetof(a.nums5)) // 40 (72)
  log.Println(unsafe.Offsetof(a.strs)) // 80 (112)



  log.Println(&quot;b&quot;)
  b := B{
    a2: &amp;A{},
  }
  log.Println(unsafe.Offsetof(b.bflag)) // 0
  log.Println(unsafe.Offsetof(b.intnum)) // 4
  log.Println(&quot;b.a&quot;)
  log.Println(unsafe.Offsetof(b.a.flag)) // 0
  log.Println(unsafe.Offsetof(b.a.strs)) // 80
  log.Println(&quot;b.flag2&quot;)
  log.Println(unsafe.Offsetof(b.bflag2)) // 104 (4 + 8 + 92)
  log.Println(&quot;b.a2&quot;) // a2 is pointer
  log.Println(unsafe.Offsetof(b.a2.flag)) // 0
  log.Println(unsafe.Offsetof(b.a2.strs)) // 80 (112)
  log.Println(&quot;b.bflag3&quot;)
  log.Println(unsafe.Offsetof(b.bflag3)) // 112 (104 + 8)
  log.Println(&quot;b.flag&quot;)
  log.Println(unsafe.Offsetof(b.flag)) // 116
  log.Println(unsafe.Offsetof(b.num)) // 120
  log.Println(unsafe.Offsetof(b.ptr)) // 128
  log.Println(unsafe.Offsetof(b.mini)) // 132
  log.Println(unsafe.Offsetof(b.strs)) // 196
  log.Println(&quot;b.bflag4&quot;)
  log.Println(unsafe.Offsetof(b.blfag4)) // 208 (112 + 92)
}

</code></pre>

            </div>
        </div>
        <div class="col-md-4">
          <div class="row">
            
            <div id="toc">
                <div id="toc_body">
                    <div id="toc_index">目次</div>
                    <nav id="TableOfContents">
<ul>
<li><a href="#要素のサイズ">要素のサイズ</a></li>
<li><a href="#先頭からのオフセット">先頭からのオフセット</a></li>
<li><a href="#構造体内の構造体の場合">構造体内の構造体の場合</a></li>
<li><a href="#ソースコード">ソースコード</a></li>
</ul>
</nav>
                </div>
            </div>
            
            
          </div>
          <div class="row">
            <div id="recent_item">
  <div id="recent_item_index">最近の投稿</div>
  <ul>
    

    <li>
      <small>
        <a href="/blog/2018/10/07/techbook_5_result/">
          
          <time datetime="2018-10-07" class="recent_date">
            2018-10-07
          </time>
          
          技術書典５で本を３冊出しました
        </a>
      </small>
    </li>

    

    <li>
      <small>
        <a href="/blog/2018/10/06/techbook_5/">
          
          <time datetime="2018-10-06" class="recent_date">
            2018-10-06
          </time>
          
          技術書典５で本が３冊出ます
        </a>
      </small>
    </li>

    

    <li>
      <small>
        <a href="/blog/2018/10/04/2018-10-04/">
          
          <time datetime="2018-10-04" class="recent_date">
            2018-10-04
          </time>
          
          Amazon Web Servicesサーバーレスレシピ という本を出します
        </a>
      </small>
    </li>

    

    <li>
      <small>
        <a href="/blog/2018/08/01/ryazo/">
          
          <time datetime="2018-08-01" class="recent_date">
            2018-08-01
          </time>
          
          RustでGyazoクローンを作った
        </a>
      </small>
    </li>

    

    <li>
      <small>
        <a href="/blog/2018/07/17/goroutine/">
          
          <time datetime="2018-07-17" class="recent_date">
            2018-07-17
          </time>
          
          goroutineの動き方を調べた
        </a>
      </small>
    </li>

    

    <li>
      <small>
        <a href="/blog/2018/06/04/bootsnap/">
          
          <time datetime="2018-06-04" class="recent_date">
            2018-06-04
          </time>
          
          bootsnapの速度計測
        </a>
      </small>
    </li>

    

    <li>
      <small>
        <a href="/blog/2018/04/23/techbookfest_4/">
          
          <time datetime="2018-04-23" class="recent_date">
            2018-04-23
          </time>
          
          技術書展4でMicroservices architecture よろず本を出した
        </a>
      </small>
    </li>

    

    <li>
      <small>
        <a href="/blog/2018/04/10/microservices_yorozu_book/">
          
          <time datetime="2018-04-10" class="recent_date">
            2018-04-10
          </time>
          
          技術書典4でMicroservices architectureよろず本を出します
        </a>
      </small>
    </li>

    

    <li>
      <small>
        <a href="/blog/2018/04/04/virtual_gem/">
          
          <time datetime="2018-04-04" class="recent_date">
            2018-04-04
          </time>
          
          gemのバージョンアップで依存関係が壊れるのを調べやすくした
        </a>
      </small>
    </li>

    
  </ul>
</div>

          </div>
          <div class="row">
            
<div id="profile">
  <div id="profile_index">プロフィール</div>
  <p>
    <a href="https://twitter.com/ota42y"><img class="icon" src="/ota42y.png"></a>
  </p>
  <p class="name">ota42y</p>
  <p>C&#43;&#43;/Ruby/RoR/golang/rust/flutter。最近はElasticserachや機械学習系もやる</p>
</div>

          </div>
        </div>
    </div>

    

<div class="social_buttons">
    
    <span class="twitter">
        <a href="https://twitter.com/share" class="twitter-share-button" data-via="ota42y">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
    </span>
    

    
    <span class="hatena">
        <a href="/blog/2015/05/06/go-struct-offset/" class="hatena-bookmark-button"
           data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="ja"
           title="このエントリーをはてなブックマークに追加">
            <img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png"
                 alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" />
        </a>
        <script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js"
                charset="utf-8" async="async">
        </script>
    </span>
    
</div>

</div>

<footer class="small">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 text-center copyright">
                Copyright © 2015 - ota42y powerd by <a href="https://github.com/ota42y/honokichi">Honokichi</a>
            </div>
        </div>
    </div>
</footer>


<script src="./js/jquery.min.js"></script>
<script src="./js/bootstrap.min.js"></script>

</body>
</html>

