<!doctype html>
<html lang="ja">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="description" content="freeコマンドに新しく追加されたavailableについて">
    <meta name="author" content="ota42y">

    <link rel="stylesheet" type="text/css" href="/css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="/css/base.css">
    <link rel="stylesheet" type="text/css" href="/css/page.css">
    <link rel="stylesheet" type="text/css" href="/css/list.css">

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
    <script>
        hljs.configure({tabReplace: '    '}); 
        hljs.initHighlightingOnLoad();
    </script>

    
    <title>freeコマンドに新しく追加されたavailableについて | おおたの物置</title>
    
</head>


<body>

<header>
    <div class="navbar navbar-default">
        <div class="container">
          <div class="navbar-header">
              <a href="/" class="navbar-brand">おおたの物置</a>
              <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#navbar-main">
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
              </button>
          </div>

            <div class="navbar-collapse collapse" id="navbar-main">
                <ul class="nav navbar-nav">
                    <li
                      
                      ><a href="/">Top</a></li>

                    <li
                      
                      
                      
                      class="active"
                      

                      

                      ><a href="/blog/">Blog</a></li>
                    <li
                      

                      
                      ><a href="/tags/">Tags</a></li>

                    <li
                      

                      
                      ><a href="/pages/">Pages</a></li>
                </ul>
                <p class="navbar-text navbar-right"><a class="navbar-link" href="">rss</a></p>

                
                <p class="navbar-text navbar-right"><a class="navbar-link" href="https://github.com/ota42y">github</a></p>
                

                
                <p class="navbar-text navbar-right"><a class="navbar-link" href="https://twitter.com/ota42y">twitter</a></p>
                
            </div>
        </div>
    </div>
</header>



<div class="container">
    <div class="row">
        <div class="col-lg-12">
            <div class="page-header">
              <h1 class="article_title"><a href="/blog/2015/09/09/free-command/">freeコマンドに新しく追加されたavailableについて</a></h1>
              <p class="post_detail">
    
    <time datetime="2015-09-09" class="post_data">
    2015-09-09
    </time>
    

    
    <span class="separator">|</span>
    <span class="post_data">tags: [</span>

    
    <span class="post_data">
        <a href="/tags/linux">linux</a>
    </span>
    

    <span class="post_data">]</span>
    
</p>

            </div>

            
            <div id="toc">
                <div id="toc_body">
                    <div id="toc_index">目次</div>
                    <nav id="TableOfContents">
<ul>
<li><a href="#freeコマンドに追加されたavailable">freeコマンドに追加されたavailable</a>
<ul>
<li><a href="#コード">コード</a></li>
<li><a href="#コード内容">コード内容</a></li>
</ul></li>
</ul>
</nav>
                </div>
            </div>
            

            <div class="article">
              

<h1 id="freeコマンドに追加されたavailable">freeコマンドに追加されたavailable</h1>

<p>3.14および2.6.27から、freeコマンドの書式が変わり、<br />
<code>-/+ buffers/cache</code>が消えてavailableという項目が増えました。</p>

<p>availableは<code>/proc/meminfo</code>の中にあるMemAvailablの値を参照しています。<br />
この値は、新しいアプリがスワップせずに使える容量はどれくらいか。といった値を示しているようです</p>

<pre><code>available
Estimation of how much memory  is  available  for  starting  new
applications,  without swapping. Unlike the data provided by the
cache or free fields, this field takes into account  page  cache
and also that not all reclaimable memory slabs will be reclaimed
due to items being in use (MemAvailable in /proc/meminfo, avail‐
able on kernels 3.14, emulated on kernels 2.6.27+, otherwise the
same as free)
</code></pre>

<h2 id="コード">コード</h2>

<p>/proc/meminfoは以下のコードによって作成されるようです。<br />
<a href="https://github.com/torvalds/linux/blob/master/fs/proc/meminfo.c">https://github.com/torvalds/linux/blob/master/fs/proc/meminfo.c</a></p>

<pre><code class="language-cpp">available = i.freeram - wmark_low;

pagecache = pages[LRU_ACTIVE_FILE] + pages[LRU_INACTIVE_FILE];
pagecache -= min(pagecache / 2, wmark_low);
available += pagecache;

available += global_page_state(NR_SLAB_RECLAIMABLE) -
			 min(global_page_state(NR_SLAB_RECLAIMABLE) / 2, wmark_low);
</code></pre>

<h2 id="コード内容">コード内容</h2>

<p>ざっと見たところ、sysinfoのfreeramの値から、ページキャッシュやslabキャッシュの中の再利用可能な分を足した値が、MemAvailableとして計算されるようです。</p>

<p>実際の空き容量＋直ぐに解放可能な容量＝利用可能なメモリ容量といった感じのようです。<br />
そのため、ほぼこの値を見てメモリの空き容量を判断してよさそうです。</p>

            </div>
        </div>
    </div>

    

<div class="social_buttons">
    
    <span class="twitter">
        <a href="https://twitter.com/share" class="twitter-share-button" data-via="ota42y">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
    </span>
    

    
    <span class="hatena">
        <a href="http://ota42y.com/blog/2015/09/09/free-command/" class="hatena-bookmark-button"
           data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="ja"
           title="このエントリーをはてなブックマークに追加">
            <img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png"
                 alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" />
        </a>
        <script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js"
                charset="utf-8" async="async">
        </script>
    </span>
    
</div>

</div>

<footer class="small">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 text-center copyright">
                Copyright © 2015 - ota42y powerd by <a href="https://github.com/ota42y/honokichi">Honokichi</a>
            </div>
        </div>
    </div>
</footer>


<script src="./js/jquery.min.js"></script>
<script src="./js/bootstrap.min.js"></script>

</body>
</html>

