<!doctype html>
<html lang="ja">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="description" content="インライン展開がどう展開されるのかを調べた">
    <meta name="author" content="ota42y">

    <link rel="stylesheet" type="text/css" href="/css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="/css/base.css">
    <link rel="stylesheet" type="text/css" href="/css/page.css">
    <link rel="stylesheet" type="text/css" href="/css/list.css">

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
    <script>
        hljs.configure({tabReplace: '    '}); 
        hljs.initHighlightingOnLoad();
    </script>

    
    <title>インライン展開がどう展開されるのかを調べた | おおたの物置</title>
    
</head>


<body>

<header>
    <div class="navbar navbar-default">
        <div class="container">
          <div class="navbar-header">
              <a href="/" class="navbar-brand">おおたの物置</a>
              <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#navbar-main">
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
              </button>
          </div>

            <div class="navbar-collapse collapse" id="navbar-main">
                <ul class="nav navbar-nav">
                    <li
                      
                      ><a href="/">Top</a></li>

                    <li
                      
                      
                      
                      class="active"
                      

                      

                      ><a href="/blog/">Blog</a></li>
                    <li
                      

                      
                      ><a href="/tags/">Tags</a></li>

                    <li
                      

                      
                      ><a href="/pages/">Pages</a></li>
                </ul>
                <p class="navbar-text navbar-right"><a class="navbar-link" href="">rss</a></p>

                
                <p class="navbar-text navbar-right"><a class="navbar-link" href="https://github.com/ota42y">github</a></p>
                

                
                <p class="navbar-text navbar-right"><a class="navbar-link" href="https://twitter.com/ota42y">twitter</a></p>
                
            </div>
        </div>
    </div>
</header>



<div class="container">
    <div class="row">
        <div class="col-lg-12">
            <div class="page-header">
              <h1 class="article_title"><a href="/blog/2015/01/05/c-inline/">インライン展開がどう展開されるのかを調べた</a></h1>
              <p class="post_detail">
    
    <time datetime="2015-01-05" class="post_data">
    2015-01-05
    </time>
    

    
    <span class="separator">|</span>
    <span class="post_data">tags: [</span>

    
    <span class="post_data">
        <a href="/tags/cpp">cpp</a>
    </span>
    

    <span class="post_data">]</span>
    
</p>

            </div>

            
            <div id="toc">
                <div id="toc_body">
                    <div id="toc_index">目次</div>
                    <nav id="TableOfContents">
<ul>
<li><a href="#ソースコード">ソースコード</a></li>
<li><a href="#最適化しない場合">最適化しない場合</a></li>
<li><a href="#最適化した場合">最適化した場合</a></li>
<li><a href="#インライン指定しない場合のエラー">インライン指定しない場合のエラー</a></li>
<li><a href="#まとめ">まとめ</a></li>
</ul>
</nav>
                </div>
            </div>
            

            <div class="article">
              

<p>C++コンパイラは、関数呼び出し部分にその関数の内容を展開し、<br />
関数呼び出しのオーバーヘッドを削減する、インライン展開をします。</p>

<p>インライン展開はコンパイル時にされるため、<br />
実際に行われたのか、どう行われているかは出力されません。</p>

<p>そのため、コンパイルたコードがどうなってるかを調べ、<br />
インライン展開がどう展開しているのかを調べました。</p>

<p>なお、アセンブラに関してはほとんど説明しません。<br />
「callq シンボル名(文字列)」で関数呼び出しを実行する事だけ理解していれば大丈夫です。</p>

<h1 id="ソースコード">ソースコード</h1>

<p>以下のソースコードを使います</p>

<p>test.cpp</p>

<pre><code class="language-cpp">#include &quot;stdio.h&quot;
#include &quot;func.h&quot;

int main(){
  TestA test;
  int a = test.getNumInCpp();
  int b = test.getNumInH();
  int c = test.getNumInline();
  int d = test.getNumCallCpp();
  printf(&quot;%d %d %d %d\n&quot;, a, b, c, d);

  return 0;
}
</code></pre>

<p>func.h</p>

<pre><code class="language-cpp">class TestA{
  private:
  int privateFunc();

  public:
  int getNumInCpp();

  int getNumInH() {
    return 42;
  }

  int getNumCallCpp(){
    return privateFunc() + getNumInH();
  }

  int getNumInline();

  //int getNumNormal();
};

inline int TestA::getNumInline(){return 321;}

// そもそも定義できない
// int TestA::getNumNormal(){return 111;}
</code></pre>

<p>func.cpp</p>

<pre><code class="language-cpp">#include &quot;func.h&quot;

int TestA::privateFunc(){
  return 123;
}

int TestA::getNumInCpp() {
  return 73 + getNumInH();
}
</code></pre>

<p>内容としては、</p>

<ul>
<li>getNumInCpp()

<ul>
<li>cpp内に関数の中身が書かれている</li>
<li>cpp内のものはインライン展開されないはず</li>
</ul></li>
<li>getNumInH()

<ul>
<li>ヘッダファイル内に関数の中身が置かれている</li>
<li>インライン展開される</li>
</ul></li>
<li>getNumInline()

<ul>
<li>インライン不可能なprivateメソッドと、cpp内の関数を呼ぶ</li>
</ul></li>
<li>getNumCallCpp()

<ul>
<li>明示的にインライン展開指定をしたもの</li>
<li>インライン展開される</li>
</ul></li>
</ul>

<p>になります。</p>

<h1 id="最適化しない場合">最適化しない場合</h1>

<p>まずは最適化オプションをつけずにコンパイルしました。<br />
<code>g++ -S test.cpp func.cpp</code></p>

<p>そのため、インライン展開はされません。</p>

<pre><code class="language-cpp">subq	$32, %rsp
leaq	-8(%rbp), %rdi
movl	$0, -4(%rbp)
callq	__ZN5TestA11getNumInCppEv # (変数aの計算)
leaq	-8(%rbp), %rdi
movl	%eax, -12(%rbp)
callq	__ZN5TestA9getNumInHEv # (変数bの計算)
leaq	-8(%rbp), %rdi
movl	%eax, -16(%rbp)
callq	__ZN5TestA12getNumInlineEv # (変数cの計算)
leaq	-8(%rbp), %rdi
movl	%eax, -20(%rbp)
callq	__ZN5TestA13getNumCallCppEv # (変数dの計算)
leaq	L_.str(%rip), %rdi
movl	%eax, -24(%rbp)
movl	-12(%rbp), %esi
movl	-16(%rbp), %edx
movl	-20(%rbp), %ecx
movl	-24(%rbp), %r8d
movb	$0, %al
callq	_printf
</code></pre>

<p>callqで4種類の関数を全て呼び出しているのがわかります。<br />
インライン展開はされていないため、func.hやfunc.cppで直接書いている数値はどこにも出てきません。</p>

<h1 id="最適化した場合">最適化した場合</h1>

<p>O3オプションをつけてインライン展開されるようにしました。<br />
<code>g++ -S -O3 test.cpp func.cpp</code></p>

<p>なお、#で注釈を入れています</p>

<pre><code class="language-cpp">leaq	-24(%rbp), %rbx
movq	%rbx, %rdi

# getNumInCppの呼び出し(変数aの計算)
callq	__ZN5TestA11getNumInCppEv
movl	%eax, %r14d
movq	%rbx, %rdi
# privateFuncの呼び出し(変数dの計算)
callq	__ZN5TestA11privateFuncEv
# getNumInHの結果が直接書かれている(変数dの計算)
leal	42(%rax), %r8d
leaq	L_.str(%rip), %rdi
# getNumInHの結果が直接書かれている(変数bの計算)
movl	$42, %edx
# getNumInlineの結果が直接書かれている(変数cの計算)
movl	$321, %ecx
xorl	%eax, %eax
movl	%r14d, %esi

# printfの呼び出し
callq	_printf
</code></pre>

<p>最適化した場合、関数呼び出しの量も内容もかなり変化しています。</p>

<p>一番初めのgetNumInCpp関数はcppに書かれており、インライン展開が出来ないため、<br />
最適化しない場合と同じく関数呼び出しをしています。</p>

<p>次にprivateFunc関数の呼び出しを行っていますが、<br />
これはgetNumCallCpp関数が展開され、それ以上展開できないprivateFunc関数と、<br />
42を返すだけのgetNumInH関数がさらにインライン展開されたものと思われます。<br />
privateFunc関数はprivateメソッドですが、アセンブラではアクセス指定子は無視されます。</p>

<p>また、321を返すgetNumInline関数もインライン展開されて直接数値が書かれているのがわかります。</p>

<p>なお、ソースコード上で変数bやcに代入している部分は、<br />
直接値を書いてある状態と同じになるようにインライン展開されるため、<br />
コンパイラの最適化によって処理順番を入れ替えられ、printfへの呼び出し直前に移動させられています。</p>

<h1 id="インライン指定しない場合のエラー">インライン指定しない場合のエラー</h1>

<p>コメントアウトしてあるgetNumNormal関数は、ヘッダファイル内でインライン指定をせずに定義しています。<br />
このコメントアウトを戻すと、以下のエラーにより失敗します。</p>

<pre><code>duplicate symbol __ZN5TestA12getNumNormalEv in:
/var/folders/md/b8zf203j65b0qt_t4439fdvm0000gp/T/test-837e1d.o
/var/folders/md/b8zf203j65b0qt_t4439fdvm0000gp/T/func-c8b605.o
ld: 1 duplicate symbol for architecture x86_64
clang: error: linker command failed with exit code 1 (use -v to see invocation)
</code></pre>

<p>sファイルの作成には成功するため調べてみたところ、
getNumNormal関数がfunc.sとtest.s両方に定義されていました。</p>

<p>この関数はインライン展開されないため、func.hを読み込むtest.cppとfunc.cpp両方で定義されてしまい、<br />
duplicate symbolになっています。</p>

<p>インライン展開されるgetNumInline関数は、関数自体はどこにも定義されないため二重定義にはならず、<br />
問題なく動いているようです。</p>

<h1 id="まとめ">まとめ</h1>

<ul>
<li>最適化しないとインライン展開されない</li>
<li>hファイルの中に実装を書くとインライン展開される

<ul>
<li>そもそもインライン展開しないとduplicateになる</li>
<li>そのため、ヘッダに書いた関数は全てインライン展開されるはず?</li>
</ul></li>
<li>cppファイルに実装を書くとインライン展開されない

<ul>
<li>include対象に入ってないのだからあたりまえ</li>
<li>複数のcppファイルに書かれた内容を繋げるのはリンク時なのでコンパイル後</li>
</ul></li>
</ul>

            </div>
        </div>
    </div>

    

<div class="social_buttons">
    
    <span class="twitter">
        <a href="https://twitter.com/share" class="twitter-share-button" data-via="ota42y">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
    </span>
    

    
    <span class="hatena">
        <a href="/blog/2015/01/05/c-inline/" class="hatena-bookmark-button"
           data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="ja"
           title="このエントリーをはてなブックマークに追加">
            <img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png"
                 alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" />
        </a>
        <script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js"
                charset="utf-8" async="async">
        </script>
    </span>
    
</div>

</div>

<footer class="small">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 text-center copyright">
                Copyright © 2015 - ota42y powerd by <a href="https://github.com/ota42y/honokichi">Honokichi</a>
            </div>
        </div>
    </div>
</footer>


<script src="./js/jquery.min.js"></script>
<script src="./js/bootstrap.min.js"></script>

</body>
</html>

