<!doctype html>
<html lang="ja">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="description" content="Railsはアクセスをどう処理しているのか(1)">
    <meta name="author" content="ota42y">

    <link rel="stylesheet" type="text/css" href="/css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="/css/base.css">
    <link rel="stylesheet" type="text/css" href="/css/page.css">
    <link rel="stylesheet" type="text/css" href="/css/list.css">

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
    <script>
        hljs.configure({tabReplace: '    '}); 
        hljs.initHighlightingOnLoad();
    </script>

    
    <title>Railsはアクセスをどう処理しているのか(1) | おおたの物置</title>
    
</head>


<body>

<header>
    <div class="navbar navbar-default">
        <div class="container">
          <div class="navbar-header">
              <a href="/" class="navbar-brand">おおたの物置</a>
              <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#navbar-main">
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
              </button>
          </div>

            <div class="navbar-collapse collapse" id="navbar-main">
                <ul class="nav navbar-nav">
                    <li
                      
                      ><a href="/">Top</a></li>

                    <li
                      
                      
                      

                      

                      ><a href="/blog/">Blog</a></li>
                    <li
                      

                      
                      ><a href="/tags/">Tags</a></li>

                    <li
                      

                      
                      ><a href="/pages/">Pages</a></li>
                </ul>
                <p class="navbar-text navbar-right"><a class="navbar-link" href="">rss</a></p>

                

                
            </div>
        </div>
    </div>
</header>



<div class="container">
    <div class="row">
        <div class="col-md-8">
            <div class="page-header">
              <h1 class="article_title"><a href="/post/2013/rails-trace-1/">Railsはアクセスをどう処理しているのか(1)</a></h1>
              <p class="post_detail">
    
    <time datetime="2013-11-10" class="post_data">
    2013-11-10
    </time>
    

    
    <span class="separator">|</span>
    <span class="post_data">tags: [</span>

    
    <span class="post_data">
        <a href="/tags/ruby">ruby</a>
    </span>
    

    <span class="post_data">]</span>
    
</p>

            </div>

            <div class="article">
              <p>ふと、Railsのコントローラーに書いたコードがが実行されるまでに、
何が起きているのか気になったので、全部追ってみようと思います。</p>

<p>まだ全部追い切れてないですが、思った以上に長くなったのでとりあえずメモとして出
してみます。<br />
一部Rails力やRuby力が足りなくて追い切れない部分がありますが(´･_･`)</p>

<p>##準備</p>

<pre><code>rails g controller Trace index
      create  app/controllers/trace_controller.rb
       route  get &quot;trace/index&quot;
      invoke  erb
      create    app/views/trace
      create    app/views/trace/index.html.erb
      invoke  test_unit
      create    test/controllers/trace_controller_test.rb
      invoke  helper
      create    app/helpers/trace_helper.rb
      invoke    test_unit
      create      test/helpers/trace_helper_test.rb
      invoke  assets
      invoke    coffee
      create      app/assets/javascripts/trace.js.coffee
      invoke    scss
      create      app/assets/stylesheets/trace.css.scss
</code></pre>

<p>というコントローラーを作り、</p>

<pre><code>class TraceController &lt; ApplicationController
  def index
    caller().each{ |line| p line}
  end
end
</code></pre>

<p>というtraceを用意し、ここにアクセスしてみました。</p>

<p>出力されたログは以下のようになりました。(見にくかったので、GEMまでのパスはGEM_FILE_PATHとしてます)</p>

<pre><code>Started GET &quot;/trace/index&quot; for 127.0.0.1 at 2013-11-02 20:22:17 +0900
Processing by TraceController#index as HTML
&quot;/GEMLIFE_PATH/actionpack-4.0.1/lib/action_controller/metal/implicit_render.rb:4:in `send_action'&quot;
&quot;/GEMLIFE_PATH/actionpack-4.0.1/lib/abstract_controller/base.rb:189:in `process_action'&quot;
&quot;/GEMLIFE_PATH/actionpack-4.0.1/lib/action_controller/metal/rendering.rb:10:in `process_action'&quot;
&quot;/GEMLIFE_PATH/actionpack-4.0.1/lib/abstract_controller/callbacks.rb:18:in `block in process_action'&quot;
&quot;/GEMLIFE_PATH/activesupport-4.0.1/lib/active_support/callbacks.rb:403:in `_run__2108733439165396685__process_action__callbacks'&quot;
&quot;/GEMLIFE_PATH/activesupport-4.0.1/lib/active_support/callbacks.rb:80:in `run_callbacks'&quot;
&quot;/GEMLIFE_PATH/actionpack-4.0.1/lib/abstract_controller/callbacks.rb:17:in `process_action'&quot;
&quot;/GEMLIFE_PATH/actionpack-4.0.1/lib/action_controller/metal/rescue.rb:29:in `process_action'&quot;
&quot;/GEMLIFE_PATH/actionpack-4.0.1/lib/action_controller/metal/instrumentation.rb:31:in `block in process_action'&quot;
&quot;/GEMLIFE_PATH/activesupport-4.0.1/lib/active_support/notifications.rb:159:in `block in instrument'&quot;
&quot;/GEMLIFE_PATH/activesupport-4.0.1/lib/active_support/notifications/instrumenter.rb:20:in `instrument'&quot;
&quot;/GEMLIFE_PATH/activesupport-4.0.1/lib/active_support/notifications.rb:159:in `instrument'&quot;
&quot;/GEMLIFE_PATH/actionpack-4.0.1/lib/action_controller/metal/instrumentation.rb:30:in `process_action'&quot;
&quot;/GEMLIFE_PATH/actionpack-4.0.1/lib/action_controller/metal/params_wrapper.rb:245:in `process_action'&quot;
&quot;/GEMLIFE_PATH/activerecord-4.0.1/lib/active_record/railties/controller_runtime.rb:18:in `process_action'&quot;
&quot;/GEMLIFE_PATH/actionpack-4.0.1/lib/abstract_controller/base.rb:136:in `process'&quot;
&quot;/GEMLIFE_PATH/actionpack-4.0.1/lib/abstract_controller/rendering.rb:44:in `process'&quot;
&quot;/GEMLIFE_PATH/actionpack-4.0.1/lib/action_controller/metal.rb:195:in `dispatch'&quot;
&quot;/GEMLIFE_PATH/actionpack-4.0.1/lib/action_controller/metal/rack_delegation.rb:13:in `dispatch'&quot;
&quot;/GEMLIFE_PATH/actionpack-4.0.1/lib/action_controller/metal.rb:231:in `block in action'&quot;
&quot;/GEMLIFE_PATH/actionpack-4.0.1/lib/action_dispatch/routing/route_set.rb:80:in `call'&quot;
&quot;/GEMLIFE_PATH/actionpack-4.0.1/lib/action_dispatch/routing/route_set.rb:80:in `dispatch'&quot;
&quot;/GEMLIFE_PATH/actionpack-4.0.1/lib/action_dispatch/routing/route_set.rb:48:in `call'&quot;
&quot;/GEMLIFE_PATH/actionpack-4.0.1/lib/action_dispatch/journey/router.rb:71:in `block in call'&quot;
&quot;/GEMLIFE_PATH/actionpack-4.0.1/lib/action_dispatch/journey/router.rb:59:in `each'&quot;
&quot;/GEMLIFE_PATH/actionpack-4.0.1/lib/action_dispatch/journey/router.rb:59:in `call'&quot;
&quot;/GEMLIFE_PATH/actionpack-4.0.1/lib/action_dispatch/routing/route_set.rb:680:in `call'&quot;
&quot;/GEMLIFE_PATH/rack-1.5.2/lib/rack/etag.rb:23:in `call'&quot;
&quot;/GEMLIFE_PATH/rack-1.5.2/lib/rack/conditionalget.rb:25:in `call'&quot;
&quot;/GEMLIFE_PATH/rack-1.5.2/lib/rack/head.rb:11:in `call'&quot;
&quot;/GEMLIFE_PATH/actionpack-4.0.1/lib/action_dispatch/middleware/params_parser.rb:27:in `call'&quot;
&quot;/GEMLIFE_PATH/actionpack-4.0.1/lib/action_dispatch/middleware/flash.rb:241:in `call'&quot;
&quot;/GEMLIFE_PATH/rack-1.5.2/lib/rack/session/abstract/id.rb:225:in `context'&quot;
&quot;/GEMLIFE_PATH/rack-1.5.2/lib/rack/session/abstract/id.rb:220:in `call'&quot;
&quot;/GEMLIFE_PATH/actionpack-4.0.1/lib/action_dispatch/middleware/cookies.rb:486:in `call'&quot;
&quot;/GEMLIFE_PATH/activerecord-4.0.1/lib/active_record/query_cache.rb:36:in `call'&quot;
&quot;/GEMLIFE_PATH/activerecord-4.0.1/lib/active_record/connection_adapters/abstract/connection_pool.rb:626:in `call'&quot;
&quot;/GEMLIFE_PATH/activerecord-4.0.1/lib/active_record/migration.rb:369:in `call'&quot;
&quot;/GEMLIFE_PATH/actionpack-4.0.1/lib/action_dispatch/middleware/callbacks.rb:29:in `block in call'&quot;
&quot;/GEMLIFE_PATH/activesupport-4.0.1/lib/active_support/callbacks.rb:373:in `_run__4335260606468341692__call__callbacks'&quot;
&quot;/GEMLIFE_PATH/activesupport-4.0.1/lib/active_support/callbacks.rb:80:in `run_callbacks'&quot;
&quot;/GEMLIFE_PATH/actionpack-4.0.1/lib/action_dispatch/middleware/callbacks.rb:27:in `call'&quot;
&quot;/GEMLIFE_PATH/actionpack-4.0.1/lib/action_dispatch/middleware/reloader.rb:64:in `call'&quot;
&quot;/GEMLIFE_PATH/actionpack-4.0.1/lib/action_dispatch/middleware/remote_ip.rb:76:in `call'&quot;
&quot;/GEMLIFE_PATH/actionpack-4.0.1/lib/action_dispatch/middleware/debug_exceptions.rb:17:in `call'&quot;
&quot;/GEMLIFE_PATH/actionpack-4.0.1/lib/action_dispatch/middleware/show_exceptions.rb:30:in `call'&quot;
&quot;/GEMLIFE_PATH/railties-4.0.1/lib/rails/rack/logger.rb:38:in `call_app'&quot;
&quot;/GEMLIFE_PATH/railties-4.0.1/lib/rails/rack/logger.rb:20:in `block in call'&quot;
&quot;/GEMLIFE_PATH/activesupport-4.0.1/lib/active_support/tagged_logging.rb:67:in `block in tagged'&quot;
&quot;/GEMLIFE_PATH/activesupport-4.0.1/lib/active_support/tagged_logging.rb:25:in `tagged'&quot;
&quot;/GEMLIFE_PATH/activesupport-4.0.1/lib/active_support/tagged_logging.rb:67:in `tagged'&quot;
&quot;/GEMLIFE_PATH/railties-4.0.1/lib/rails/rack/logger.rb:20:in `call'&quot;
&quot;/GEMLIFE_PATH/actionpack-4.0.1/lib/action_dispatch/middleware/request_id.rb:21:in `call'&quot;
&quot;/GEMLIFE_PATH/rack-1.5.2/lib/rack/methodoverride.rb:21:in `call'&quot;
&quot;/GEMLIFE_PATH/rack-1.5.2/lib/rack/runtime.rb:17:in `call'&quot;
&quot;/GEMLIFE_PATH/activesupport-4.0.1/lib/active_support/cache/strategy/local_cache.rb:83:in `call'&quot;
&quot;/GEMLIFE_PATH/rack-1.5.2/lib/rack/lock.rb:17:in `call'&quot;
&quot;/GEMLIFE_PATH/actionpack-4.0.1/lib/action_dispatch/middleware/static.rb:64:in `call'&quot;
&quot;/GEMLIFE_PATH/rack-1.5.2/lib/rack/sendfile.rb:112:in `call'&quot;
&quot;/GEMLIFE_PATH/railties-4.0.1/lib/rails/engine.rb:511:in `call'&quot;
&quot;/GEMLIFE_PATH/railties-4.0.1/lib/rails/application.rb:97:in `call'&quot;
&quot;/GEMLIFE_PATH/rack-1.5.2/lib/rack/lock.rb:17:in `call'&quot;
&quot;/GEMLIFE_PATH/rack-1.5.2/lib/rack/content_length.rb:14:in `call'&quot;
&quot;/GEMLIFE_PATH/rack-1.5.2/lib/rack/handler/webrick.rb:60:in `service'&quot;
&quot;/RUBY_PATH/webrick/httpserver.rb:138:in `service'&quot;
&quot;/RUBY_PATH/webrick/httpserver.rb:94:in `run'&quot;
&quot;/RUBY_PATH/webrick/server.rb:295:in `block in start_thread'&quot;
  Rendered trace/index.html.erb within layouts/application (0.9ms)
Completed 200 OK in 94ms (Views: 61.8ms | ActiveRecord: 0.0ms)
</code></pre>

<p>恐ろしい量(´･_･`)<br />
とりあえず、こんな感じで動いてるんだなーというイメージをつかむ程度の理解度で、<br />
ゆるふわに読んでいきたいと思います。</p>

<p>##コードをざっと見たところ</p>

<p>下の階層にenvを渡して[status, headers, body]の三つを受け取り、それを返す関数がほとんど。<br />
関数によってenvに変更を加えたり、戻り値の三つを加工したりとやってること自体はまちまちです。</p>

<p>ただ、各処理は本当に単一の処理だけをして次に処理を渡しており、<br />
ifかswitchがせいぜい一つぐらい、全体も20行程度の関数であることが多い印象です。</p>

<p>##Railsのコードを読む
上のログはスタックの上から順に出力しているはずなので、<br />
実際の処理は下から上に向かって行われます。</p>

<p>###<a href="https://github.com/ruby/ruby/blob/v2_0_0_247/lib/webrick/server.rb#L295">&rdquo;/RUBY_PATH/webrick/server.rb:295:in `block in start_thread&rsquo;&rdquo;</a><br />
名前の通りThread.startしてるだけ。</p>

<p>###<a href="https://github.com/ruby/ruby/blob/v2_0_0_247/lib/webrick/httpserver.rb#L94">&rdquo;/RUBY_PATH/webrick/httpserver.rb:94:in `run&rsquo;&rdquo;</a><br />
名前の通りひたすらループしている。<br />
リクエストを受け取って後述のserviceを呼び出し、その後返答を送信する処理を行う。</p>

<p>また、各種エラーが起こった場合もそれをキャッチし、エラーだということを送信している模様。</p>

<p>###<a href="https://github.com/ruby/ruby/blob/v2_0_0_247/lib/webrick/httpserver.rb#L138">&rdquo;/RUBY_PATH/webrick/httpserver.rb:138:in `service&rsquo;&rdquo;</a><br />
実際に処理をするところっぽい。<br />
search_servletにパスを渡し、どんな返答を返すべきなのかを探して、そこに処理を渡している。</p>

<p>###<a href="https://github.com/rack/rack/blob/1.5.2/lib/rack/handler/webrick.rb#L60">&rdquo;/GEMLIFE_PATH/rack-1.5.2/lib/rack/handler/webrick.rb:60:in `service&rsquo;&rdquo;</a><br />
名前の通りwebrickから直接値を渡され、処理するところ。<br />
webrickからはreqとresという値を受け取っている。</p>

<p>ハッシュであるreq.meta_varsを元に、必要な値が入ってなければ初期値を入れている。<br />
以降の処理はほとんどがこのハッシュを受け渡して処理を行っている。</p>

<p>また、処理した後に結果を受け取り、引数のresに入れている。</p>

<p>###<a href="https://github.com/rack/rack/blob/1.5.2/lib/rack/content_length.rb#L14">&rdquo;/GEMLIFE_PATH/rack-1.5.2/lib/rack/content_length.rb:14:in `call&rsquo;&rdquo;</a>
次の処理を読んで、帰ってきた結果にBODYが含まれているなら、<br />
ヘッダーにContent-Lengthを計算して追加している。</p>

<p>###<a href="https://github.com/rack/rack/blob/1.5.2/lib/rack/lock.rb#L17">&rdquo;/GEMLIFE_PATH/rack-1.5.2/lib/rack/lock.rb:17:in `call&rsquo;&rdquo;</a>
Mutex使ってロックをかけているだけみたい</p>

<p>###<a href="https://github.com/rails/rails/blob/v4.0.1/railties/lib/rails/application.rb#L97">&rdquo;/GEMLIFE_PATH/railties-4.0.1/lib/rails/application.rb:97:in `call&rsquo;&rdquo;</a>
rackから呼び出されるためだけに存在するやつっぽい。<br />
引数を少しいじってる程度</p>

<p>###<a href="https://github.com/rails/rails/blob/v4.0.1/railties/lib/rails/engine.rb#L511">&rdquo;/GEMLIFE_PATH/railties-4.0.1/lib/rails/engine.rb:511:in `call&rsquo;&rdquo;</a>
&lsquo;action_dispatch.routes&rsquo;というキーで、ActionDispatch::Routing::RouteSetを追加している。<br />
また、SCRIPT_NAMEが存在する場合には、<br />
ROUTES_オブジェクトID_SCRIPT_NAMEという名前で、同じ値をコピーして代入している。</p>

<p>###<a href="https://github.com/rack/rack/blob/1.5.2/lib/rack/sendfile.rb#L112">&rdquo;/GEMLIFE_PATH/rack-1.5.2/lib/rack/sendfile.rb:112:in `call&rsquo;&rdquo;</a>
より下の階層に処理をさせた後ファイル送信の場合にヘッダーの書き換えを行っている。</p>

<p>###<a href="https://github.com/rails/rails/blob/v4.0.1/actionpack/lib/action_dispatch/middleware/static.rb#L64">&rdquo;/GEMLIFE_PATH/actionpack-4.0.1/lib/action_dispatch/middleware/static.rb:64:in `call&rsquo;&rdquo;</a>
REQUEST_METHODがGETかHEADの時に、ルートからのパスを調べ、<br />
ファイルとして存在している場合には否かをチェックして、<br />
ある場合にはRack::Fileのcallを呼んでその結果を返している。<br />
たぶんRailsに処理させず、ファイルを読んで返してるだけかと。<br />
無い場合は特に何もせず下の階層を呼んでいる。</p>

<p>###<a href="https://github.com/rack/rack/blob/1.5.2/lib/rack/lock.rb#L17">&rdquo;/GEMLIFE_PATH/rack-1.5.2/lib/rack/lock.rb:17:in `call&rsquo;&rdquo;</a>
mutexを使ってロックをかけているだけっぽい。<br />
また、下の階層を呼んで得られたbodyに対して、BodyProxyに処理させた結果と入れ替えている。</p>

<p>###<a href="https://github.com/rails/rails/blob/v4.0.1/activesupport/lib/active_support/cache/strategy/local_cache.rb#L83">&rdquo;/GEMLIFE_PATH/activesupport-4.0.1/lib/active_support/cache/strategy/local_cache.rb:83:in `call&rsquo;&rdquo;</a>
LocalCacheRegistryにLocalStoreオブジェクトを初期化してセットしてる。<br />
コメントによると、簡単なメモリキャッシュに使うらしい。</p>

<p>###<a href="https://github.com/rack/rack/blob/1.5.2/lib/rack/runtime.rb#L17">&rdquo;/GEMLIFE_PATH/rack-1.5.2/lib/rack/runtime.rb:17:in `call&rsquo;&rdquo;</a>
X-Runtimeヘッダに、ここから下の処理にかかった時間をセットしている。</p>

<p>###<a href="https://github.com/rack/rack/blob/1.5.2/lib/rack/methodoverride.rb#L21">&rdquo;/GEMLIFE_PATH/rack-1.5.2/lib/rack/methodoverride.rb:21:in `call&rsquo;&rdquo;</a>
POSTメソッドだった場合に、METHOD_OVERRIDE_PARAM_KEYやHTTP_METHOD_OVERRIDE_HEADERを見て、<br />
登録されているメソッド名GET HEAD PUT POST DELETE OPTIONS PATCHだったらそれと入れ替えている。<br />
おそらく、PUTとかを実装していないブラウザで、POSTに特別な種類のデータを入れてPUTとして扱うための対応。</p>

<p>###<a href="https://github.com/rails/rails/blob/v4.0.1/actionpack/lib/action_dispatch/middleware/request_id.rb#L21">&rdquo;/GEMLIFE_PATH/actionpack-4.0.1/lib/action_dispatch/middleware/request_id.rb:21:in `call&rsquo;&rdquo;</a>
あるならばHTTP_X_REQUEST_IDの値か、無いならばSecureRandom.uuidの結果を、<br />
action_dispatch.request_idとして設定している。<br />
たぶんリクエストを一意に識別したいんだと思う。<br />
また、ヘッダのX-Request-Idにもその価を入れている。</p>

<p>###<a href="https://github.com/rails/rails/blob/v4.0.1/railties/lib/rails/rack/logger.rb#L20">&rdquo;/GEMLIFE_PATH/railties-4.0.1/lib/rails/rack/logger.rb:20:in `call&rsquo;&rdquo;</a>
事前に設定されたタグごとに処理をしているみたい。</p>

<p>###<a href="https://github.com/rails/rails/blob/v4.0.1/activesupport/lib/active_support/tagged_logging.rb#L67">&rdquo;/GEMLIFE_PATH/activesupport-4.0.1/lib/active_support/tagged_logging.rb:67:in `tagged&rsquo;&rdquo;</a>
###<a href="https://github.com/rails/rails/blob/v4.0.1/activesupport/lib/active_support/tagged_logging.rb#L25">&rdquo;/GEMLIFE_PATH/activesupport-4.0.1/lib/active_support/tagged_logging.rb:25:in `tagged&rsquo;&rdquo;</a>
###<a href="https://github.com/rails/rails/blob/v4.0.1/activesupport/lib/active_support/tagged_logging.rb#L67">&rdquo;/GEMLIFE_PATH/activesupport-4.0.1/lib/active_support/tagged_logging.rb:67:in `block in tagged&rsquo;&rdquo;</a>
この辺ちょっと何やってるかわからない(´･_･`)<br />
なんか引数で与えられたタグに処理してるっぽいけど、Ruby力が低くて読み取れない (´・ω・｀)</p>

<p>###<a href="https://github.com/rails/rails/blob/v4.0.1/railties/lib/rails/rack/logger.rb#L20">&rdquo;/GEMLIFE_PATH/railties-4.0.1/lib/rails/rack/logger.rb:20:in `block in call&rsquo;&rdquo;</a>
４つ上のところと同じ箇所。<br />
上で用意したloggerにブロックで次の処理を呼ぶように指定しているため、<br />
ブロックを渡す相手の初期化→ブロック内の実行と、二回同じ箇所にくる。</p>

<p>###<a href="https://github.com/rails/rails/blob/v4.0.1/railties/lib/rails/rack/logger.rb#L38">&rdquo;/GEMLIFE_PATH/railties-4.0.1/lib/rails/rack/logger.rb:38:in `call_app&rsquo;&rdquo;</a>
Debugの場合はログ出力にスペースを二つ挟んでいる。<br />
その後、ActiveSupport::Nortificationsを使い、&rsquo;request.action_dispatch&rsquo;という名前で、requestを通知している。<br />
ここでリクエスト直後に処理を挟むようなライブラリを呼び出しているとか？</p>

<p>###<a href="https://github.com/rails/rails/blob/v4.0.1/actionpack/lib/action_dispatch/middleware/show_exceptions.rb#L30">&rdquo;/GEMLIFE_PATH/actionpack-4.0.1/lib/action_dispatch/middleware/show_exceptions.rb:30:in `call&rsquo;&rdquo;</a>
基本何もしないけど、ここより下の階層から例外が投げられた場合に、<br />
例外用のレスポンスを作成して返している。</p>

<p>###<a href="https://github.com/rails/rails/blob/v4.0.1/actionpack/lib/action_dispatch/middleware/debug_exceptions.rb#L17">&rdquo;/GEMLIFE_PATH/actionpack-4.0.1/lib/action_dispatch/middleware/debug_exceptions.rb:17:in `call&rsquo;&rdquo;</a>
ヘッダにX-Cascadeがpassと設定されている場合、もしくは任意の他のエラーが起きた場合に、<br />
エラーレスポンスを作成している。</p>

<p>###<a href="https://github.com/rails/rails/blob/v4.0.1/actionpack/lib/action_dispatch/middleware/remote_ip.rb#L76">&rdquo;/GEMLIFE_PATH/actionpack-4.0.1/lib/action_dispatch/middleware/remote_ip.rb:76:in `call&rsquo;&rdquo;</a>
action_dispatch.remote_ipにアクセスしてきたIPアドレスを保存している。<br />
保存はGetIpクラスで行われており、calculate_ipメソッドを実行することで、<br />
アクセスしてきたIPアドレスを計算している。<br />
そのため、IPアドレスが必要ない場合は計算が行われない。<br />
どうやら、GetIpクラスの中でかなり巨大な正規表現を用いてIPアドレスを計算しているらしく、<br />
そこの処理が重いため、必要が無ければ計算しないand計算したらメモするようにしているみたい。<br />
(この正規表現を使っているみたい<a href="https://gist.github.com/gazay/1289635">https://gist.github.com/gazay/1289635</a>)</p>

<p>###<a href="https://github.com/rails/rails/blob/v4.0.1/actionpack/lib/action_dispatch/middleware/reloader.rb#L64">&rdquo;/GEMLIFE_PATH/actionpack-4.0.1/lib/action_dispatch/middleware/reloader.rb:64:in `call&rsquo;&rdquo;</a>
コールバックとして設定されたprepareとcleanupを処理の最初と最後に呼んでいる。</p>

<p>###<a href="https://github.com/rails/rails/blob/v4.0.1/actionpack/lib/action_dispatch/middleware/callbacks.rb#L27">&rdquo;/GEMLIFE_PATH/actionpack-4.0.1/lib/action_dispatch/middleware/callbacks.rb:27:in `call&rsquo;&rdquo;</a></p>

<p>コールバックとして登録された関数に、より下の処理を実行するようにブロックで渡し、<br />
ブロック内で例外が出た場合にその例外を返す。
何でわざわざこんな回りくどい例外の拾い方をしてるのかな？<br />
一応、ブロック内で例外が発生したとしても、コールバック関数はそのまま処理が実行され、<br />
その後再び同じ例外をなげる事になるんだけれどこれが目的？</p>

<p>###<a href="https://github.com/rails/rails/blob/v4.0.1/activesupport/lib/active_support/callbacks.rb#L80">&rdquo;/GEMLIFE_PATH/activesupport-4.0.1/lib/active_support/callbacks.rb:80:in `run_callbacks&rsquo;&rdquo;</a>
###<a href="https://github.com/rails/rails/blob/v4.0.1/activesupport/lib/active_support/callbacks.rb#L373">&rdquo;/GEMLIFE_PATH/activesupport-4.0.1/lib/active_support/callbacks.rb:373:in `_run<strong>4335260606468341692</strong>call__callbacks&rsquo;&rdquo;</a>
与えられたシンボル(イベント名？)からコールバック先を見つけ、それに対して引数のブロックを渡している？<br />
なんかEVALしてクラスを作ってたりしてて、ちょっと意味不明なことやってる(´･_･`)</p>

<p>###<a href="https://github.com/rails/rails/blob/v4.0.1/actionpack/lib/action_dispatch/middleware/callbacks.rb#L29">&rdquo;/GEMLIFE_PATH/actionpack-4.0.1/lib/action_dispatch/middleware/callbacks.rb:29:in `block in call&rsquo;&rdquo;</a>
三つ上の位置から渡されたブロック内部。<br />
下の処理を呼んでるだけ。</p>

<p>##続く
ここまではRails以前のいろんな処理が多かったですが、<br />
ここから先はActiveRecordが現れ始め、いかにもRails本体の動きっぽい感じがします。<br />
が、長くなりすぎたのでいったん切ります。</p>

            </div>
        </div>
        <div class="col-md-4">
          <div class="row">
            
            
          </div>
          <div class="row">
            <div id="recent_item">
  <div id="recent_item_index">最近の投稿</div>
  <ul>
    

    <li>
      <small>
        <a href="/blog/2018/techbook_5_result/">
          
          <time datetime="2018-10-07" class="recent_date">
            2018-10-07
          </time>
          
          技術書典５で本を３冊出しました
        </a>
      </small>
    </li>

    

    <li>
      <small>
        <a href="/blog/2018/techbook_5/">
          
          <time datetime="2018-10-06" class="recent_date">
            2018-10-06
          </time>
          
          技術書典５で本が３冊出ます
        </a>
      </small>
    </li>

    

    <li>
      <small>
        <a href="/blog/2018/2018-10-04/">
          
          <time datetime="2018-10-04" class="recent_date">
            2018-10-04
          </time>
          
          Amazon Web Servicesサーバーレスレシピ という本を出します
        </a>
      </small>
    </li>

    

    <li>
      <small>
        <a href="/blog/2018/ryazo/">
          
          <time datetime="2018-08-01" class="recent_date">
            2018-08-01
          </time>
          
          RustでGyazoクローンを作った
        </a>
      </small>
    </li>

    

    <li>
      <small>
        <a href="/blog/2018/goroutine/">
          
          <time datetime="2018-07-17" class="recent_date">
            2018-07-17
          </time>
          
          goroutineの動き方を調べた
        </a>
      </small>
    </li>

    

    <li>
      <small>
        <a href="/blog/2018/bootsnap/">
          
          <time datetime="2018-06-04" class="recent_date">
            2018-06-04
          </time>
          
          bootsnapの速度計測
        </a>
      </small>
    </li>

    

    <li>
      <small>
        <a href="/blog/2018/techbookfest_4/">
          
          <time datetime="2018-04-23" class="recent_date">
            2018-04-23
          </time>
          
          技術書展4でMicroservices architecture よろず本を出した
        </a>
      </small>
    </li>

    

    <li>
      <small>
        <a href="/blog/2018/microservices_yorozu_book/">
          
          <time datetime="2018-04-10" class="recent_date">
            2018-04-10
          </time>
          
          技術書典4でMicroservices architectureよろず本を出します
        </a>
      </small>
    </li>

    

    <li>
      <small>
        <a href="/blog/2018/virtual_gem/">
          
          <time datetime="2018-04-04" class="recent_date">
            2018-04-04
          </time>
          
          gemのバージョンアップで依存関係が壊れるのを調べやすくした
        </a>
      </small>
    </li>

    
  </ul>
</div>

          </div>
          <div class="row">
            
<div id="profile">
  <div id="profile_index">プロフィール</div>
  <p>
    <a href=""><img class="icon" src=""></a>
  </p>
  <p class="name"></p>
  <p></p>
</div>

          </div>
        </div>
    </div>

    

</div>

<footer class="small">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 text-center copyright">
                Copyright © 2015 - ota42y powerd by <a href="https://github.com/ota42y/honokichi">Honokichi</a>
            </div>
        </div>
    </div>
</footer>


<script src="./js/jquery.min.js"></script>
<script src="./js/bootstrap.min.js"></script>

</body>
</html>

