<!doctype html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="description" content="2015年18週目まとめ">
    <meta name="author" content="ota42y">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
    <script>
      hljs.configure({tabReplace: '    '}); 
      hljs.initHighlightingOnLoad();
    </script>

    
    <title>2015年18週目まとめ | おおたの物置</title>
    

    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/list.css">
    <link rel="stylesheet" href="/css/single.css">
    <link rel="stylesheet" href="/css/index.css">
</head>


<body>

<div class="body">

    <div class="header_wrapper">
        <div class="content">
            <div class="header">
                <div class="header_left">
                    <a class="banner" href="/">おおたの物置</a>
                </div>
                <div class="header_right">
                    
                    <a href="https://twitter.com/ota42y">twitter</a>
                    

                    
                    <a href="https://github.com/ota42y">github</a>
                    
                    <a href="">RSS</a>
                </div>
            </div>
        </div>
    </div>

    <div class="content">
        <div class="main">

            <div class="article">

                <div class="post_title">
                    <h1>2015年18週目まとめ</h1>
                    

<time datetime="2015-05-04" class="post_data">
2015-05-04
</time>







                    <div class="clear"></div>
                </div>

                <div class="article_body">

                    
                    <div id="toc">
                        <div id="toc_body">
                            <div id="toc_index">目次</div>
                            <nav id="TableOfContents">
<ul>
<li><a href="#goのテストはクラス設計がとても大事っぽい:fbc8528214e49b0085aa07c0c8b68dfd">goのテストはクラス設計がとても大事っぽい</a>
<ul>
<li><a href="#rubyで関数の差し替え:fbc8528214e49b0085aa07c0c8b68dfd">rubyで関数の差し替え</a></li>
<li><a href="#goで関数の差し替え:fbc8528214e49b0085aa07c0c8b68dfd">goで関数の差し替え</a>
<ul>
<li><a href="#埋め込みによる差し替え-できない:fbc8528214e49b0085aa07c0c8b68dfd">埋め込みによる差し替え（できない）</a></li>
<li><a href="#インターフェースを利用する:fbc8528214e49b0085aa07c0c8b68dfd">インターフェースを利用する</a></li>
</ul></li>
<li><a href="#まとめ:fbc8528214e49b0085aa07c0c8b68dfd">まとめ</a></li>
</ul></li>
<li><a href="#bpstudy-92に参加した:fbc8528214e49b0085aa07c0c8b68dfd">BPStudy#92に参加した</a></li>
<li><a href="#mongodbについて調べていた:fbc8528214e49b0085aa07c0c8b68dfd">mongodbについて調べていた</a>
<ul>
<li><a href="#一定時間後にデータが消える設定:fbc8528214e49b0085aa07c0c8b68dfd">一定時間後にデータが消える設定</a></li>
<li><a href="#指定した期間のデータをdumpする:fbc8528214e49b0085aa07c0c8b68dfd">指定した期間のデータをdumpする</a></li>
</ul></li>
</ul>
</nav>
                        </div>
                    </div>
                    

                    

<h1 id="goのテストはクラス設計がとても大事っぽい:fbc8528214e49b0085aa07c0c8b68dfd">goのテストはクラス設計がとても大事っぽい</h1>

<p>まだこうした方が良いんじゃないか？ぐらいなので、<br />
ベストプラクティスは他にありそうです…</p>

<h2 id="rubyで関数の差し替え:fbc8528214e49b0085aa07c0c8b68dfd">rubyで関数の差し替え</h2>

<p>Rubyだと以下のように、<br />
すでに存在するクラスに対して関数を再定義したり、<br />
継承して関数の差し替えをすることが簡単にできます。</p>

<pre><code class="language-ruby">
class A
  def exec
    f()
    a()
  end

  def f
    print &quot;f &quot;
  end

  def a
    print &quot;a\n&quot;
  end
end

a = A.new
a.exec # f a

class A
  def f
    print &quot;newf &quot;
  end
end

a.exec #newf a

class B &lt; A
  def f
    print &quot;newf &quot;
  end
end

b = B.new
b.exec #newf a
</code></pre>

<p>そのため、一部の関数をモックやスタブにし、正しく呼び出されているかを検証したり、<br />
その機能以外のところがちゃんと動いているかを検証するのが簡単にできます。</p>

<h2 id="goで関数の差し替え:fbc8528214e49b0085aa07c0c8b68dfd">goで関数の差し替え</h2>

<h3 id="埋め込みによる差し替え-できない:fbc8528214e49b0085aa07c0c8b68dfd">埋め込みによる差し替え（できない）</h3>

<p>golangでは既存の構造体に関数を再定義することはできません。<br />
また、以下のrubyコードのように埋め込んだ後に関数を再定義しても、<br />
継承前の関数を読んでいる部分を差し替えることはできません。</p>

<p>そのため、rubyの2番目の例のような以下のコードでは、<br />
<code>b.Exec</code>はAの関数fを呼び出してしまうため、動きを差し替えられません。</p>

<pre><code class="language-go">package main

import (
	&quot;fmt&quot;
)

type A struct {
}

func (a *A) Exec() {
	a.f()
	a.a()
}

func (a *A) f() {
	fmt.Print(&quot;f &quot;)
}

func (a *A) a() {
	fmt.Print(&quot;a\n&quot;)
}

type B struct {
	*A
}

func (a *B) f() {
	fmt.Print(&quot;newf &quot;)
}

func main() {
	a := &amp;A{}
	a.Exec() // f a

	b := &amp;B{
		A: a,
	}
	b.Exec() // f a (not &quot;newf a&quot;)
}
</code></pre>

<h3 id="インターフェースを利用する:fbc8528214e49b0085aa07c0c8b68dfd">インターフェースを利用する</h3>

<p>golangにはインターフェースが合っていれば何でも代入できるため、<br />
インターフェースを呼び出すように実装し、わたす構造体を変えることで、<br />
関数の差し替えをすることができるようになります。</p>

<p>以下の例では計算用のCalcというインタフェースを定義し、<br />
実際に計算を行うSumAddと、固定の値を返したり渡された値を見えるようにしたSumTestを用意しています。<br />
SmuTestを利用することで、呼び出し側のAのロジックが正しいかを検証できるようになっています。</p>

<pre><code class="language-go">package main

import (
	&quot;fmt&quot;
)

type A struct {
  calc Calc
  list []int
}

func (a *A) F(ratio float64) float64 {
  s := a.calc.sum(a.list)
  return float64(s) * ratio
}

type Calc interface {
  sum(l []int) int
}

type SumAdd struct{
}

func (s *SumAdd) sum(l []int) int {
  sum := 0
  for _, i := range l {
    sum += i
  }
  return sum
}

type SumTest struct {
  Nums []int
}

func (s *SumTest) sum(l []int) int {
  s.Nums = l
  return 15
}

func main() {
  s := &amp;SumAdd{}
  l := []int{1,2,3,4,5}

  a := &amp;A{
    calc: s,
    list: l,
  }
  fmt.Println(a.F(3.0))

  t := &amp;SumTest{}
  testA := &amp;A{
    calc: t,
    list: l,
  }

  ret := testA.F(3.0)
  fmt.Println(ret == 45)
  fmt.Println(len(t.Nums) == 5)
}
</code></pre>

<h2 id="まとめ:fbc8528214e49b0085aa07c0c8b68dfd">まとめ</h2>

<p>golangではインタフェースを利用して挙動を変えることで、部分的にテストができます。<br />
ただし、設計時にどこをインターフェースにするかを考えて作らないと、上手く差し替えができません。</p>

<p>つまり、rubyは適当に作ったテストしにくい設計でも無理矢理テストできますが、<br />
golangはテストしやすい設計を考えてから作る必要があるようです。</p>

<h1 id="bpstudy-92に参加した:fbc8528214e49b0085aa07c0c8b68dfd">BPStudy#92に参加した</h1>

<p><a href="blog/2015/04/29/bpstudy92/">参加記録 BPStudy#92</a>
お金の話でした。<br />
経営や簿記は全く本業ではないのですが、自分が生きてる世界を構成する重要な要素なので、<br />
知っておいた方が良いと思いました。</p>

<h1 id="mongodbについて調べていた:fbc8528214e49b0085aa07c0c8b68dfd">mongodbについて調べていた</h1>

<h2 id="一定時間後にデータが消える設定:fbc8528214e49b0085aa07c0c8b68dfd">一定時間後にデータが消える設定</h2>

<p>容量節約のため、一定期間後のデータは消えるようにしたいなーと思っていたところ、<br />
時間の入っているキーに対してexpireAfterSecondsのついたTTL(time to live)インデックスを作ることで、<br />
指定時刻経過後に消されるようにできるみたいです。<br />
<a href="http://docs.mongodb.org/manual/tutorial/expire-data/">Expire Data from Collections by Setting TTL</a><br />
また、このインデックスはそのまま時刻付きのインデックスとしても利用できるそうです。</p>

<h2 id="指定した期間のデータをdumpする:fbc8528214e49b0085aa07c0c8b68dfd">指定した期間のデータをdumpする</h2>

<p>mongodumpでは-qオプションでクエリを指定できるため、<br />
そこで時刻を指定することで指定した期間のデータをdumpできます。</p>

<p>ただし、どうやらISODateはコマンドラインからは上手く動かないらしく、<br />
Dateオブジェクトを利用してミリ秒で指定する必要があるようです。</p>

<pre><code class="language-bash">mongodump --host localhost --db testdb -q \&quot;{time : { \\$gte :  new Date(1430000000000), \\$lt :  new Date(1440000000000) } }\&quot; -o dump/2015-05-04
</code></pre>

                </div>

            </div>

            

<div class="social_buttons">
    
    <span class="twitter">
        <a href="https://twitter.com/share" class="twitter-share-button" data-via="ota42y">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
    </span>
    

    
    <span class="hatena">
        <a href="http://ota42y.com/pages/summary/2015/week-18/" class="hatena-bookmark-button"
           data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="ja"
           title="このエントリーをはてなブックマークに追加">
            <img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png"
                 alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" />
        </a>
        <script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js"
                charset="utf-8" async="async">
        </script>
    </span>
    
</div>

        </div>
    </div>
    <div class="footer_height"></div>


<div class="footer_margin"></div>
<div class="footer_wrapper footer_height">
    <div class="content">
        <div class="footer">
            Copyright © 2015 - ota42y
        </div>
    </div>
</div>
</div>
</body>
</html>

