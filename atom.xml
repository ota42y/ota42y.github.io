<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[おおたの物置]]></title>
  <link href="http://ota42y.com/atom.xml" rel="self"/>
  <link href="http://ota42y.com/"/>
  <updated>2014-12-19T07:56:34+09:00</updated>
  <id>http://ota42y.com/</id>
  <author>
    <name><![CDATA[ota42y]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[GoのORマッパーGORMが便利]]></title>
    <link href="http://ota42y.com/blog/2014/12/19/gorm/"/>
    <updated>2014-12-19T07:40:11+09:00</updated>
    <id>http://ota42y.com/blog/2014/12/19/gorm</id>
    <content type="html"><![CDATA[<p>golangではmysqldriverでmysqlにアクセスできますが、<br/>
一つ一つ構造体に入れないといけなかったりと、けっこう辛いものがあります。<br/>
<a href="http://ota42y.com/blog/2014/10/04/go-mysql/">goでmysqlを使う</a></p>

<p>そこでいろいろ探していたところ、<br/>
ActiveRecordのように構造体を使ってDBにアクセスできるORMがありました。<br/>
<a href="https://github.com/jinzhu/gorm">https://github.com/jinzhu/gorm</a></p>

<p>自動でテーブル作ってくれたり、変更してくれたりと、他のORマッパーよりかはActiveRecordっぽいです。<br/>
リレーションも勝手に貼ってくれるみたいです。<br/>
ただし、取り出すときは元のオブジェクト→リレーションのオブジェクトと、<br/>
順に取ってくる必要があり、自動でリレーション先のオブジェクトの取得はしてくれるわけではありません。<br/>
(使わない場合は無駄なアクセスになるので、正しいと言えば正しいですが)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="p">(</span>
</span><span class='line'><span class="s">&quot;fmt&quot;</span>
</span><span class='line'><span class="s">&quot;github.com/jinzhu/gorm&quot;</span>
</span><span class='line'><span class="nx">_</span> <span class="s">&quot;github.com/lib/pq&quot;</span>
</span><span class='line'><span class="nx">_</span> <span class="s">&quot;github.com/go-sql-driver/mysql&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">type</span> <span class="nx">User</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">Id</span>           <span class="kt">int64</span>
</span><span class='line'>  <span class="nx">Name</span>         <span class="kt">string</span>  <span class="s">`sql:&quot;size:255&quot;`</span>
</span><span class='line'>  <span class="nx">Emails</span>            <span class="p">[]</span><span class="nx">Email</span>         <span class="c1">// One-To-Many relationship (has many)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">type</span> <span class="nx">Email</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">Id</span>         <span class="kt">int64</span>
</span><span class='line'>  <span class="nx">UserId</span>     <span class="kt">int64</span>   <span class="c1">// Foreign key for User (belongs to)</span>
</span><span class='line'>  <span class="nx">Email</span>      <span class="kt">string</span>  <span class="s">`sql:&quot;type:varchar(100);&quot;`</span> <span class="c1">// Set field&#39;s type</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">(){</span>
</span><span class='line'>  <span class="nx">db</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">gorm</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="s">&quot;mysql&quot;</span><span class="p">,</span> <span class="s">&quot;root@/testdb?charset=utf8&amp;parseTime=True&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">db</span><span class="p">.</span><span class="nx">DB</span><span class="p">()</span>
</span><span class='line'>  <span class="nx">db</span><span class="p">.</span><span class="nx">AutoMigrate</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">Email</span><span class="p">{})</span>
</span><span class='line'>  <span class="nx">db</span><span class="p">.</span><span class="nx">AutoMigrate</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">User</span><span class="p">{})</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">user</span> <span class="o">:=</span> <span class="nx">User</span><span class="p">{</span>
</span><span class='line'>    <span class="nx">Name</span><span class="p">:</span>            <span class="s">&quot;ota42y&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">Emails</span><span class="p">:</span>          <span class="p">[]</span><span class="nx">Email</span><span class="p">{</span> <span class="p">{</span><span class="nx">Email</span><span class="p">:</span> <span class="s">&quot;ota42y@example.com&quot;</span><span class="p">},</span> <span class="p">{</span><span class="nx">Email</span><span class="p">:</span> <span class="s">&quot;ota42y@example@example.com&quot;</span><span class="p">}</span> <span class="p">},</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">db</span><span class="p">.</span><span class="nx">Create</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">user</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">me</span> <span class="nx">User</span>
</span><span class='line'>  <span class="nx">db</span><span class="p">.</span><span class="nx">Where</span><span class="p">(</span><span class="s">&quot;name = ?&quot;</span><span class="p">,</span> <span class="s">&quot;ota42y&quot;</span><span class="p">).</span><span class="nx">First</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">me</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">me</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">emails</span> <span class="p">[]</span><span class="nx">Email</span>
</span><span class='line'>  <span class="nx">db</span><span class="p">.</span><span class="nx">Model</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">me</span><span class="p">).</span><span class="nx">Related</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">emails</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">emails</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[golangでYAMLファイルを読み込んで構造体に入れる]]></title>
    <link href="http://ota42y.com/blog/2014/12/03/go-yaml-struct/"/>
    <updated>2014-12-03T07:46:50+09:00</updated>
    <id>http://ota42y.com/blog/2014/12/03/go-yaml-struct</id>
    <content type="html"><![CDATA[<p>使い方がかなり特殊だったのでメモ<br/>
(ドキュメントには書いてありますが…)</p>

<p>goyamlでは、YAMLの構造とGoの構造体の構造を揃えておくと、<br/>
データを構造体にセットした状態で読み込むことが出来ます。</p>

<p>特にGoでは構造体を使わない場合、<a href="http://ota42y.com/blog/2014/11/13/go-yaml/">interfaceへの変換を書きまくる事になる</a>ので、<br/>
できる限り構造体を利用した方がお勧めです。</p>

<p>以下のように、YAMLのキーとGoの構造体の名前を揃えることで、<br/>
YAMLから構造体に直接データを代入できます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">type</span> <span class="nx">Data</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">UserId</span>      <span class="kt">int</span>
</span><span class='line'>  <span class="nx">UserName</span>    <span class="kt">string</span> <span class="s">`yaml:&quot;user_name&quot;`</span>
</span><span class='line'>  <span class="nx">Follownum</span>   <span class="kt">int</span>    <span class="s">`yaml:&quot;followNum&quot;`</span>
</span><span class='line'>  <span class="nx">MessageText</span> <span class="kt">string</span>
</span><span class='line'>  <span class="nx">invaliddata</span> <span class="kt">string</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">userid</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">123</span>
</span><span class='line'><span class="l-Scalar-Plain">user_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name</span>
</span><span class='line'><span class="l-Scalar-Plain">followNum</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">42</span>
</span><span class='line'><span class="l-Scalar-Plain">messageText</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">text</span>
</span><span class='line'><span class="l-Scalar-Plain">invaliddata</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">data</span>
</span></code></pre></td></tr></table></div></figure>


<p>後述するコードでYAMLを読み込むと、出力は以下の通りになります、<br/>
<code>=&gt; {123 name 42  }</code></p>

<p>UserIdに123、UserNameにname、Follownumに42、<br/>
MessageTextとinvaliddataは空になっています。</p>

<h1>構造体とYAMLの対応付け仕様</h1>

<p>特に指定をしない場合、構造体の変数名に対応するキーと対応付けられます。<br/>
対応するキーは以下のような仕様になっているようです。</p>

<ul>
<li>指定が無い場合、変数名を全て小文字にしたYAMLのキーと対応付ける

<ul>
<li>UserIdはuseridと対応付けられます</li>
</ul>
</li>
<li>後述する方法で明示的な指定をしない限り、YAMLのキーは全て小文字のみ受け付けます

<ul>
<li>messageTextはダメで、messagetextでないといけません</li>
</ul>
</li>
<li>構造体のメンバは大文字から始まる

<ul>
<li>そのため、invaliddataにはデータ入っていません</li>
<li>大文字から始まれば、途中が大文字でも大丈夫です

<ul>
<li>UserIdはuseridと対応付けられます</li>
</ul>
</li>
<li>途中を大文字にしても、全て小文字のキーを見に行きます

<ul>
<li>MessageTextはmessagetextと対応付けられます</li>
</ul>
</li>
</ul>
</li>
<li>明示的に対応を設定することもできる

<ul>
<li>UserNameをuser_nameと対応付けたり(通常はUser_Nameというメンバ変数にしないといけない)</li>
<li>Follownumの変数をfollowNumと対応付けるなど、上記の制限は無くなる</li>
</ul>
</li>
</ul>


<p>暗黙のルールが多いですが、それさえ理解すればかなり簡単に書くことができます。</p>

<h1>サンプルコード</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="p">(</span>
</span><span class='line'>  <span class="s">&quot;gopkg.in/yaml.v2&quot;</span>
</span><span class='line'>  <span class="s">&quot;io/ioutil&quot;</span>
</span><span class='line'>  <span class="s">&quot;fmt&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">type</span> <span class="nx">Data</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">UserId</span>      <span class="kt">int</span>
</span><span class='line'>  <span class="nx">UserName</span>    <span class="kt">string</span> <span class="s">`yaml:&quot;user_name&quot;`</span>
</span><span class='line'>  <span class="nx">Follownum</span>   <span class="kt">int</span>     <span class="s">`yaml:&quot;followNum&quot;`</span>
</span><span class='line'>  <span class="nx">MessageText</span> <span class="kt">string</span>
</span><span class='line'>  <span class="nx">invaliddata</span> <span class="kt">string</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">buf</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nx">ReadFile</span><span class="p">(</span><span class="s">&quot;test.yml&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>    <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">d</span> <span class="nx">Data</span>
</span><span class='line'>  <span class="nx">err</span> <span class="p">=</span> <span class="nx">yaml</span><span class="p">.</span><span class="nx">Unmarshal</span><span class="p">(</span><span class="nx">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">d</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[参加記録 Go Conference 2014 autumn]]></title>
    <link href="http://ota42y.com/blog/2014/12/01/gocon-2014-autumn/"/>
    <updated>2014-12-01T07:42:00+09:00</updated>
    <id>http://ota42y.com/blog/2014/12/01/gocon-2014-autumn</id>
    <content type="html"><![CDATA[<p><a href="http://gocon.connpass.com/event/9748/">Go Conference 2014 autumn</a>に参加しました。<br/>
<a href="http://togetter.com/li/751700">togetterまとめ</a><br/>
大体スライドが公開されているので、正確な内容はそちらをどうぞ。</p>

<h1>まとめ</h1>

<ul>
<li>Go言語のシンプルさへのこだわりが凄い</li>
<li>開発陣の徳の高さが凄い

<ul>
<li>難しい部分は俺らに任せておけ！的な</li>
</ul>
</li>
<li>明日から使えるGo言語的な情報が盛りだくさん

<ul>
<li>エラーを<em>で無視して済みません…(´･</em>･`)</li>
</ul>
</li>
<li>椅子が痛い

<ul>
<li>1時間半じゃなくて、1時間ごとぐらいに休憩を挟んでほしかったです…</li>
</ul>
</li>
<li>英語頑張ろう

<ul>
<li>日本語スライドありがたや…</li>
</ul>
</li>
</ul>


<h1>Keynote1: Rob Pike (@rob_pike) (45min)</h1>

<p>スライドは未公開？</p>

<p>Go言語の設計者<a href="http://ja.wikipedia.org/wiki/%E3%83%AD%E3%83%96%E3%83%BB%E3%83%91%E3%82%A4%E3%82%AF">ロブ・パイク</a>さんのGo言語の思想とかについての話です。</p>

<p>Go言語がいかに単純さ(≒簡潔さ)を重要視しているかについてとても示唆のある話をしていただけました。<br/>
他の言語が相互に機能を取り込み、ほぼ同じ機能を持つように進化していっているのに対し、<br/>
Goは1.0の時点で言語の機能を固定し、機能をとても少なく持つようにしたそうです。<br/>
書く楽しさはなくなるけど、代わりに保守のしやすさを選んだとのことです。</p>

<p>プレゼンの中で特にハッとさせられたのは、単純なコードと簡潔なコードとは異なるということです。<br/>
言語の機能を使って、数行程度でいろんな事に対応しようとすると、コードの量自体は少なくて済みますが、<br/>
必要とする前提知識が増え、かつその数行を完全に理解するのにとても時間がかかります。<br/>
おそらく、適当な言語のワンライナーを理解するのに必要な知識と時間を想像すれば大体わかると思います。</p>

<p>簡潔な記述でも理解するのが大変な複雑な事ができるため、<br/>
簡潔なコード≠単純なコードと言えるのかなと思いました。</p>

<p>また、Goではコード側ができる限り簡単になるように、<br/>
複雑な事を可能な限り言語側で隠蔽しているとも言われていました。<br/>
実際、GoのGCや並行処理、パッケージなどは設計や実装自体は凄く複雑にも関わらず、<br/>
使う側からはそれほど大変さを感じることなく使えます。</p>

<p>ここ（複雑な部分）は俺にまかせろーといった感じで、開発者の方々には頭が下がります…</p>

<h1>Keynote2: Goに入ってはGoに従え @fumitoshi_ukai (45min)</h1>

<p><a href="http://ukai-go-talks.appspot.com/2014/gocon.slide#1">資料</a></p>

<p>Google社内でGo Readability Approverをされている@fumitoshi_ukaiさんの発表です。</p>

<p>Go言語らしく書くにはどうすればいいのか？といった思想的な部分と、<br/>
ダメな例と良い例を挙げてひたすら赤ペン先生をする発表でした。</p>

<p>これがGo言語のやり方か！となりっぱなしで、まさに明日から使えるGo言語といった感じなので、<br/>
是非ともスライドが公開されるといいなーと思います。</p>

<h1>LT1</h1>

<h2>Gardener &amp; Go</h2>

<p><a href="https://docs.google.com/presentation/d/1cPtFXGVgWcjG7qpwNz7jLbMh9BUW13dM_n1-ls-2u0s/edit#slide=id.p">資料</a></p>

<p>@nuki_ponさんが某位置情報ゲームの色をした、GoCon Tシャツを作ってくださったそうです。<br/>
<a href="http://ec-mail.freegufo.com/items/910014">GoCon 2014 Autumn Tシャツ | FreeGufo メール便対</a></p>

<h1>セッション</h1>

<h2>App Engine for Golang Performance</h2>

<p><a href="http://sinmetal-slide.appspot.com/2014/gocon1130/gaego.slide#1">資料</a></p>

<p>@sinmetalさんのGAEとMVM上でのGoとJavaの速度比較です。<br/>
Goは基本的に倍ぐらい速く、JavaはJavaらしくJVMの起動に時間がかかるといった結果みたいです。</p>

<h2>Golang @ISUCON</h2>

<p><a href="https://speakerdeck.com/ymatsuwitter/golang-at-isucon">資料</a></p>

<p>@y_matsuwitterさんのISUCONでGo言語を使った話です。<br/>
ISUCONでやった、Go言語の様々な効率化についてまとめられていました。</p>

<p>話を聞くとかなり複雑な事をしているようですが、スライドのコードだととても簡単そうで凄いです。</p>

<h2>mackerel-agent 徹底解説</h2>

<p><a href="http://songmu.github.io/slides/gocon2014-autumn/#0">資料</a></p>

<p>@Songmuさんによる、mackerel-agentのソースコード解説です。<br/>
NewRelicっぽいサービスですが、OSSな分色々出来そうで夢が広がる感じです。</p>

<h2>Why my Go program is slow?</h2>

<p><a href="http://www.slideshare.net/InadaNaoki/gocon2014-pprof">資料</a></p>

<p>@methaneさんによるCPUプロファイリングについての発表です。<br/>
アセンブラまで出してくれるpprofの凄さをひしひしと感じます…</p>

<p>また、Goでは他の関数呼び出しのない末端の関数をインライン展開してくれるので、<br/>
関数に分けると早かったり、<br/>
関数呼び出しで呼び出し側が使っているレジスタを全部待避するので、<br/>
呼び出された側が使った分だけ待避する？Cよりも関数呼び出しは遅いなど、<br/>
Goの速度についてしっかりと説明されています。</p>

<h2>Golang JP Community</h2>

<p><a href="https://docs.google.com/presentation/d/1UTi4uqt4sOrQ1dHJE0y8UB9BR9iqDK7dLP57QAfrOX4/pub?start=false&amp;loop=false&amp;delayms=3000&amp;slide=id.g4f1d3881c_00">資料</a><br/>
<a href="https://www.youtube.com/watch?v=LJvEIjRBSDA">資料２</a></p>

<p>@qt_luigiさんの日本のGo言語コミュニティの話でした。<br/>
いくつか知っているものもありましたが、思った以上に大量にあって驚きました…</p>

<h2>(タイトルメモり損ねました…GengoでGoの利用事例なお話)</h2>

<p>PHPのAPIをGoに置き換えていったら、500msが10msになったというお話です。<br/>
クリティカルな所ではなく影響の少ないところから、<br/>
一気にではなく少しずつ置き換えていくといいそうです。</p>

<p>Goで作られたデプロイツールが便利そうでした。<br/>
<a href="https://github.com/gengo/goship">https://github.com/gengo/goship</a></p>

<h2>NSQ-Centric Architecture</h2>

<p><a href="http://www.slideshare.net/guregu/nsqcentric-architecture-gocon-autumn-2014">資料</a></p>

<p><a href="https://github.com/guregu">gureguさん</a>のNSQの話です。</p>

<p>bit.lyが作ったGo製のメッセージキューである<a href="https://github.com/bitly/nsq">NSQ</a>を使って、<br/>
チャットアプリを作った発表でした。</p>

<h2>(Go言語のコンパイラをハックした話)</h2>

<p><a href="http://moriyoshi.hatenablog.com/entry/2014/06/03/121728">参考資料</a></p>

<p>@moriyoshitさんがGo言語で寿司関数を作りたいがために？w　Goのコンパイラをハックしたのと、<br/>
コンパイラの中についてのお話でした。</p>

<p>教科書通りのコンパイラの作りしてるんだなーという印象でした。<br/>
魔境と噂のGCCとかはどうなってるんだろう…と思いました。</p>

<h1>LT</h1>

<h2>nginx-build</h2>

<p><a href="https://speakerdeck.com/cubicdaiya/nginx-build">https://speakerdeck.com/cubicdaiya/nginx-build</a><br/>
NginxをビルドするためのツールのDLと、ビルドをやってくれるツールを書いたそうです。<br/>
バイナリ単体で配布できますし、こういう用途には便利そうな感じ…</p>

<h2>(楽天でTerraformを使てる話)</h2>

<p>AWSとかのインスタンスをコードから立ち上げられるTerraformを利用して、<br/>
楽天社内でinfrastructure as codeを進めている話です。</p>

<h2>ビルドパイプラインツールをGoで作った話</h2>

<p><a href="https://speakerdeck.com/ainoya/birudopaipurainturuwogodezuo-tutahua">資料</a></p>

<p>個人的にはJenkinsでビルドパイプラインっぽいのを作るのには、<br/>
いろんな点からうんざりしていたので、なんか凄い便利そうで気になります！　　
似たようなのを作ろうと画策していたので、先を越された感はありますが…</p>

<h2>go/parser, go/astの話</h2>

<p><a href="http://yuroyoro.net/gocon_2014_autumn_lt/#/">資料</a></p>

<p>Goの抽象構文木を生成する標準パッケージの紹介と、可視化するツールを作ったお話です。<br/>
Goの<a href="http://ja.wikipedia.org/wiki/Lint">lint</a>ではここで紹介した技術を使って実装しているらしいです。</p>

<h2>Unit-testing programs depend on I/O in Go</h2>

<p><a href="https://yuya-takeyama.github.io/presentations/2014/11/30/gocon_2014_autumn/">資料</a></p>

<p>表題の通り、I/Oに依存したテストについてのお話です。<br/>
Keynote2の@fumitoshi_ukaiさんも言っていたように、<br/>
データを読み書きするだけでファイルとしての挙動が不要な場合は、<br/>
<code>os.File</code>ではなく<code>io.Reader</code>や<code>io.Writer</code>を使うと、ファイル以外の引数も与えられるため、<br/>
汎用性が上がり、テストもしやすいそうです。</p>

<h2>(consul.ioの話)</h2>

<p><a href="https://consul.io/">https://consul.io/</a>を使うと、色々はかどるらしいが…<br/>
ごめんなさい理解できてないです(´･_･`)</p>

<h2>Togetterまとめ</h2>

<p>Togetterは遙か彼方の地から遠隔で@yukotanさんがまとめてくれたそうです。<br/>
振り返る際にとてもお世話になったので、感謝の限りです。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Octopressのアップデート手順]]></title>
    <link href="http://ota42y.com/blog/2014/11/30/octopress-update/"/>
    <updated>2014-11-30T07:50:22+09:00</updated>
    <id>http://ota42y.com/blog/2014/11/30/octopress-update</id>
    <content type="html"><![CDATA[<p>見た目は変わっていませんが、このブログのOctopressをアップデートしました。<br/>
だいぶ前のOctopressをforkして、このブログ用の変更をコミットしていったため、<br/>
forkして手を加えたリポジトリにfork元の修正を取り入れる事になったので、やりかたをメモしておきます。</p>

<h1>ブログ用リポジトリの状態</h1>

<p>このブログは現在Github Pagesで運用しており、リポジトリはこちらになります。<br/>
<a href="https://github.com/ota42y/ota42y.github.io">https://github.com/ota42y/ota42y.github.io</a></p>

<p>ですが、これはOctopressの出力先のリポジトリであり、<br/>
bitbucket上にOctopress自体のリポジトリが存在します。<br/>
このリポジトリはだいぶ前のOctopressをベースに、このブログ用の修正や記事をコミットしていました。</p>

<h1>Octopressのアップデート</h1>

<p>普段はOctopress側のリポジトリは使わないため、remoteからも削除してあるのでそれを入れます。<br/>
その後、Octopress側のmasterとマージをするだけになります。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git remote add octopress git@github.com:imathis/octopress.git
</span><span class='line'>git fetch octopress
</span><span class='line'>git merge octopress/master</span></code></pre></td></tr></table></div></figure>


<p>その後、bundle installすれば終了…のはずでしたが、1つ落とし穴がありました。<br/>
Jekyllがアップデートされたため、日付を出力するdate_time_htmlが変更されていました。<br/>
<a href="https://github.com/imathis/octopress/pull/1643/files">https://github.com/imathis/octopress/pull/1643/files</a><br/>
そのため、これを直すことで、無事アップデートは終了になりました。</p>

<p>date_time_htmlが無くなったことはすぐに発見できましたが、<br/>
このメソッドを持っていたオブジェクトが何なのかの発見に手間取り、結構時間がかかりました。<br/>
Rubyの特徴上、変数にあらゆるオブジェクトが入る事があるため仕方ないのですが、<br/>
その変数が何のオブジェクトなのかを簡単に調べる方法がほしいですね…</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[参加記録 BPStudy ♯87]]></title>
    <link href="http://ota42y.com/blog/2014/11/29/bpstudy-87/"/>
    <updated>2014-11-29T17:17:19+09:00</updated>
    <id>http://ota42y.com/blog/2014/11/29/bpstudy-87</id>
    <content type="html"><![CDATA[<p><a href="http://bpstudy.connpass.com/event/9741/">BPStudy#87</a>に参加しました。<br/>
<a href="http://togetter.com/li/751302">togetterまとめ</a></p>

<h1>じっくりと把握する iOS8 / iPhone6 最前線〜ユーザーにとって、開発者にとって何が変わったのか？</h1>

<p><a href="http://www.slideshare.net/yukio.andoh/bpstudy-87-ios8-iphone6">http://www.slideshare.net/yukio.andoh/bpstudy-87-ios8-iphone6</a></p>

<p>iOS8とiPhone6の新機能まとめと、それによって生じる問題紹介でした。</p>

<p>スライド46ページ目の親指の可動範囲の図を見せられると一目瞭然ですが、<br/>
画面サイズが大きくなったことによるタッチ領域の変化はとても激しく、<br/>
iPhone6や6+では従来のUIはかなり使いづらいものになってしまいます。</p>

<p>あと、リモートで任意の端末をレンタルできるRemote TestKitが凄い便利そうでした。<br/>
<a href="http://appkitbox.com/testkit/">Remote TestKit</a></p>

<h1>iPhone 6がリリースされて2ヶ月が過ぎました　〜iOSの分断化時代を乗り切ろう〜</h1>

<p><a href="http://www.slideshare.net/masashiono1/bpstudy-87">http://www.slideshare.net/masashiono1/bpstudy-87</a><br/>
<a href="https://github.com/akisute/AutoLayoutTest">akisute/AutoLayoutTest</a></p>

<p>前半のスワイプUIのススメは、前の発表のiPhone6や6+向けのUIの回答として、<br/>
かなり良い回答ではないかなと思いました。<br/>
あと後半のSwiftのまとめが、Swiftの闇をひしひしと感じる内容で凄いです…<em>(:3 」∠)</em></p>

<h1>LT</h1>

<p>一件目はiOS7と8で遭遇したブラウザバグの紹介でした。<br/>
<a href="http://slides.com/monjudoh/ios_browser_bugs">資料</a></p>

<p>画像を範囲指定で切り抜くと何故か指定したサイズより大きくなるとか、<br/>
同時接続数が2個になったが、レスポンスの受信時間がかぶるとクラッシュするので同時接続してはいけないとか、<br/>
かなり辛い感じのバグが多かったです…</p>

<p>二件目ではペアプロ合コンに参加した人が、相手側の女性の手によって公開処刑される様子を見物していました…<br/>
恐ろしい…(((;ﾟДﾟ)))ｶﾞｸﾌﾞﾙｶﾞｸﾌﾞﾙ</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Jenkinsのbuild flow pluginを使うとjobの設定管理が少し楽になる]]></title>
    <link href="http://ota42y.com/blog/2014/11/27/jenkins-build-flow-plugin/"/>
    <updated>2014-11-27T07:44:41+09:00</updated>
    <id>http://ota42y.com/blog/2014/11/27/jenkins-build-flow-plugin</id>
    <content type="html"><![CDATA[<h1>まとめ</h1>

<ul>
<li>Jenkinsのjobの設定管理はリポジトリのバージョンと揃えないと行けないため面倒</li>
<li>全てをスクリプトで実行するのが理想だが、本体の機能を使いたい場合は対応できない</li>
<li>build flow pluginがファイルを読み込んで実行できるようになった</li>
<li>これにより、Jenkinsのjobを呼び出すスクリプトをリポジトリ内に入れてバージョン管理出来る</li>
</ul>


<h1>Jenkinsのjob設定問題</h1>

<p>Jenkinsの大きな問題の一つは、Jenkinsのjob設定をどう管理するかだと思います。</p>

<p>例えばビルド手順を変更する場合、プラグイン設定に後方互換性がないような変更を行うと、<br/>
前のバージョンをビルドしたときにエラーになります。</p>

<p>このような場合、通常は最新の変更を取り込む事で解決しますが、<br/>
コードフリーズ中のリリースブランチのように、最新の変更を取り込めない場合はこの方法で解決できません。</p>

<p>このような場合、二通りの解決方法が存在します。</p>

<h2>全部スクリプトで処理する方法</h2>

<p>一つ目が全部スクリプトでやってしまう方法です。<br/>
Jenkinsのjobからは単一のスクリプトだけを実行し、その中で全てを行います。</p>

<p>この方法はJenkinsを単なるcronとしてしか使わないため、<br/>
全部自分でやる必要がありますが自由度がとても高いのが特徴です。</p>

<p>ですがこの方法では、プラグインや下流jobとの連携、特定の処理だけ別ノードで実行するなど、<br/>
Jenkinsの機能が使えなくなります。</p>

<h2>新しいJobを作っていく方法</h2>

<p>これに対し、jobの変更管理を諦め、どんどん新しいjobを作ってく方法があります。<br/>
Jenkinsはjobのコピーが容易なため、後方互換性のない変更を加える段階で新しいjobに切り替え、<br/>
以降はそちらでビルドし、過去のバージョン用のビルドが必要なときには残してある前のjobを実行します。</p>

<p>この方法の場合、Jenkinsの機能を利用しつつ、複数のビルド設定を同時に扱うことが出来ますが、<br/>
どのバージョンでどのjobを動かせばいいかを保存しておけないため、jobが増えていくと問題になります。</p>

<p>これに対し、build flow pluginを使う事で、どのjobでビルドするかといった情報を、<br/>
リポジトリ内に入れてバージョン管理することが出来ます。</p>

<h1>build flow pluginでjobの関係をリポジトリに入れる</h1>

<p>Jenkinsのbuild flow pluginでは、複数のjobをスクリプトから実行することが出来ます。<br/>
<a href="https://wiki.jenkins-ci.org/display/JENKINS/Build+Flow+Plugin">Build Flow Plugin</a></p>

<p>具体的には以下のように書くことで、job1が成功したらjob2を実行するといったことが出来ます。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// 失敗から成功に変わったか判定
</span><span class='line'>def isFixedBuild(result){
</span><span class='line'>  prev = build.previousBuild
</span><span class='line'>  return prev.result != SUCCESS && result == SUCCESS
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>// job1を実行
</span><span class='line'>b = build("job1")
</span><span class='line'>// job1のログを出力する
</span><span class='line'>out.println b.getLog()
</span><span class='line'>
</span><span class='line'>if(b.result == SUCCESS){
</span><span class='line'>  // job1が成功していたらjob2を実行
</span><span class='line'>  b = build("job2")
</span><span class='line'>
</span><span class='line'>  if (isFixedBuild(b.result)){
</span><span class='line'>    out.println "fixed"
</span><span class='line'>  }else{
</span><span class='line'>    out.println "success"
</span><span class='line'>  }
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>このbuild flow pluginですが、最近の変更でリポジトリ内のファイルを実行することができるようになりました。<br/>
そのため、メインのjobがリポジトリ内のスクリプトを読み込んで、ビルド用のjobを呼び出すように構築することで、<br/>
二つ目の新しいjobを作っていく方法の問題点だった、リポジトリのバージョンとjobの対応付けが解決します。</p>

<p>残念ながら、job自体の設定は管理出来ないため、設定を変更したい場合はjobを増やしていく必要がありますが、<br/>
呼び出しはスクリプトから行うため、ビルドの実行自体はスクリプトを呼ぶだけで済みます。</p>

<p>これは一つ目の全てをスクリプトで行う方法と同じく、リポジトリ内のgroovyファイルを実行する方法になりますが、<br/>
Jenkinsのjobをスクリプト内から呼び出せるため、プラグインといったJenkinsの機能を利用できる利点があります。</p>

<p>ただし、別のjobに別れてしまうため、<br/>
実行時に設定したパラメーターなどは、呼び出すjob側に一つ一つ明示的に渡す必要があったり、<br/>
ファイルの受け渡しを成果物とCopy Artifact Pluginを利用して行う必要があるなど、<br/>
job間のデータの受け渡しが面倒になるという問題が生じますので注意が必要です。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Dockerとは何か]]></title>
    <link href="http://ota42y.com/blog/2014/11/26/docker/"/>
    <updated>2014-11-26T07:33:43+09:00</updated>
    <id>http://ota42y.com/blog/2014/11/26/docker</id>
    <content type="html"><![CDATA[<p>Dockerについて調べたので概要と簡単な使い方のメモ</p>

<h1>Dockerとは何か</h1>

<p>いわゆるコンテナ型仮想化ツールの1つです。<br/>
VMwareやKVMのような完全仮想化と違い、<br/>
ユーザや、ネットワーク、ファイルシステムなどを隔離した環境を作ってそこで動くらしいです。</p>

<p>あくまで隔離された環境のため、環境ごと作る完全仮想化に比べてオーバーヘッドが少なく、<br/>
手元の数年前のmac book airでもかなり快適に動いています。</p>

<p>あくまでゲストOSを隔離環境に置いただけのため 、<br/>
ファイルシステムは分離されておらず、ホストからは中身が見えるのも特徴らしいです。<br/>
(ゲストからはホストの中身は当然見えない)</p>

<p>また、DockerではDockerfileというファイルに設定を書くことで、<br/>
その設定を反映した状態のコンテナを作成することが出来ます。<br/>
そのため、OSの状態をDockerfileとして管理でき、いわゆるimmutable infrastructureと相性がいいみたいです。</p>

<h1>Docker上のCent OSにJenkinsを立てる</h1>

<h2>Dockerの起動</h2>

<p>Dockerコマンドを実行するためには、Macだとboot2dockerを<br/>
<code>boot2docker start</code>で起動し、そのとき提示された環境変数を設定する必要があります。</p>

<p>また、<br/>
<code>boot2docker ip</code><br/>
を実行し、コンテナに対してアクセスできるようにする必要があります。<br/>
なお、この時出たURLは後で使います。</p>

<h2>Cent OSの構築</h2>

<h3>Dockerfileの準備</h3>

<p>以下のファイルをDockerfileという名前で適当なディレクトリに保存します。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>FROM centos:centos6
</span><span class='line'>
</span><span class='line'>RUN curl -o /etc/yum.repos.d/jenkins.repo http://pkg.jenkins-ci.org/redhat/jenkins.repo
</span><span class='line'>RUN rpm --import http://pkg.jenkins-ci.org/redhat/jenkins-ci.org.key
</span><span class='line'>RUN yum -y install java-1.7.0-openjdk jenkins</span></code></pre></td></tr></table></div></figure>


<p>見ての通り、Jenkins公式の入れ方のコマンドを実行しているだけです。</p>

<h3>コンテナの作成</h3>

<p>次に、Dockerfileを保存したディレクトリで<br/>
<code>docker build -t jenkins .</code>
を実行し、カレントディレクトリのDockerfileを使って、jenkinsというタグをつけてコンテナを作成させます。</p>

<h3>コンテナの起動</h3>

<p><code>docker run -p 8080:8080 -i -t jenkins bash</code><br/>
を実行してホストの8080とコンテナの8080を結びつけ、先ほど作ったjenkinsコンテナにbashで入り、<br/>
<code>service jenkins start</code><br/>
を実行するとjenkinsが起動します。</p>

<p>この状態で、<code>boot2docker ip</code>で出てきたURLの8080ポートにブラウザでアクセスすると、<br/>
いつものJenkins画面が表示されます。</p>

<h1>その他</h1>

<p>Dockerには他にも、VMのスナップショットのように作成したOSのイメージを保存しておき、<br/>
それを他のセットアップの下地にするといったことも出来るそうです。</p>

<p>また、Dockerはフォアグラウンドのプロセスがないと自動的に終了するため、<br/>
Jenkinsの用にサービスとして動かすものは、ログインして起動するか特別な方法で落とさない工夫が要るみたいです。<br/>
今回はとりあえずさわりだけなので、手で起動してログインしっぱなしにしています。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[YAMLでnilをキーにしたハッシュを扱う]]></title>
    <link href="http://ota42y.com/blog/2014/11/25/ruby-hash/"/>
    <updated>2014-11-25T07:55:14+09:00</updated>
    <id>http://ota42y.com/blog/2014/11/25/ruby-hash</id>
    <content type="html"><![CDATA[<p><em>例は全てRuby 2.0を利用しています</em></p>

<p>nilをキーとした値を持つハッシュをYAMLに書きたい場合、<br/>
以下のように書いても&#8221;nil&#8221;という文字列として認識されます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="l-Scalar-Plain">nil</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nil</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>=&gt; {"nil"=&gt;"nil"}</code></p>

<p>データがnilの場合は、データ部分に何も書かないことでnilを表現できます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="l-Scalar-Plain">datanil</span> <span class="p-Indicator">:</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>=&gt; {"datanil"=&gt;nil}</code></p>

<p>キーをnilにしたい場合、以下のように書いても、(Rubyだと)パースに失敗します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'>  <span class="p-Indicator">:</span> <span class="s">&quot;key</span><span class="nv"> </span><span class="s">nil&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>このような場合もYAMLの仕様では想定済みらしく、<br/>
クエッションマークを使うことで、その後ろにあるものがキーであると明示できる仕様があります。<br/>
<a href="http://yaml.org/spec/1.2/spec.html#id2772075">http://yaml.org/spec/1.2/spec.html#id2772075</a></p>

<p>これを利用して、以下のようにクエッションマークの後に何も書かず、<br/>
その後コロンと値を設定することで、nilをキーとして設定できます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="p-Indicator">?</span>
</span><span class='line'><span class="p-Indicator">:</span> <span class="s">&quot;key</span><span class="nv"> </span><span class="s">nil&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>rubyで長い文字列をキーにする</h2>

<p>Rubyが利用しているPsychでは、以下のように128byte以上のデータをキーにして書き出した場合、<br/>
?マークをつけて書き出します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;yaml&#39;</span>
</span><span class='line'><span class="k">def</span> <span class="nf">mkhash</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
</span><span class='line'>  <span class="n">h</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>  <span class="n">h</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="n">v</span>
</span><span class='line'>  <span class="n">h</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">long</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">129</span>
</span><span class='line'><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;long.yml&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="p">{</span><span class="o">|</span><span class="n">file</span><span class="o">|</span>
</span><span class='line'>  <span class="n">file</span><span class="o">.</span><span class="n">write</span> <span class="no">YAML</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">mkhash</span><span class="p">(</span><span class="n">long</span><span class="p">,</span> <span class="s2">&quot;long&quot;</span><span class="p">))</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="p-Indicator">?</span> <span class="l-Scalar-Plain">aaaaaaaaaaaaaaaaaaaaaaaaaa...aaa</span>
</span><span class='line'><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">long</span>
</span></code></pre></td></tr></table></div></figure>


<p>どうやらRubyが使っているYAMLライブラリのPsych内で、<br/>
128文字以上だったら?マークを出力するようにしているみたいです。</p>

<p><a href="https://github.com/tenderlove/psych/blob/7e7ccf6fa4ee084c673d5a52888e2e18a41bfb5b/ext/psych/yaml/emitter.c#L816">https://github.com/tenderlove/psych/blob/7e7ccf6fa4ee084c673d5a52888e2e18a41bfb5b/ext/psych/yaml/emitter.c#L816</a>
<a href="https://github.com/tenderlove/psych/blob/7e7ccf6fa4ee084c673d5a52888e2e18a41bfb5b/ext/psych/yaml/emitter.c#L1168">https://github.com/tenderlove/psych/blob/7e7ccf6fa4ee084c673d5a52888e2e18a41bfb5b/ext/psych/yaml/emitter.c#L1168</a></p>

<p>一応YAMLの仕様としては1024文字までは?を使わなくてもいいらしいですが、何故128byteで切ってるのかは謎です。
<a href="http://yaml.org/spec/1.2/spec.html#id2792501">http://yaml.org/spec/1.2/spec.html#id2792501</a></p>

<p>なお読み込む際は、クエッションマークをつけずに128byte以上のキーを指定しても問題なく読み込めます。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Github Pagesの新しいIPアドレス対応]]></title>
    <link href="http://ota42y.com/blog/2014/11/20/github-pages-new-ip/"/>
    <updated>2014-11-20T07:54:24+09:00</updated>
    <id>http://ota42y.com/blog/2014/11/20/github-pages-new-ip</id>
    <content type="html"><![CDATA[<p>これまでGithub Pagesで独自ドメインを運用していましたが、9月ぐらいから記事のアップロードのたびに、<br/>
新しいIDアドレスを利用するようにとのwarningが来るようになりました。</p>

<p>そのときに解消方法を調べたのですが、よくわからず放置していたところ、<br/>
12月から新しいアドレスに設定にしないと使えなくなるらしいので慌ててアップデートしました。</p>

<blockquote class="twitter-tweet" data-cards="hidden" lang="ja"><p>GitHub Pagesの旧IPアドレスが利用できなくなります。独自ドメインを利用しているユーザーで旧IPアドレスのままのレポジトリが影響されます。 <a href="https://t.co/1XI3X3NheA">https://t.co/1XI3X3NheA</a></p>&mdash; GitHub Japan (@GitHubJapan) <a href="https://twitter.com/GitHubJapan/status/530526223785811969">2014, 11月 7</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>


<h1>確認方法</h1>

<p>正しく設定されているかは、
<a href="https://github.com/blog/1917-github-pages-legacy-ip-deprecation">GitHub Pages Legacy IP Deprecation</a>
に書いてある確認スクリプトを実行して、<br/>
OK以外が表示されたらダメです。</p>

<p>このサイトの場合は以下の通りですね。<br/>
<code>dig ota42y.com | grep -E '(207.97.227.245|204.232.175.78|199.27.73.133)' || echo “OK”</code></p>

<h1>修正手順</h1>

<p>修正手順は簡単で、自分の持っているドメインを管理しているサービスに行って、<br/>
Aレコードを下記のページにあるように変更するだけです。<br/>
<a href="https://help.github.com/articles/tips-for-configuring-an-a-record-with-your-dns-provider/">Tips for configuring an A record with your DNS provider - User Documentation</a></p>

<p>私はさくらインターネットを使っていたため、以下の手順で変更できました。</p>

<ol>
<li><a href="https://secure.sakura.ad.jp/menu/domain/">ドメインメニュー</a></li>
<li>対象のドメインのゾーン編集をクリック</li>
<li>左側の変更をクリック</li>
<li>既存のIPアドレスをクリックし、前述のGithubの新しいIPアドレスを設定する</li>
</ol>


<p><img src="http://ota42y.com/images/posts/2014-11-20-github-pages-ip.png" alt="設定画面" /></p>

<p>変更をすると、先ほどのdigコマンドがOKを出すようになり、<br/>
Github Pagesにコミットしても警告メールが飛ばなくなります。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[golangでYAMLファイルを読み込む]]></title>
    <link href="http://ota42y.com/blog/2014/11/13/go-yaml/"/>
    <updated>2014-11-13T07:31:35+09:00</updated>
    <id>http://ota42y.com/blog/2014/11/13/go-yaml</id>
    <content type="html"><![CDATA[<p><a href="https://github.com/go-yaml/yaml">https://github.com/go-yaml/yaml</a>を使う事で、
goでYAMLを扱うことが出来ます。</p>

<p>サイトにはメモリ上のデータに対してYAML化するサンプルしかありませんが、<br/>
以下のようにすることでファイルからYAMLを読み込み、Mapとして扱うことが出来ます。</p>

<p>またExampleには型を決めて読み込む方法しか乗っていませんが、<br/>
以下の例では、<a href="http://qiita.com/yamasaki-masahide/items/d6e406c4c11d5870a1c6">go で yaml 等を「map[interface{}]interface{}」型で読み込んだ際の動的型の参照方法</a><br/>
を参考に型を決めずにMapで読み込んでいます。</p>

<p>かなり冗長な表現になっていますが…(´･_･`)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">a</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Easy!</span>
</span><span class='line'><span class="l-Scalar-Plain">b</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">c</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2</span>
</span><span class='line'>  <span class="l-Scalar-Plain">d</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">3</span><span class="p-Indicator">,</span> <span class="nv">4</span><span class="p-Indicator">]</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="p">(</span>
</span><span class='line'>  <span class="s">&quot;fmt&quot;</span>
</span><span class='line'>  <span class="s">&quot;io/ioutil&quot;</span>
</span><span class='line'>  <span class="s">&quot;gopkg.in/yaml.v2&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">buf</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nx">ReadFile</span><span class="p">(</span><span class="s">&quot;test.yml&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">m</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kd">interface</span><span class="p">{}]</span><span class="kd">interface</span><span class="p">{})</span>
</span><span class='line'>  <span class="nx">err</span> <span class="p">=</span> <span class="nx">yaml</span><span class="p">.</span><span class="nx">Unmarshal</span><span class="p">(</span><span class="nx">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">m</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>    <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%s\n&quot;</span><span class="p">,</span> <span class="nx">m</span><span class="p">[</span><span class="s">&quot;a&quot;</span><span class="p">])</span>
</span><span class='line'>  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%d\n&quot;</span><span class="p">,</span> <span class="nx">m</span><span class="p">[</span><span class="s">&quot;b&quot;</span><span class="p">].(</span><span class="kd">map</span><span class="p">[</span><span class="kd">interface</span> <span class="p">{}]</span><span class="kd">interface</span> <span class="p">{})[</span><span class="s">&quot;c&quot;</span><span class="p">])</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>出力結果</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="nx">Easy</span><span class="p">!</span>
</span><span class='line'><span class="mi">2</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[スクフェス用パッケージの更新]]></title>
    <link href="http://ota42y.com/blog/2014/11/12/scfes-update/"/>
    <updated>2014-11-12T11:28:23+09:00</updated>
    <id>http://ota42y.com/blog/2014/11/12/scfes-update</id>
    <content type="html"><![CDATA[<p><a href="http://ota42y.com/blog/2014/10/28/hubot-scfes/">前に作った</a>スクフェス用パッケージを更新しました。<br/>
<a href="https://github.com/ota42y/hubot-scfes">https://github.com/ota42y/hubot-scfes</a></p>

<p>今回は、いつぐらいにレベルアップするかを計算するコマンドを用意しました。<br/>
真夜中にレベルアップが起きたりすると面倒なので、これを見て事前に石を使うなり、<br/>
別の難易度をやって遅らせるなりして、レベルアップのタイミング調整をすることが簡単になります。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="c1"># 次のレベルアップまでexを何回プレイするか</span>
</span><span class='line'><span class="nx">hubot</span> <span class="nx">scfes</span> <span class="nx">levelup</span> <span class="nx">count</span> <span class="mi">830</span> <span class="nx">ex</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="mi">10</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 次のレベルアップはいつか</span>
</span><span class='line'><span class="nx">hubot</span> <span class="nx">scfes</span> <span class="nx">levelup</span> <span class="nx">time</span> <span class="mi">830</span> <span class="nx">ex</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="nx">next</span> <span class="nx">levelup</span> <span class="o">is</span> <span class="nx">Sun</span> <span class="nx">Aug</span> <span class="mi">3</span> <span class="mi">2014</span> <span class="mi">2</span><span class="o">:</span><span class="mi">52</span><span class="o">:</span><span class="mi">52</span> <span class="nx">GMT</span><span class="o">+</span><span class="mi">0900</span> <span class="p">(</span><span class="nx">JST</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>なお、現在のスタミナ値は考慮していないため、実際は今たまってる分だけ早くなります。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Hubotの追加機能作成をテストで楽にする]]></title>
    <link href="http://ota42y.com/blog/2014/11/10/hubot-test/"/>
    <updated>2014-11-10T07:54:39+09:00</updated>
    <id>http://ota42y.com/blog/2014/11/10/hubot-test</id>
    <content type="html"><![CDATA[<p>Hubotで追加機能を作るときに一番大変なのは、やはりテストの部分だと思います。<br/>
普通に頑張ると、起動してbotにメッセージ送って、動かなければ止めて修正…といった、<br/>
面倒な手順を踏むことになります。<br/>
また、普通に起動するとエラーも吐いてくれないため、デバッグは非常に困難です。</p>

<p>しかし、テストを書いて開発をする場合、メッセージ送信やメッセージのデータ取得など、<br/>
Hubotに依存する部分をstubで置き換えるのはとても面倒な作業です。</p>

<p>そこで、作りたい機能をパッケージ化して作成することで、<br/>
トライアンドエラーをする部分を最低限に絞って開発することができました。</p>

<h1>Hubot用パッケージの構成</h1>

<p>Hubotはpackage.jsonのmainに指定したファイルをロードしてくれるため、<br/>
ここにhubot用のスクリプトを書くことで、Hubotスクリプトをnpmパッケージで管理できます。</p>

<p>さらに、以下のようにhubotスクリプトから、処理をまとめたオブジェクトの特定のメソッドを呼び出すことで、<br/>
Hubotの連携部分と実際の処理を分けることができます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">PackageClass = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;./package-name/package-class.coffee&#39;</span><span class="p">).</span><span class="nx">PackageClass</span>
</span><span class='line'><span class="nv">module.exports = </span><span class="nf">(robot) -&gt;</span>
</span><span class='line'>  <span class="nv">package_class = </span><span class="k">new</span> <span class="nx">PackageClass</span>
</span><span class='line'>  <span class="nx">robot</span><span class="p">.</span><span class="nx">respond</span> <span class="sr">/test call (\d+)( \w+)?/</span><span class="p">,</span> <span class="nf">(msg) -&gt;</span>
</span><span class='line'>    <span class="nv">arg1 = </span><span class="nb">parseInt</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>    <span class="nv">arg2 = </span><span class="nx">msg</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">msg</span><span class="p">.</span><span class="nx">reply</span> <span class="nx">package_class</span><span class="p">.</span><span class="nx">testCall</span><span class="p">(</span><span class="nx">arg1</span><span class="p">,</span> <span class="nx">arg2</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>フォルダ構成は以下のようになります。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nx">parkage</span><span class="o">-</span><span class="nx">root</span><span class="o">/</span>
</span><span class='line'> <span class="err">├</span> <span class="nx">package</span><span class="p">.</span><span class="nx">json</span>
</span><span class='line'> <span class="err">│</span>
</span><span class='line'> <span class="err">├</span> <span class="nx">src</span><span class="o">/</span>
</span><span class='line'> <span class="err">│</span>  <span class="err">├</span> <span class="nx">hubot</span><span class="o">-</span><span class="nx">command</span><span class="p">.</span><span class="nx">coffee</span>
</span><span class='line'> <span class="err">│</span>  <span class="err">└</span> <span class="nx">package</span><span class="o">-</span><span class="nx">name</span><span class="o">/</span>
</span><span class='line'> <span class="err">│</span>     <span class="err">└</span> <span class="nx">package</span><span class="o">-</span><span class="k">class</span><span class="p">.</span><span class="nx">coffee</span>
</span><span class='line'> <span class="err">│</span>
</span><span class='line'> <span class="err">└</span> <span class="nx">test</span><span class="o">/</span>
</span><span class='line'>    <span class="err">├</span> <span class="nx">test</span><span class="o">-</span><span class="nx">helper</span><span class="p">.</span><span class="nx">coffee</span>
</span><span class='line'>    <span class="err">└</span> <span class="nx">test</span><span class="o">-</span><span class="nx">package</span><span class="o">-</span><span class="k">class</span><span class="p">.</span><span class="nx">coffee</span>
</span></code></pre></td></tr></table></div></figure>


<p>このように構成し、package-classに対してテストを作成することで、<br/>
Hubot固有の部分を最小限に減らし、通常のnpmパッケージのように開発できました。</p>

<p>前述の通り、hubotとやりとりをするhubot-commandに対してテストをするのは手間がかかります。<br/>
ですが、やっていることは正規表現の結果をクラスのメソッドに渡すだけなので、<br/>
手作業でやってしまう方が簡単で早いです。</p>

<h1>参考</h1>

<p>hubot-scfesはこの方針に則って作ったため、参考になるかもしれません。<br/>
<a href="https://github.com/ota42y/hubot-scfes">https://github.com/ota42y/hubot-scfes</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[size_tは環境によって定義が変わるという話]]></title>
    <link href="http://ota42y.com/blog/2014/11/08/size-t/"/>
    <updated>2014-11-08T13:39:51+09:00</updated>
    <id>http://ota42y.com/blog/2014/11/08/size-t</id>
    <content type="html"><![CDATA[<p>size_tが何bitになるかは環境によって定義が異なります。<br/>
そのため、以下のコードは多くの32bit下で上手くいきますが、64bit化などで環境が変わると動かなくなります。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="cp">#include &lt;string&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">test</span> <span class="o">=</span> <span class="s">&quot;test text&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;size_t %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">size_t</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">pos</span> <span class="o">=</span> <span class="n">test</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;ms&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;pos %lu, %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">size_t</span><span class="p">)</span><span class="n">pos</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">::</span><span class="n">npos</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">pos</span> <span class="o">!=</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">::</span><span class="n">npos</span><span class="p">){</span>
</span><span class='line'>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">text</span> <span class="o">=</span> <span class="n">test</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>std::stringのfindは引数の文字列が最初に出てくる位置か、見つからなかった場合にstd::string::nposを返します。<br/>
この時、戻り値の型はsize_tになります。</p>

<p>size_tは32bit上ではunsigned intの別名として定義される事が多いため、上記のコードは問題なく動きます。<br/>
ですが64bitにした場合、size_tはunsigned long(8bit)の別名として定義される事があるため、<br/>
unsigned int(4bit)で表せない範囲の値だった場合はデータが一部消滅します。</p>

<p>さらに、std::string::nposは-1として定義されており、unsignedとして解釈した場合にはその値の最大値になります。<br/>
size_tがunsigned intの場合、両者は同じ大きさのため特に意識する必要はありません。</p>

<p>ですが、size_tがunsigned longとして定義されている場合、その最大値はunsined intでは表せないため、<br/>
データが消滅し、結果として比較に失敗するという事が起きます。</p>

<p>私の環境では、上記のコードは-1をunsigend intにした4294967295と,<br/>
-1をunsigend longにした18446744073709551615とを比較し、<br/>
<code>test text</code>の4294967295文字目にアクセスして異常終了します。</p>

<p>やっかいなことに、size_tをunsigned intではなくintに代入した場合、<br/>
-1は-1として解釈されるため、unsigend longと比較した際に最大値に変換されるため、上手くいってしまいます。</p>

<p>とはいえ、安全性を求めるならば、出来るだけsize_tはsize_tとして扱うようにした方がいいと思います。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[void型のポインタとint型を相互変換するなという話]]></title>
    <link href="http://ota42y.com/blog/2014/11/07/cpp-64bit-cast/"/>
    <updated>2014-11-07T07:42:43+09:00</updated>
    <id>http://ota42y.com/blog/2014/11/07/cpp-64bit-cast</id>
    <content type="html"><![CDATA[<p>int型をvoid *に変換する場合も、その逆の場合も、32bitだと問題なく動くことが多いため、<br/>
コンパイラもエラーにしない場合が多いです。<br/>
ですが、64bitだと問題が起きることが多いため、64bitを対象にした場合にエラー扱いをする場合があり、<br/>
突然わいて出る大量のエラーに悩まされる事があります…(´･_･`)</p>

<h1>intからvoid型のポインタへの変換</h1>

<p>int型の値をvoid *を利用して保持したい場合、<a href="http://ota42y.com/blog/2014/11/06/cpp-void-pointer/">前の例</a>のように、int型を保持するオブジェクトを作り、<br/>
その中に値を入れた上で、そのオブジェクトへのポインタを持たせる必要があります。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">struct</span> <span class="n">Container</span><span class="p">{</span>
</span><span class='line'>  <span class="kt">void</span><span class="o">*</span> <span class="n">data</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">Num</span><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// int型を保存する</span>
</span><span class='line'><span class="n">Num</span><span class="o">*</span> <span class="n">numPointer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Num</span><span class="p">();</span>
</span><span class='line'><span class="n">numPointer</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
</span><span class='line'><span class="n">Container</span> <span class="n">con</span><span class="p">;</span>
</span><span class='line'><span class="n">con</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">numPointer</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// 42を取り出す</span>
</span><span class='line'><span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="p">((</span><span class="n">Num</span><span class="o">*</span><span class="p">)</span><span class="n">con</span><span class="p">.</span><span class="n">data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// newしたので必ず破棄する</span>
</span><span class='line'><span class="k">delete</span> <span class="n">con</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
</span><span class='line'><span class="n">con</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>ですが、世の中にはたまにvoid *にint型（やその他のプリミティブ型）を代入する不届き者がいます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">Container</span> <span class="n">con</span><span class="p">;</span>
</span><span class='line'><span class="n">con</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">num</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 42を取り出す</span>
</span><span class='line'><span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">con</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>void <em>はポインタのため、32bit環境ではvoid</em>は32bitであり、intも基本的には32bitで同じサイズのため、<br/>
32bit環境に限れば問題なくコンパイル、実行が出来ます。<br/>
(エラーになる場合は、g++ test.cpp -m32で32bitのみのコンパイルが出来ます)</p>

<p>ですが、当然ながら64bit環境ではvoid *は64bitのため、intが32bitの場合は足りない分が消滅します。<br/>
多くのコンパイラでは64bitでコンパイルしようとしたときに、このキャストが行われるとエラーを出してくれますが、<br/>
32bitのみコンパイルした場合は出してくれない場合があるため、<br/>
対応しようとした時に大量のエラーに悩まされることになります…</p>

<p>このような場合は最初に述べたとおり、オブジェクトを作ってそのポインタを利用しましょう。</p>

<h1>ポインタ型をint型に代入している場合</h1>

<p>上記の例は32bitを64bitにしてから32bitに戻すため、キャストの仕様によっては問題なく動きます。<br/>
ですが、以下のようにポインタをintにキャストした場合、64bit環境かつintが32bitの場合、<br/>
intに入りきらない部分が消滅してしまうため、ポインタに戻しても正しく戻すことができません。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'>  <span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="s">&quot;test&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">str</span><span class="p">;</span>
</span><span class='line'>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">string</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">a</span><span class="p">);</span> <span class="c1">// ここで不正なアドレスになる</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">string</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>この場合、メモリ破壊などといった特定しにくいエラーを引き起こすため、注意が必要です。<br/>
ただし、例によってポインタとintサイズが同一の環境では問題なく動くため、<br/>
そうでない環境に対応しようとした場合に悩まされる事になります。</p>

<p>一見するとあまり使わなそうな書き方ですが、フレームワークで用意されているクラスとかでvoid *が無い場合、<br/>
クラスのポインタを持たせたいが為に、適当なint型に持たせる…みたいな事をやらかす輩がいますので、<br/>
注意が必要です。</p>

<p>またそれ以外にも、ポインタに対して演算を行いたい場合に、int型に変換して計算をする場合があります。<br/>
このような場合は、intptr_tかuintptr_tというポインタを扱う整数型が用意されており、<br/>
こちらを使うことで32bitや64bitに適したサイズに変換されて扱うことができます。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[汎用ポインタを使う]]></title>
    <link href="http://ota42y.com/blog/2014/11/06/cpp-void-pointer/"/>
    <updated>2014-11-06T07:24:31+09:00</updated>
    <id>http://ota42y.com/blog/2014/11/06/cpp-void-pointer</id>
    <content type="html"><![CDATA[<p>int型のポインタとchar型のポインタは違う型のため、同じものとして扱うことは出来ません。<br/>
ですが、実際にはポインタ型はメモリ上の特定アドレスを示すもののため、<br/>
どの型のポインタであっても、データ自体はメモリ上のアドレスを示す何bitかの数値であり、全く同じです。<br/>
（勿論、ポインタの示すアドレスに何があるかは異なります）</p>

<p>そのため、ポインタ専用の変数を利用することで、あらゆる型のポインタを同じ変数に代入することができます。</p>

<p>ただし、コンパイラの型チェックが効かなくなる等の理由から、基本的にはオススメできない手法です。<br/>
C++の場合はテンプレートやクラスの継承、dynamic_castで解決できる場合はそちらを利用した方が安全です。</p>

<h1>汎用ポインタ</h1>

<p>void *型は汎用ポインタと呼ばれ、あらゆるポインタを代入することができます。<br/>
これはたとえば以下のように、何の型かは指定しないけど、変数として持ちたいという場合に利用できます。</p>

<p>この場合、変数定義をvoid *型にしておき、使う前後に目的の型にキャストすることで、<br/>
様々な型を1つの変数で扱うことが出来ます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">struct</span> <span class="n">Container</span><span class="p">{</span>
</span><span class='line'>  <span class="kt">void</span><span class="o">*</span> <span class="n">data</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">Num</span><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">text</span> <span class="o">=</span> <span class="s">&quot;text&quot;</span><span class="p">;</span>
</span><span class='line'><span class="n">Container</span> <span class="n">con1</span><span class="p">;</span>
</span><span class='line'><span class="n">con1</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">text</span><span class="p">;</span> <span class="c1">// dataにconst charのポインタを入れる</span>
</span><span class='line'>
</span><span class='line'><span class="n">Num</span><span class="o">*</span> <span class="n">numPointer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Num</span><span class="p">();</span>
</span><span class='line'><span class="n">numPointer</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
</span><span class='line'><span class="n">Container</span> <span class="n">con2</span><span class="p">;</span>
</span><span class='line'><span class="n">con2</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">numPointer</span><span class="p">;</span> <span class="c1">// dataにNum型のポインタを入れる</span>
</span><span class='line'>
</span><span class='line'><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">con1</span><span class="p">.</span><span class="n">data</span><span class="p">);</span> <span class="c1">// 取り出す際にキャストする</span>
</span><span class='line'><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">((</span><span class="n">Num</span><span class="o">*</span><span class="p">)</span><span class="n">con2</span><span class="p">.</span><span class="n">data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>なお、違うポインタを違う型にキャストして使うと、メモリ破壊などの予期せぬエラーを引き起こしますが、<br/>
構文上はvoid *から元の型に戻す際のキャストは全て正しいと処理されます。</p>

<p>そのため、おかしくなるキャストをしていてもコンパイラの型チェックでエラー検出が出来ません。<br/>
前述の通り、C++の場合はvoid *を使わず、テンプレートやクラスの継承、dynamic_castで解決した方が安全です。</p>

<h1>mallocの戻り値</h1>

<p>void *はmallocの戻り値としても使われています。<br/>
<a href="http://www.cplusplus.com/reference/cstdlib/malloc/">http://www.cplusplus.com/reference/cstdlib/malloc/</a></p>

<p>mallocの戻り値が何にでもキャスト出来るのは、この仕様によるものです。　</p>

<h1>ポインタを整数値として扱う</h1>

<p>ポインタを整数値として利用したい場合、intptr_tとuintptr_tが利用できます。<br/>
これはそれぞれ符号つき、符号なしの整数として扱うことができます。</p>

<p>間違ってもそのままintにキャスとして代入してはいけません。<br/>
<a href="http://ota42y.com/blog/2014/11/07/cpp-64bit-cast/">void型のポインタとint型を相互変換するなという話</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[hubot-ircではmsg.replyのリプライ先が変わるので注意]]></title>
    <link href="http://ota42y.com/blog/2014/11/01/hubot-reply/"/>
    <updated>2014-11-01T21:02:11+09:00</updated>
    <id>http://ota42y.com/blog/2014/11/01/hubot-reply</id>
    <content type="html"><![CDATA[<p>hubot-ircを使い、こういうコードで一定時間後に後からユーザに通知しようとしてたところ、<br/>
replyしてるのに発言元とは別のチャットに送信してしまうという問題が起きました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nx">robot</span><span class="p">.</span><span class="nx">respond</span> <span class="sr">/進捗 start/i</span><span class="p">,</span> <span class="nf">(msg) -&gt;</span>
</span><span class='line'>  <span class="nx">setTimeout</span><span class="p">(</span><span class="nf">-&gt;</span>
</span><span class='line'>    <span class="nx">msg</span><span class="p">.</span><span class="nx">reply</span> <span class="s">&quot;進捗どうですか？&quot;</span>
</span><span class='line'>    <span class="k">return</span>
</span><span class='line'>  <span class="p">,</span> <span class="mi">30</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">msg</span><span class="p">.</span><span class="nx">send</span> <span class="s">&quot;進捗 start&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>何度か意図的に起こしてみたところ、どうやらmsg.replyの送信先は、<br/>
そのユーザがreplyする時に最後に発言したチャットに対して行われるらしく、<br/>
メッセージが作られた後に別のチャットに発言した場合、そちらに送られてしまうようです。</p>

<p>そのため、以下のように送信先を待避することで回避できます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nx">robot</span><span class="p">.</span><span class="nx">respond</span> <span class="sr">/進捗 start/i</span><span class="p">,</span> <span class="nf">(msg) -&gt;</span>
</span><span class='line'>  <span class="nv">user = </span><span class="nx">msg</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">name</span>
</span><span class='line'>  <span class="nv">room = </span><span class="nx">msg</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">room</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">setTimeout</span><span class="p">(</span><span class="nf">-&gt;</span>
</span><span class='line'>    <span class="nx">robot</span><span class="p">.</span><span class="nx">send</span> <span class="p">{</span><span class="nv">room: </span><span class="nx">room</span><span class="p">},</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">user</span><span class="si">}</span><span class="s"> 進捗どうですか？&quot;</span>
</span><span class='line'>    <span class="k">return</span>
</span><span class='line'>  <span class="p">,</span> <span class="mi">30</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">msg</span><span class="p">.</span><span class="nx">send</span> <span class="s">&quot;進捗 start&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h1>原因となるコードを捜す</h1>

<p>というのは振る舞いから推測したものなので、実際にコードを追ってみます。</p>

<h2>hubot-irc.reply</h2>

<p>まずはhubot-ircのmsg.replyの中を見ます。<br/>
<a href="https://github.com/nandub/hubot-irc/blob/master/src/irc.coffee#L78">https://github.com/nandub/hubot-irc/blob/master/src/irc.coffee#L78</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">reply: </span><span class="nf">(envelope, strings...) -&gt;</span>
</span><span class='line'>  <span class="k">for</span> <span class="nx">str</span> <span class="k">in</span> <span class="nx">strings</span>
</span><span class='line'>    <span class="nx">@send</span> <span class="nx">envelope</span><span class="p">.</span><span class="nx">user</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">envelope</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="s">: </span><span class="si">#{</span><span class="nx">str</span><span class="si">}</span><span class="s">&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>メッセージをユーザ宛に変換し、sendメソッドにenvelope.userと一緒に渡しています。</p>

<h2>hubot-irc.send</h2>

<p>次にsendメソッドの中身を見ます。<br/>
<a href="https://github.com/nandub/hubot-irc/blob/522c50166f15e57ada0c10f181d4de26b4349717/src/irc.coffee#L16">https://github.com/nandub/hubot-irc/blob/522c50166f15e57ada0c10f181d4de26b4349717/src/irc.coffee#L16</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">send: </span><span class="nf">(envelope, strings...) -&gt;</span>
</span><span class='line'>  <span class="c1"># Use @notice if SEND_NOTICE_MODE is set</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">@notice</span> <span class="nx">envelope</span><span class="p">,</span> <span class="nx">strings</span> <span class="k">if</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">HUBOT_IRC_SEND_NOTICE_MODE</span><span class="o">?</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">target = </span><span class="nx">@_getTargetFromEnvelope</span> <span class="nx">envelope</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">unless</span> <span class="nx">target</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span> <span class="s">&quot;ERROR: Not sure who to send to. envelope=&quot;</span><span class="p">,</span> <span class="nx">envelope</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="nx">str</span> <span class="k">in</span> <span class="nx">strings</span>
</span><span class='line'>    <span class="nx">@bot</span><span class="p">.</span><span class="nx">say</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">str</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>envelope</code>（replyメソッドのenvelope.user）から<code>_getTargetFromEnvelope</code>でターゲットを取り出し、<br/>
<code>@bot.say</code>で発言をしています。</p>

<p>このとき、@botはnodeのircパッケージのオブジェクトで、<br/>
sayメソッドはtargetに対してメッセージを送るようになっています。<br/>
そのため、このtargetに設定される返信先が変更される可能性が高そうです。</p>

<h1>hubt-irc._getTargetFromEnvelope</h1>

<p><a href="https://github.com/nandub/hubot-irc/blob/master/src/irc.coffee#L336">https://github.com/nandub/hubot-irc/blob/master/src/irc.coffee#L336</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">_getTargetFromEnvelope: </span><span class="nf">(envelope) -&gt;</span>
</span><span class='line'>  <span class="nv">user = </span><span class="kc">null</span>
</span><span class='line'>  <span class="nv">room = </span><span class="kc">null</span>
</span><span class='line'>  <span class="nv">target = </span><span class="kc">null</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># as of hubot 2.4.2, the first param to send() is an object with &#39;user&#39;</span>
</span><span class='line'>  <span class="c1"># and &#39;room&#39; data inside. detect the old style here.</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">envelope</span><span class="p">.</span><span class="nx">reply_to</span>
</span><span class='line'>    <span class="nv">user = </span><span class="nx">envelope</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="c1"># expand envelope</span>
</span><span class='line'>    <span class="nv">user = </span><span class="nx">envelope</span><span class="p">.</span><span class="nx">user</span>
</span><span class='line'>    <span class="nv">room = </span><span class="nx">envelope</span><span class="p">.</span><span class="nx">room</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="nx">user</span>
</span><span class='line'>    <span class="c1"># most common case - we&#39;re replying to a user in a room</span>
</span><span class='line'>    <span class="k">if</span> <span class="nx">user</span><span class="p">.</span><span class="nx">room</span>
</span><span class='line'>      <span class="nv">target = </span><span class="nx">user</span><span class="p">.</span><span class="nx">room</span>
</span><span class='line'>    <span class="c1"># reply directly</span>
</span><span class='line'>    <span class="k">else</span> <span class="k">if</span> <span class="nx">user</span><span class="p">.</span><span class="nx">name</span>
</span><span class='line'>      <span class="nv">target = </span><span class="nx">user</span><span class="p">.</span><span class="nx">name</span>
</span><span class='line'>    <span class="c1"># replying to pm</span>
</span><span class='line'>    <span class="k">else</span> <span class="k">if</span> <span class="nx">user</span><span class="p">.</span><span class="nx">reply_to</span>
</span><span class='line'>      <span class="nv">target = </span><span class="nx">user</span><span class="p">.</span><span class="nx">reply_to</span>
</span><span class='line'>    <span class="c1"># allows user to be an id string</span>
</span><span class='line'>    <span class="k">else</span> <span class="k">if</span> <span class="nx">user</span><span class="p">.</span><span class="nx">search</span><span class="o">?</span><span class="p">(</span><span class="sr">/@/</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
</span><span class='line'>      <span class="nv">target = </span><span class="nx">user</span>
</span><span class='line'>  <span class="k">else</span> <span class="k">if</span> <span class="nx">room</span>
</span><span class='line'>    <span class="c1"># this will happen if someone uses robot.messageRoom(jid, ...)</span>
</span><span class='line'>    <span class="nv">target = </span><span class="nx">room</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">target</span>
</span></code></pre></td></tr></table></div></figure>


<p>ユーザの情報を使ってリプライ先を決定しているようです。<br/>
この中で、envelope.roomが存在すれば、それをtargetとして設定するようになっています。<br/>
なお、このメソッド内のenvelopeは、replyメソッドのenvelope.userを差しています。</p>

<p>そのため、次はreplyメソッドのenvelope.user.roomが書き換わるかどうかを調べていきます。</p>

<h2>replyメソッドの呼ばれ方</h2>

<p>コールスタックをさかのぼっていくと、以下のメソッドが順に呼ばれていました。<br/>
<a href="https://github.com/github/hubot/blob/39681ea35de6375154748418e11f533ef51c3340/src/listener.coffee#L22">https://github.com/github/hubot/blob/39681ea35de6375154748418e11f533ef51c3340/src/listener.coffee#L22</a><br/>
<a href="https://github.com/github/hubot/blob/39681ea35de6375154748418e11f533ef51c3340/src/robot.coffee#L192">https://github.com/github/hubot/blob/39681ea35de6375154748418e11f533ef51c3340/src/robot.coffee#L192</a><br/>
<a href="https://github.com/github/hubot/blob/39681ea35de6375154748418e11f533ef51c3340/src/adapter.coffee#L65">https://github.com/github/hubot/blob/39681ea35de6375154748418e11f533ef51c3340/src/adapter.coffee#L65</a><br/>
<a href="https://github.com/nandub/hubot-irc/blob/522c50166f15e57ada0c10f181d4de26b4349717/src/irc.coffee#L237">https://github.com/nandub/hubot-irc/blob/522c50166f15e57ada0c10f181d4de26b4349717/src/irc.coffee#L237</a></p>

<p>この中で、最後のhubt-ircの以下の部分で、nodeのircがメッセージを受信した場合に、<br/>
メッセージから特定されたuserオブジェクトが、replyメソッドのenvelope.userになっていました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nx">bot</span><span class="p">.</span><span class="nx">addListener</span> <span class="s">&#39;message&#39;</span><span class="p">,</span> <span class="nf">(from, to, message) -&gt;</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">nick</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">==</span> <span class="nx">to</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
</span><span class='line'>    <span class="c1"># this is a private message, let the &#39;pm&#39; listener handle it</span>
</span><span class='line'>    <span class="k">return</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="nx">from</span> <span class="k">in</span> <span class="nx">options</span><span class="p">.</span><span class="nx">ignoreUsers</span>
</span><span class='line'>    <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s">&#39;Ignoring user: %s&#39;</span><span class="p">,</span> <span class="nx">from</span><span class="p">)</span>
</span><span class='line'>    <span class="c1"># we&#39;ll ignore this message if it&#39;s from someone we want to ignore</span>
</span><span class='line'>    <span class="k">return</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="s">&quot;From </span><span class="si">#{</span><span class="nx">from</span><span class="si">}</span><span class="s"> to </span><span class="si">#{</span><span class="nx">to</span><span class="si">}</span><span class="s">: </span><span class="si">#{</span><span class="nx">message</span><span class="si">}</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">user = </span><span class="nx">self</span><span class="p">.</span><span class="nx">createUser</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">from</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">user</span><span class="p">.</span><span class="nx">room</span>
</span><span class='line'>    <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">to</span><span class="si">}</span><span class="s"> &lt;</span><span class="si">#{</span><span class="nx">from</span><span class="si">}</span><span class="s">&gt; </span><span class="si">#{</span><span class="nx">message</span><span class="si">}</span><span class="s">&quot;</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="k">unless</span> <span class="nx">message</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">to</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>      <span class="nv">message = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">to</span><span class="si">}</span><span class="s">: </span><span class="si">#{</span><span class="nx">message</span><span class="si">}</span><span class="s">&quot;</span>
</span><span class='line'>    <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="s">&quot;msg &lt;</span><span class="si">#{</span><span class="nx">from</span><span class="si">}</span><span class="s">&gt; </span><span class="si">#{</span><span class="nx">message</span><span class="si">}</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">self</span><span class="p">.</span><span class="nx">receive</span> <span class="k">new</span> <span class="nx">TextMessage</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>userオブジェクトは、受け取ったメッセージからcreateUserを使って求めているようです</p>

<h2>hubot-irc.createUser</h2>

<p><a href="https://github.com/nandub/hubot-irc/blob/522c50166f15e57ada0c10f181d4de26b4349717/src/irc.coffee#L111">https://github.com/nandub/hubot-irc/blob/522c50166f15e57ada0c10f181d4de26b4349717/src/irc.coffee#L111</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'>  <span class="nv">createUser: </span><span class="nf">(channel, from) -&gt;</span>
</span><span class='line'>    <span class="nv">user = </span><span class="nx">@getUserFromId</span> <span class="nx">from</span>
</span><span class='line'>    <span class="nv">user.name = </span><span class="nx">from</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^[&amp;#]/</span><span class="p">)</span>
</span><span class='line'>      <span class="nv">user.room = </span><span class="nx">channel</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="nv">user.room = </span><span class="kc">null</span>
</span><span class='line'>    <span class="nx">user</span>
</span></code></pre></td></tr></table></div></figure>


<p>ここで、user.roomに最新のメッセージが送られたchannelをセットしています。<br/>
そのため、getUserFromIdが返すuserオブジェクトがメッセージごとに共通なら、<br/>
replyメソッドに渡された後に別のメッセージによって書き換わる可能性があると言えます。</p>

<h2>hubot.getUserFromId</h2>

<p>getUserFromIdはhubot.getUserFromIdを呼び出しているだけでした。<br/>
（HubotのAPIが変わったため、一手間挟んでいる）</p>

<p><a href="https://github.com/github/hubot/blob/39681ea35de6375154748418e11f533ef51c3340/src/brain.coffee#L103">https://github.com/github/hubot/blob/39681ea35de6375154748418e11f533ef51c3340/src/brain.coffee#L103</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'> <span class="nv">userForId: </span><span class="nf">(id, options) -&gt;</span>
</span><span class='line'>    <span class="nv">user = </span><span class="nx">@data</span><span class="p">.</span><span class="nx">users</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>
</span><span class='line'>    <span class="k">unless</span> <span class="nx">user</span>
</span><span class='line'>      <span class="nv">user = </span><span class="k">new</span> <span class="nx">User</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">options</span>
</span><span class='line'>      <span class="nx">@data</span><span class="p">.</span><span class="nx">users</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">user</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="nx">options</span> <span class="o">and</span> <span class="nx">options</span><span class="p">.</span><span class="nx">room</span> <span class="o">and</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">.</span><span class="nx">room</span> <span class="o">or</span> <span class="nx">user</span><span class="p">.</span><span class="nx">room</span> <span class="o">isnt</span> <span class="nx">options</span><span class="p">.</span><span class="nx">room</span><span class="p">)</span>
</span><span class='line'>      <span class="nv">user = </span><span class="k">new</span> <span class="nx">User</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">options</span>
</span><span class='line'>      <span class="nx">@data</span><span class="p">.</span><span class="nx">users</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">user</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">user</span>
</span></code></pre></td></tr></table></div></figure>


<p>@data内に保存されているユーザを帰しています。<br/>
そのため、各メッセージ毎に共通のuserオブジェクトが返されます。</p>

<p>hubot-irc.createUser内でこのオブジェクトのroomを書き換えているため、<br/>
ユーザが発言を行うと、robot.replyの時に使用するuserオブジェクトが変更され、<br/>
慈顔をおいて発言しようとすると別のチャットに発言していたようです。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[スクフェス用の機能が詰まったHubotパッケージを作った]]></title>
    <link href="http://ota42y.com/blog/2014/10/28/hubot-scfes/"/>
    <updated>2014-10-28T07:34:32+09:00</updated>
    <id>http://ota42y.com/blog/2014/10/28/hubot-scfes</id>
    <content type="html"><![CDATA[<p><a href="http://lovelive.bushimo.jp/">スクフェス</a>用の色々便利な機能が入ったHubotパッケージを作りました。<br/>
<a href="https://github.com/ota42y/hubot-scfes">https://github.com/ota42y/hubot-scfes</a></p>

<p>今のところ主な機能は2つです。</p>

<h2>スタミナがMaxになる時間になったら通知する</h2>

<p><code>hubot scfes remind stamina 10 50</code><br/>
で、スタミナの現在値が10、最大値が50の場合に、Maxになる時刻に通知してくれます。<br/>
それ以外の値の場合は調節してください。</p>

<h2>スタミナがnの倍数になったときに通知する</h2>

<p><code>hubot scfes remind stamina 10 50 25</code><br/>
で、スタミナの現在値が10、最大値が50として、25の倍数の時に通知してくれます。<br/>
EXでちょうど使い切れるタイミングで通知するといった使い方を想定しています。</p>

<h2>未実装機能</h2>

<p>イベント終了までにどれくらいスタミナが回復するかとか、<br/>
レベルアップするのはいつぐらいになるかとか、<br/>
そういった頭の中で適当に計算してる奴を機能化していこうと思います。</p>

<p>ちなみにこいつは前に作った<a href="https://github.com/ota42y/stamina-calculator">stamina-calculator</a>を内部で使用しています。<br/>
node.jsで細かくパッケージに分けて開発ってどうやるんだろうなーと思って、実益と練習がてら作った感じです。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Linux上でrubyのPTYを使うと、Errno::EIOが出る]]></title>
    <link href="http://ota42y.com/blog/2014/10/26/pty-ieo-error/"/>
    <updated>2014-10-26T14:06:39+09:00</updated>
    <id>http://ota42y.com/blog/2014/10/26/pty-ieo-error</id>
    <content type="html"><![CDATA[<p>以下のコードはMac OS X上だと上手く動きますが、Linux上だと<br/>
<code>Errno::EIO: Input/output error @ io_fillbuf</code>
というエラーが起きます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;pty&#39;</span>
</span><span class='line'><span class="no">PTY</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="s2">&quot;ls&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">pid</span><span class="o">|</span>
</span><span class='line'>    <span class="k">until</span> <span class="n">r</span><span class="o">.</span><span class="n">eof?</span> <span class="k">do</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="n">r</span><span class="o">.</span><span class="n">readline</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>どうやら、読み込んだ際にBSDだとnilになりますが、GNU/LinuxだとErrno::EIOが発生する仕様らしいです。</p>

<p><a href="http://stackoverflow.com/questions/10238298/ruby-on-linux-pty-goes-away-without-eof-raises-errnoeio">Ruby on Linux PTY goes away without EOF, raises Errno::EIO</a><br/>
にあるように、resqueするSafePtyを作ることで回避できます。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[javascriptの関数リテラルではインスタンス変数にアクセスできない]]></title>
    <link href="http://ota42y.com/blog/2014/10/23/javascript-callback/"/>
    <updated>2014-10-23T07:41:23+09:00</updated>
    <id>http://ota42y.com/blog/2014/10/23/javascript-callback</id>
    <content type="html"><![CDATA[<p>関数リテラルではローカル変数には自由にアクセスできるので、<br/>
ついインスタンスメソッド等にもアクセス出来ると思ってしまいましたが、違うようです。</p>

<p>以下のように、コールバックとして自分のインスタンスメソッドを呼び出す関数を渡した場合、<br/>
実行時にエラーになります。<br/>
(coffeescriptで書いていますがjavascriptと同じ結果です)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="k">class</span> <span class="nx">Test</span>
</span><span class='line'>  <span class="nv">hello: </span><span class="nf">(num) -&gt;</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;hello &quot;</span> <span class="o">+</span> <span class="nx">num</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">call: </span><span class="nf">(test2) -&gt;</span>
</span><span class='line'>    <span class="nx">@hello</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">test2</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nf">-&gt;</span>
</span><span class='line'>      <span class="nx">@hello</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>      <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nx">Test2</span>
</span><span class='line'>  <span class="nv">call: </span><span class="nf">(callback) -&gt;</span>
</span><span class='line'>    <span class="nx">callback</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>関数リテラルはそれを作ったオブジェクトとは別のオブジェクトから呼び出されるらしく、<br/>
またその時のthis(coffeescriptなので@hello(2)はthis.hello(2)と等価です)は、<br/>
そのオブジェクトになり、メソッドがないため失敗するようです。</p>

<p>以下のように、一度thisを待避させることで呼び出すことが出来ます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="k">class</span> <span class="nx">Test</span>
</span><span class='line'>  <span class="nv">hello: </span><span class="nf">(num) -&gt;</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;hello &quot;</span> <span class="o">+</span> <span class="nx">num</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">call: </span><span class="nf">(test2) -&gt;</span>
</span><span class='line'>    <span class="nx">@hello</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">self = </span><span class="k">this</span>
</span><span class='line'>    <span class="nx">test2</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nf">-&gt;</span>
</span><span class='line'>      <span class="nx">self</span><span class="p">.</span><span class="nx">hello</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>      <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nx">Test2</span>
</span><span class='line'>  <span class="nv">call: </span><span class="nf">(callback) -&gt;</span>
</span><span class='line'>    <span class="nx">callback</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>完全なコードはこちら</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="k">class</span> <span class="nx">Test</span>
</span><span class='line'>  <span class="nv">hello: </span><span class="nf">(num) -&gt;</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;hello &quot;</span> <span class="o">+</span> <span class="nx">num</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">call: </span><span class="nf">(test2) -&gt;</span>
</span><span class='line'>    <span class="vi">@test = </span><span class="s">&quot;test&quot;</span>
</span><span class='line'>    <span class="nx">@hello</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">self = </span><span class="k">this</span>
</span><span class='line'>    <span class="nx">test2</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nf">-&gt;</span>
</span><span class='line'>      <span class="c1"># ここで@hello(2) はエラー</span>
</span><span class='line'>      <span class="nx">self</span><span class="p">.</span><span class="nx">hello</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Test2オブジェクトでもないので、これもエラー</span>
</span><span class='line'>      <span class="c1"># @world()</span>
</span><span class='line'>      <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nx">Test2</span>
</span><span class='line'>  <span class="nv">call: </span><span class="nf">(callback) -&gt;</span>
</span><span class='line'>    <span class="nx">callback</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">world: </span><span class="nf">-&gt;</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;world&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">test = </span><span class="k">new</span> <span class="nx">Test</span>
</span><span class='line'><span class="nv">test2 = </span><span class="k">new</span> <span class="nx">Test2</span>
</span><span class='line'><span class="nx">test</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">test2</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[goでtime.Timeをmysqlから読む]]></title>
    <link href="http://ota42y.com/blog/2014/10/08/go-mysql-time/"/>
    <updated>2014-10-08T07:44:37+09:00</updated>
    <id>http://ota42y.com/blog/2014/10/08/go-mysql-time</id>
    <content type="html"><![CDATA[<p>goでtime.Time型をmysqlのDATETIME型として保存すると、以下のエラーが出て読み取りに失敗します…<br/>
<code>sql: Scan error on column index 3: unsupported driver -&gt; Scan pair: []uint8 -&gt; *time.Time</code></p>

<p>どうやらDSNに<code>parseTime=true</code>オプションをつける必要があるようです(何故かは不明)<br/>
<code>db, err := sql.Open("mysql", "username:passy@/database_name?parseTime=true")</code></p>

<p>参考リンク<br/>
<a href="https://github.com/go-sql-driver/mysql#timetime-support">https://github.com/go-sql-driver/mysql#timetime-support</a></p>
]]></content>
  </entry>
  
</feed>
